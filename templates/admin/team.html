{% extends 'admin/base.html' %}
{% block title %}ACMå®éªŒå®¤ - å›¢é˜Ÿç®¡ç†{% endblock %}
{% block page_title %}å›¢é˜Ÿç®¡ç†{% endblock %}
{% block extra_head %}
<script>
// API URLè¾…åŠ©å‡½æ•° - å…¼å®¹Verceléƒ¨ç½²
function getApiUrl(path) {
    // åœ¨Vercelç¯å¢ƒä¸‹ä½¿ç”¨å½“å‰åŸŸåï¼Œæœ¬åœ°å¼€å‘ä½¿ç”¨ç›¸å¯¹è·¯å¾„
    if (window.location.hostname.includes('vercel.app') || window.location.hostname.includes('vercel.com')) {
        return window.location.origin + path;
    }
    return path;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- Socket.IOå®¢æˆ·ç«¯åº“ - å®æ—¶æ•°æ®åŒæ­¥ -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script> -->
<style>
/* æ•´ä½“é¡µé¢ç¾åŒ– */
body {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #ffffff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.main-content {
    background: rgba(255, 255, 255, 0.05);
}

/* æ¶ˆæ¯æç¤ºç³»ç»Ÿ */
.message-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    max-width: 400px;
}

.message {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(450px);
    transition: transform 0.3s ease;
}

.message.show {
    transform: translateX(0);
}

.message.success { border-left-color: #22c55e; color: #166534; }
.message.error { border-left-color: #ef4444; color: #dc2626; }
.message.info { border-left-color: #3b82f6; color: #1d4ed8; }

.message-icon {
    font-size: 18px;
    font-weight: bold;
}

/* å¡ç‰‡ç¾åŒ– */
.card {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

/* è¡¨æ ¼ç¾åŒ– */
.data-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.data-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px;
    font-weight: 600;
    text-align: left;
    border: none;
}

.data-table td {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: background-color 0.3s ease;
}

.sortable-item {
    transition: all 0.3s ease;
    cursor: move;
}

.sortable-item:hover {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
    transform: scale(1.01);
}

.sortable-chosen {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important;
    transform: rotate(2deg) scale(1.05);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.sortable-ghost {
    opacity: 0.4;
    transform: scale(0.95);
}

/* æ‹–æ‹½æ‰‹æŸ„ç¾åŒ– */
.sort-handle {
    display: inline-block;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 6px;
    cursor: grab;
    position: relative;
    transition: all 0.3s ease;
    margin-right: 8px;
}

.sort-handle:before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 12px;
    height: 12px;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="19" cy="5" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/><circle cx="19" cy="19" r="2"/></svg>') no-repeat center;
    background-size: contain;
}

.sort-handle:hover {
    transform: scale(1.1) rotate(15deg);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.sort-handle:active {
    cursor: grabbing;
    transform: scale(0.95);
}

/* æŒ‰é’®ç¾åŒ– */
.btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    text-decoration: none;
    display: inline-block;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    color: white;
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.btn-success {
    background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    color: #1f2937;
}

.btn-success:hover {
    color: #1f2937;
    box-shadow: 0 8px 25px rgba(132, 250, 176, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
}

.btn-danger:hover {
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 8px;
}

/* è¡¨å•æ§ä»¶ç¾åŒ– */
input, select, textarea {
    background: rgba(26, 26, 46, 0.85);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 12px 16px;
    color: #ffffff;
    font-size: 14px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    background: rgba(102, 126, 234, 0.2);
}

input::placeholder, textarea::placeholder {
    color: rgba(255, 255, 255, 0.8);
}

/* ç¾åŒ–ä¸‹æ‹‰é€‰é¡¹ */
select option {
    background: #1a1a2e;
    color: #ffffff;
    padding: 8px;
}

/* æ¨¡æ€æ¡†æ ·å¼å·²ç»Ÿä¸€åˆ°base.htmlä¸­ */

/* çŠ¶æ€å¾½ç« ç¾åŒ– */
.status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-approved {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.status-pending {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.status-neutral {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

/* æœç´¢å’Œç­›é€‰åŒºåŸŸç¾åŒ– */
.table-actions {
    background: rgba(255, 255, 255, 0.05);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* è¡¨æ ¼å“åº”å¼ */
.table-responsive {
    border-radius: 15px;
    overflow: hidden;
}

/* åŠ¨ç”»å¢å¼º */
.card, .btn, .sortable-item {
    will-change: transform;
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2, #667eea);
}
</style>
{% endblock %}
{% block content %}
<!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
<div class="message-container" id="messageContainer"></div>

<!-- åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
<div id="syncStatus" style="position: fixed; top: 80px; right: 20px; z-index: 1000; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; display: none;">
    <span id="syncIcon">ğŸ”„</span>
    <span id="syncText">åŒæ­¥ä¸­...</span>
</div>

<!-- å›¢é˜Ÿæˆå‘˜ç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ‘¥ å›¢é˜Ÿæˆå‘˜ç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="searchInput" type="text" placeholder="æœç´¢å§“å/å¹´çº§/è§’è‰²..." style="padding:10px 14px;min-width:220px;">
            <select id="gradeFilter" style="padding:10px 14px;">
                <option value="">å…¨éƒ¨å¹´çº§</option>
                <option value="2024çº§">2024çº§</option>
                <option value="2023çº§">2023çº§</option>
                <option value="2022çº§">2022çº§</option>
                <option value="2021çº§">2021çº§</option>
                <option value="2020çº§">2020çº§</option>
                <option value="2019çº§">2019çº§</option>
                <option value="2018çº§">2018çº§</option>
                <option value="2017çº§">2017çº§</option>
                <option value="2016çº§">2016çº§</option>
            </select>
        </div>
        <div class="btn-group">
            <button id="addMemberBtn" class="btn btn-primary">â• æ–°å¢æˆå‘˜</button>
            <button id="saveOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
            <button id="testSyncBtn" class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2);">ğŸ”„ æµ‹è¯•åŒæ­¥</button>
        </div>
    </div>
    
    <!-- è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="debugInfo"></div>
    
    <div class="table-responsive">
        <table class="data-table" id="teamTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>å§“å</th>
                    <th>å¹´çº§</th>
                    <th>è§’è‰²/èŒä½</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="teamTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- å¹´çº§ç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ“š å¹´çº§ç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="gradeSearchInput" type="text" placeholder="æœç´¢å¹´çº§åç§°..." style="padding:10px 14px;min-width:220px;">
        </div>
        <div class="btn-group">
            <button id="addGradeBtn" class="btn btn-primary">ğŸ“š æ–°å¢å¹´çº§</button>
            <button id="saveGradeOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="data-table" id="gradeTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>å¹´çº§åç§°</th>
                    <th>æˆå‘˜æ•°é‡</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="gradeTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- ç ”ç©¶é¢†åŸŸç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ”¬ ç ”ç©¶é¢†åŸŸç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="researchSearchInput" type="text" placeholder="æœç´¢æ ‡é¢˜/æè¿°..." style="padding:10px 14px;min-width:220px;">
            <select id="categoryFilter" style="padding:10px 14px;">
                <option value="">å…¨éƒ¨ç±»åˆ«</option>
                <option value="æ·±åº¦å­¦ä¹ ">æ·±åº¦å­¦ä¹ </option>
                <option value="è¯æ®ç†è®º">è¯æ®ç†è®º</option>
                <option value="æ–‡çŒ®è®¡é‡">æ–‡çŒ®è®¡é‡</option>
            </select>
        </div>
        <div class="btn-group">
            <button id="addResearchBtn" class="btn btn-primary">ğŸ”¬ æ–°å¢ç ”ç©¶é¢†åŸŸ</button>
            <button id="saveResearchOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="researchTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>æ ‡é¢˜</th>
                    <th>ç±»åˆ«</th>
                    <th>æè¿°</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="researchTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘æˆå‘˜ -->
<div id="memberModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
            <div class="modal-content" style="min-width:340px;max-width:640px;width:92vw;padding:16px 16px 8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <h3 id="modalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢æˆå‘˜</h3>
                <button id="modalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="memberForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="memberId">
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å§“å <span style="color: #ef4444;">*</span></span>
                <input id="nameInput" required>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å¹´çº§ <span style="color: #ef4444;">*</span></span>
                <select id="gradeInput" required>
                    <option value="">è¯·é€‰æ‹©å¹´çº§</option>
                    <option value="2024çº§">2024çº§</option>
                    <option value="2023çº§">2023çº§</option>
                    <option value="2022çº§">2022çº§</option>
                    <option value="2021çº§">2021çº§</option>
                    <option value="2020çº§">2020çº§</option>
                    <option value="2019çº§">2019çº§</option>
                    <option value="2018çº§">2018çº§</option>
                    <option value="2017çº§">2017çº§</option>
                    <option value="2016çº§">2016çº§</option>
                </select>
            </label>

            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>è§’è‰²/èŒä½ <span style="color: #ef4444;">*</span></span>
                <input id="roleInput" placeholder="ä¾‹å¦‚ï¼šé«˜çº§ç ”ç©¶å‘˜ | è‡ªç„¶è¯­è¨€å¤„ç†" required>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>ä¸ªäººç®€ä»‹</span>
                <textarea id="descInput" rows="3" placeholder="ç®€ä»‹ï¼ˆå¯é€‰ï¼‰"></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>å¤´åƒå›¾ç‰‡URL</span>
                <input id="imgInput" placeholder="https://...ï¼ˆå¯é€‰ï¼‰">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>QQ</span>
                <input id="qqInput" placeholder="å¯é€‰">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å¾®ä¿¡</span>
                <input id="wechatInput" placeholder="å¯é€‰">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>é‚®ç®±</span>
                <input id="emailInput" type="email" placeholder="å¯é€‰">
            </label>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="cancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘ç ”ç©¶é¢†åŸŸ -->
<div id="researchModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal-content" style="min-width:340px;max-width:720px;width:92vw;padding:16px 16px 8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="researchModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢ç ”ç©¶é¢†åŸŸ</h3>
            <button id="researchModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="researchForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="researchId">
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æ ‡é¢˜</span>
                <input id="titleInputR" required placeholder="ä¾‹å¦‚ï¼šè‡ªç„¶è¯­è¨€å¤„ç†">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>ç±»åˆ«</span>
                <select id="categoryInputR" required>
                    <option value="æ·±åº¦å­¦ä¹ ">æ·±åº¦å­¦ä¹ </option>
                    <option value="è¯æ®ç†è®º">è¯æ®ç†è®º</option>
                    <option value="æ–‡çŒ®è®¡é‡">æ–‡çŒ®è®¡é‡</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æè¿°</span>
                <textarea id="descInputR" rows="3" placeholder="ç®€è¦æè¿°ç ”ç©¶æ–¹å‘" required></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æˆå‘˜æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼‰</span>
                <input id="membersInputR" placeholder="ä¾‹å¦‚ï¼šÎ±, Î², Î³">
            </label>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="researchCancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘å¹´çº§ -->
<div id="gradeModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal-content" style="min-width:340px;max-width:500px;width:92vw;padding:16px 16px 8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="gradeModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢å¹´çº§</h3>
            <button id="gradeModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="gradeForm" style="display:grid;grid-template-columns:1fr;gap:12px;">
            <input type="hidden" id="gradeId">
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å¹´çº§åç§° <span style="color: #ef4444;">*</span></span>
                <input id="gradeNameInput" required placeholder="ä¾‹å¦‚ï¼š2025çº§" pattern="^\d{4}çº§$" title="è¯·è¾“å…¥æ­£ç¡®çš„å¹´çº§æ ¼å¼ï¼Œå¦‚ï¼š2025çº§">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å¹´çº§æè¿°ï¼ˆå¯é€‰ï¼‰</span>
                <textarea id="gradeDescInput" rows="3" placeholder="å¹´çº§ç®€ä»‹æˆ–å¤‡æ³¨ä¿¡æ¯"></textarea>
            </label>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="cancelGradeBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<script>
// å…¨å±€æ¶ˆæ¯æç¤ºç³»ç»Ÿ
function showMessage(text, type = 'info') {
    const container = document.getElementById('messageContainer');
    const message = document.createElement('div');
    message.className = `message ${type}`;
    
    const iconMap = {
        success: 'âœ“',
        error: 'âœ•',
        info: 'â“˜'
    };
    
    message.innerHTML = `
        <span class="message-icon">${iconMap[type] || 'â“˜'}</span>
        <span>${text}</span>
    `;
    
    container.appendChild(message);
    
    // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => message.classList.add('show'), 100);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        message.classList.remove('show');
        setTimeout(() => {
            if (message.parentNode) {
                message.parentNode.removeChild(message);
            }
        }, 300);
    }, 3000);
}

// ============ å›¢é˜Ÿæˆå‘˜ç®¡ç† ============
(function(){
    const tbody = document.getElementById('teamTbody');
    const addBtn = document.getElementById('addMemberBtn');
    const modal = document.getElementById('memberModal');
    const modalClose = document.getElementById('modalClose');
    const cancelBtn = document.getElementById('cancelBtn');
    const form = document.getElementById('memberForm');
    const modalTitle = document.getElementById('modalTitle');
    const searchInput = document.getElementById('searchInput');
    const gradeFilter = document.getElementById('gradeFilter');

    const idInput = document.getElementById('memberId');
    const nameInput = document.getElementById('nameInput');
    const roleInput = document.getElementById('roleInput');
    const descInput = document.getElementById('descInput');
    const imgInput = document.getElementById('imgInput');
    const qqInput = document.getElementById('qqInput');
    const wechatInput = document.getElementById('wechatInput');
    const emailInput = document.getElementById('emailInput');
    const gradeInput = document.getElementById('gradeInput');

    let rawData = [];
    let sortableInstance = null;
    let hasUnsavedChanges = false;

    // åˆå§‹åŒ–æ‹–æ‹½æ’åº
    function initSortable() {
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        
        sortableInstance = new Sortable(tbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                hasUnsavedChanges = true;
                document.getElementById('saveOrderBtn').style.display = 'inline-block';
            }
        });
    }

    // ä¿å­˜æ’åº
    async function saveOrder() {
        const rows = tbody.querySelectorAll('tr[data-id]');
        const memberIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        console.log('ğŸ”„ å¼€å§‹ä¿å­˜å›¢é˜Ÿæˆå‘˜æ’åºï¼Œæˆå‘˜IDåˆ—è¡¨:', memberIds);
        
        if (memberIds.length === 0) {
            showMessage('æ²¡æœ‰å¯ä¿å­˜çš„æ’åºæ•°æ®', 'error');
            return;
        }
        
        try {
            const res = await fetch(getApiUrl('/api/team/reorder'), {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache'
                },
                body: JSON.stringify({ member_ids: memberIds })
            });
            
            if (res.ok) {
                const result = await res.json();
                console.log('âœ… æ’åºä¿å­˜æˆåŠŸ:', result);
                
                hasUnsavedChanges = false;
                document.getElementById('saveOrderBtn').style.display = 'none';
                showMessage('å›¢é˜Ÿæˆå‘˜æ’åºå·²ä¿å­˜', 'success');
                
                // é‡æ–°è·å–æ•°æ®ä»¥ç¡®ä¿æ’åºæ­£ç¡®
                await fetchData();
                
                // ç«‹å³é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°
                notifyFrontendUpdate('TEAM_MEMBERS_UPDATED', 'reordered');
                
                // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
                console.log('âœ… å›¢é˜Ÿæˆå‘˜æ’åºå·²åŒæ­¥åˆ°å‰ç«¯é¡µé¢');
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                console.error('âŒ æ’åºä¿å­˜å¤±è´¥:', err);
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error('âŒ æ’åºä¿å­˜ç½‘ç»œé”™è¯¯:', e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }

    function statusBadge(text){
        const map = { 'åœ¨èŒ': 'status-approved', 'è¯•ç”¨æœŸ': 'status-pending' };
        const cls = map[text] || 'status-neutral';
        return `<span class="status ${cls}">${text}</span>`;
    }

    function openModal(editData){
        modal.style.display = 'flex';
        if(editData){
            modalTitle.textContent = 'ç¼–è¾‘æˆå‘˜';
            idInput.value = editData.id;
            nameInput.value = editData.name || '';
            roleInput.value = editData.position || editData.role || '';
            descInput.value = editData.desc || editData.description || '';
            imgInput.value = editData.img || editData.image_url || '';
            qqInput.value = editData.qq || '';
            wechatInput.value = editData.wechat || '';
            emailInput.value = editData.email || '';
            
            // è®¾ç½®å¹´çº§é€‰æ‹©
            if (editData.grade) {
                gradeInput.value = editData.grade;
            } else {
                gradeInput.value = '2024çº§';
            }
            

        }else{
            modalTitle.textContent = 'æ–°å¢æˆå‘˜';
            form.reset();
            idInput.value = '';
        }
        
        // åŠ¨æ€åŠ è½½å¹´çº§é€‰é¡¹
        loadGradeOptions();
    }
    function closeModal(){ modal.style.display = 'none'; }

    // åŠ¨æ€åŠ è½½å¹´çº§é€‰é¡¹
    async function loadGradeOptions() {
        try {
            console.log('ğŸ”„ å¼€å§‹åŠ è½½å¹´çº§é€‰é¡¹...');
            
            // ä»å¹´çº§APIè·å–å¹´çº§åˆ—è¡¨
            const gradeRes = await fetch(getApiUrl('/api/grades'));
            if (gradeRes.ok) {
                const gradeData = await gradeRes.json();
                const gradeInput = document.getElementById('gradeInput');
                const gradeFilterEl = document.getElementById('gradeFilter');
                
                if (!gradeInput) {
                    console.warn('âš ï¸ å¹´çº§è¾“å…¥æ¡†ä¸å­˜åœ¨');
                    return;
                }
                
                console.log('âœ… å¹´çº§æ•°æ®åŠ è½½æˆåŠŸ:', gradeData);
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª"è¯·é€‰æ‹©å¹´çº§"é€‰é¡¹ï¼‰
                gradeInput.innerHTML = '<option value="">è¯·é€‰æ‹©å¹´çº§</option>';
                
                // æ·»åŠ å¹´çº§é€‰é¡¹ï¼ŒæŒ‰æ–°å¢é¡ºåºï¼ˆIDé™åºï¼‰æ’åˆ—ï¼Œè®©æ–°å¢çš„å¹´çº§åœ¨æœ€å‰é¢
                if (gradeData && gradeData.length > 0) {
                    const sortedGrades = gradeData
                        .sort((a, b) => {
                            // é¦–å…ˆæŒ‰IDé™åºæ’åˆ—ï¼Œè®©æ–°å¢çš„å¹´çº§åœ¨å‰é¢
                            if (a.id && b.id) {
                                return b.id - a.id;
                            }
                            // å¦‚æœæ²¡æœ‰IDï¼ŒæŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åˆ—
                            if (a.created_at && b.created_at) {
                                return new Date(b.created_at) - new Date(a.created_at);
                            }
                            // æœ€åæŒ‰å¹´çº§åç§°é™åºæ’åˆ—ï¼ˆæ•°å­—å¤§çš„å¹´çº§åœ¨å‰é¢ï¼‰
                            const yearA = parseInt((a.name || '').replace(/[^\d]/g, ''));
                            const yearB = parseInt((b.name || '').replace(/[^\d]/g, ''));
                            return yearB - yearA;
                        })
                        .map(g => g.name);
                    
                    sortedGrades.forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade;
                        option.textContent = grade;
                        gradeInput.appendChild(option);
                    });
                    
                    // åŒæ—¶æ›´æ–°å¹´çº§è¿‡æ»¤å™¨
                    if (gradeFilterEl) {
                        gradeFilterEl.innerHTML = '<option value="">å…¨éƒ¨å¹´çº§</option>';
                        sortedGrades.forEach(grade => {
                            const option = document.createElement('option');
                            option.value = grade;
                            option.textContent = grade;
                            gradeFilterEl.appendChild(option);
                        });
                    }
                    
                    console.log('âœ… å¹´çº§é€‰é¡¹æ›´æ–°æˆåŠŸï¼Œå…±', sortedGrades.length, 'ä¸ªå¹´çº§');
                } else {
                    console.warn('âš ï¸ æ²¡æœ‰å¹´çº§æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å¹´çº§é€‰é¡¹');
                    // ä½¿ç”¨é»˜è®¤å¹´çº§é€‰é¡¹
                    const defaultGrades = ['2024çº§', '2023çº§', '2022çº§', '2021çº§', '2020çº§', '2019çº§', '2018çº§', '2017çº§', '2016çº§'];
                    defaultGrades.forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade;
                        option.textContent = grade;
                        gradeInput.appendChild(option);
                    });
                    
                    // åŒæ—¶æ›´æ–°å¹´çº§è¿‡æ»¤å™¨
                    if (gradeFilterEl) {
                        gradeFilterEl.innerHTML = '<option value="">å…¨éƒ¨å¹´çº§</option>';
                        defaultGrades.forEach(grade => {
                            const option = document.createElement('option');
                            option.value = grade;
                            option.textContent = grade;
                            gradeFilterEl.appendChild(option);
                        });
                    }
                }
            } else {
                throw new Error(`HTTP ${gradeRes.status}: ${gradeRes.statusText}`);
            }
        } catch (error) {
            console.error('âŒ åŠ è½½å¹´çº§é€‰é¡¹å¤±è´¥:', error);
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¹´çº§é€‰é¡¹
            const gradeInput = document.getElementById('gradeInput');
            const gradeFilterEl = document.getElementById('gradeFilter');
            if (gradeInput) {
                gradeInput.innerHTML = `
                    <option value="">è¯·é€‰æ‹©å¹´çº§</option>
                    <option value="2024çº§">2024çº§</option>
                    <option value="2023çº§">2023çº§</option>
                    <option value="2022çº§">2022çº§</option>
                    <option value="2021çº§">2021çº§</option>
                    <option value="2020çº§">2020çº§</option>
                    <option value="2019çº§">2019çº§</option>
                    <option value="2018çº§">2018çº§</option>
                    <option value="2017çº§">2017çº§</option>
                    <option value="2016çº§">2016çº§</option>
                `;
            }
            
            // åŒæ—¶æ›´æ–°å¹´çº§è¿‡æ»¤å™¨
            if (gradeFilterEl) {
                gradeFilterEl.innerHTML = `
                    <option value="">å…¨éƒ¨å¹´çº§</option>
                    <option value="2024çº§">2024çº§</option>
                    <option value="2023çº§">2023çº§</option>
                    <option value="2022çº§">2022çº§</option>
                    <option value="2021çº§">2021çº§</option>
                    <option value="2020çº§">2020çº§</option>
                    <option value="2019çº§">2019çº§</option>
                    <option value="2018çº§">2018çº§</option>
                    <option value="2017çº§">2017çº§</option>
                    <option value="2016çº§">2016çº§</option>
                `;
            }
        }
    }

    function render(data){
        tbody.innerHTML = data.map(m => `
            <tr class="sortable-item" data-id="${m.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>${m.name || ''}</td>
                <td>${m.grade || '2024çº§'}</td>
                <td>${m.position || m.role || ''}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${m.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${m.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.7);">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        <p>æš‚æ— å›¢é˜Ÿæˆå‘˜æ•°æ®</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">ç‚¹å‡»"æ–°å¢æˆå‘˜"æŒ‰é’®æ·»åŠ å›¢é˜Ÿæˆå‘˜</p>
                    </td>
                </tr>
            `;
        }
        
        initSortable();
    }

    async function fetchData(){
        try {
            console.log('ğŸ”„ å¼€å§‹åŠ è½½å›¢é˜Ÿæˆå‘˜æ•°æ®...');
            const res = await fetch(getApiUrl('/api/team'), {
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            const gradeData = await res.json();
            
            // å°†å¹´çº§åˆ†ç»„æ•°æ®è½¬æ¢ä¸ºæ‰å¹³åŒ–çš„æˆå‘˜åˆ—è¡¨
            rawData = [];
            if (Array.isArray(gradeData)) {
                gradeData.forEach(grade => {
                    if (grade.members && Array.isArray(grade.members)) {
                        grade.members.forEach(member => {
                            // ç¡®ä¿æ¯ä¸ªæˆå‘˜éƒ½æœ‰å¹´çº§ä¿¡æ¯å’Œæ­£ç¡®çš„æ’åºç´¢å¼•
                            rawData.push({
                                ...member,
                                grade: grade.grade || '2024çº§',
                                order_index: member.order_index || 0
                            });
                        });
                    }
                });
            }
            
            // æŒ‰order_indexæ’åºï¼Œç¡®ä¿ä¸ç®¡ç†é¡µé¢æ˜¾ç¤ºé¡ºåºä¸€è‡´
            rawData.sort((a, b) => {
                const orderA = a.order_index || 0;
                const orderB = b.order_index || 0;
                return orderA - orderB;
            });
            
            console.log('âœ… å›¢é˜Ÿæˆå‘˜æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', rawData.length, 'ä½æˆå‘˜ï¼Œå·²æŒ‰æ’åºç´¢å¼•æ’åº');
            applyFilter();
        } catch (error) {
            console.error('âŒ åŠ è½½å›¢é˜Ÿæˆå‘˜æ•°æ®å¤±è´¥:', error);
            showMessage('åŠ è½½å›¢é˜Ÿæˆå‘˜æ•°æ®å¤±è´¥', 'error');
            rawData = [];
            applyFilter();
        }
    }

    function applyFilter(){
        const kw = (searchInput.value || '').trim();
        const gr = (gradeFilter.value || '').trim();
        
        const filtered = rawData.filter(m => {
            const hitKw = !kw || [m.name, m.grade, m.position || m.role].some(v => (v||'').toLowerCase().includes(kw.toLowerCase()));
            const hitGr = !gr || (m.grade || '2024çº§') === gr;
            return hitKw && hitGr;
        });
        render(filtered);
    }

    tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        const current = rawData.find(x => x.id === id);
        
        if(action === 'edit'){
            openModal(current);
        }
        
        if(action === 'delete'){
            if(!confirm('ç¡®è®¤åˆ é™¤è¯¥æˆå‘˜ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            try {
                const res = await fetch(getApiUrl(`/api/team/${id}`), { 
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                            if(res.ok){ 
                await fetchData();
                showMessage('æˆå‘˜åˆ é™¤æˆåŠŸ', 'success');
                
                // ç«‹å³é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°
                notifyFrontendUpdate('TEAM_MEMBERS_UPDATED', 'deleted');
                
                // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
                console.log('âœ… å›¢é˜Ÿæˆå‘˜åˆ é™¤å·²åŒæ­¥åˆ°å‰ç«¯é¡µé¢');
            } else {
                const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
            } catch (e) {
                console.error(e);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }
    });

    addBtn.addEventListener('click', () => openModal());
    modalClose.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!nameInput.value.trim()) {
            showMessage('è¯·å¡«å†™æˆå‘˜å§“å', 'error');
            nameInput.focus();
            return;
        }
        
        if (!roleInput.value.trim()) {
            showMessage('è¯·å¡«å†™æˆå‘˜è§’è‰²/èŒä½', 'error');
            roleInput.focus();
            return;
        }
        
        const payload = {
            name: nameInput.value.trim(),
            position: roleInput.value.trim(),
            role: roleInput.value.trim(),
            description: descInput.value.trim(),
            desc: descInput.value.trim(),
            image_url: imgInput.value.trim(),
            img: imgInput.value.trim(),
            qq: qqInput.value.trim(),
            wechat: wechatInput.value.trim(),
            email: emailInput.value.trim(),
            grade: gradeInput.value
        };
        
        const id = idInput.value;
        const isEdit = !!id;
        
        try {
            console.log(`ğŸ”„ ${isEdit ? 'æ›´æ–°' : 'åˆ›å»º'}å›¢é˜Ÿæˆå‘˜:`, payload);
            
            const res = await fetch(getApiUrl(isEdit ? `/api/team/${id}` : '/api/team'), {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if(res.ok){
                const result = await res.json();
                console.log('âœ… å›¢é˜Ÿæˆå‘˜æ“ä½œæˆåŠŸ:', result);
                
                closeModal();
                await fetchData();
                showMessage(isEdit ? 'æˆå‘˜ä¿¡æ¯æ›´æ–°æˆåŠŸ' : 'æˆå‘˜æ·»åŠ æˆåŠŸ', 'success');
                
                // ç«‹å³é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–° - ä¼˜åŒ–ç‰ˆæœ¬
                const operation = isEdit ? 'updated' : 'created';
                notifyFrontendUpdate('TEAM_MEMBERS_UPDATED', operation);
                
                // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
                console.log('âœ… å›¢é˜Ÿæˆå‘˜æ•°æ®å·²åŒæ­¥åˆ°å‰ç«¯é¡µé¢');
                
                // é‡æ–°åŠ è½½å¹´çº§é€‰é¡¹ï¼Œç¡®ä¿å¹´çº§è¿‡æ»¤å™¨åŒæ­¥
                await loadGradeOptions();
            }else{
                const err = await res.json().catch(()=>({error:'æäº¤å¤±è´¥'}));
                console.error('âŒ å›¢é˜Ÿæˆå‘˜æ“ä½œå¤±è´¥:', err);
                showMessage(err.error || 'æäº¤å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('âŒ å›¢é˜Ÿæˆå‘˜æ“ä½œç½‘ç»œé”™è¯¯:', error);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œæäº¤å¤±è´¥', 'error');
        }
    });

    searchInput.addEventListener('input', applyFilter);
    if (gradeFilter) gradeFilter.addEventListener('change', applyFilter);
    document.getElementById('saveOrderBtn').addEventListener('click', saveOrder);
    
    // æµ‹è¯•åŒæ­¥åŠŸèƒ½
    document.getElementById('testSyncBtn').addEventListener('click', async function() {
        showMessage('æ­£åœ¨æµ‹è¯•ä¸å‰ç«¯é¡µé¢çš„åŒæ­¥...', 'info');
        updateSyncStatus('show', 'ğŸ”„', 'æµ‹è¯•åŒæ­¥ä¸­...');
        
        try {
            // æµ‹è¯•1: æ£€æŸ¥Socket.IOè¿æ¥çŠ¶æ€
            console.log('ğŸ§ª æµ‹è¯•1: æ£€æŸ¥Socket.IOè¿æ¥çŠ¶æ€');
            // if (typeof socket !== 'undefined' && socket && socket.connected) {  // Vercel ä¸æ”¯æŒ WebSocket
            //     console.log('âœ… Socket.IOè¿æ¥æ­£å¸¸ï¼Œè¿æ¥ID:', socket.id);
            // } else {
            //     console.warn('âš ï¸ Socket.IOæœªè¿æ¥ï¼Œå°è¯•é‡æ–°è¿æ¥');
            //     if (typeof initAdminSocketIO === 'function') {
            //         initAdminSocketIO();
            //     }
            // }
            console.log('âš ï¸ Socket.IOåŠŸèƒ½å·²ç¦ç”¨ï¼ˆVercel ä¸æ”¯æŒ WebSocketï¼‰');
            
            // æµ‹è¯•2: æµ‹è¯•ç®¡ç†é¡µé¢çš„é€šçŸ¥æœºåˆ¶
            console.log('ğŸ§ª æµ‹è¯•2: ç®¡ç†é¡µé¢é€šçŸ¥æœºåˆ¶');
            notifyFrontendUpdate('TEAM_MEMBERS_UPDATED', 'test-sync');
            
            // æµ‹è¯•3: æµ‹è¯•åç«¯APIçš„å®æ—¶é€šçŸ¥
            console.log('ğŸ§ª æµ‹è¯•3: åç«¯APIå®æ—¶é€šçŸ¥');
            const testRes = await fetch(getApiUrl('/api/team'));
            if (testRes.ok) {
                const teamData = await testRes.json();
                console.log('âœ… åç«¯APIè¿æ¥æ­£å¸¸ï¼Œå›¢é˜Ÿæˆå‘˜æ•°æ®:', teamData.length, 'ä¸ªå¹´çº§');
                
                // æ¨¡æ‹Ÿä¸€ä¸ªåç«¯é€šçŸ¥ï¼ˆé€šè¿‡Socket.IOï¼‰
                // if (typeof socket !== 'undefined' && socket && socket.connected) {  // Vercel ä¸æ”¯æŒ WebSocket
                //     socket.emit('page_refresh', {
                //         page: 'team',
                //         type: 'data_updated',
                //         payload: {
                //             test_notification: true,
                //             message: 'åç«¯APIå®æ—¶é€šçŸ¥æµ‹è¯•'
                //         }
                //     });
                //     console.log('âœ… åç«¯API Socket.IOé€šçŸ¥å·²å‘é€');
                // } else {
                //     console.warn('âš ï¸ Socket.IOæœªè¿æ¥ï¼Œæ— æ³•å‘é€å®æ—¶é€šçŸ¥');
                // }
                console.log('âš ï¸ Socket.IOé€šçŸ¥åŠŸèƒ½å·²ç¦ç”¨ï¼ˆVercel ä¸æ”¯æŒ WebSocketï¼‰');
            }
            
            // æµ‹è¯•4: æµ‹è¯•åç«¯APIç›´æ¥é€šçŸ¥
            console.log('ğŸ§ª æµ‹è¯•4: åç«¯APIç›´æ¥é€šçŸ¥');
            try {
                const notifyRes = await fetch(getApiUrl('/api/test-notification'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page: 'team',
                        payload: {
                            test_notification: true,
                            message: 'åç«¯APIç›´æ¥é€šçŸ¥æµ‹è¯•'
                        }
                    })
                });
                if (notifyRes.ok) {
                    console.log('âœ… åç«¯APIç›´æ¥é€šçŸ¥æµ‹è¯•æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ åç«¯APIç›´æ¥é€šçŸ¥æµ‹è¯•å¤±è´¥');
                }
            } catch (error) {
                console.warn('âš ï¸ åç«¯APIç›´æ¥é€šçŸ¥æµ‹è¯•å¤±è´¥:', error);
            }
            
            // æµ‹è¯•5: æµ‹è¯•å‰ç«¯é¡µé¢æ¥æ”¶é€šçŸ¥
            console.log('ğŸ§ª æµ‹è¯•5: å‰ç«¯é¡µé¢æ¥æ”¶é€šçŸ¥');
            setTimeout(() => {
                showMessage('âœ… åŒæ­¥æµ‹è¯•å®Œæˆï¼è¯·æ£€æŸ¥å‰ç«¯é¡µé¢æ˜¯å¦æ”¶åˆ°æ›´æ–°é€šçŸ¥', 'success');
                updateSyncStatus('show', 'âœ…', 'æµ‹è¯•å®Œæˆ');
                setTimeout(() => {
                    updateSyncStatus('hide');
                }, 3000);
            }, 2000);
            
        } catch (error) {
            console.error('âŒ åŒæ­¥æµ‹è¯•å¤±è´¥:', error);
            showMessage('åŒæ­¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            updateSyncStatus('error', 'âŒ', 'æµ‹è¯•å¤±è´¥');
        }
    });

    fetchData();
})();

// ============ å¹´çº§ç®¡ç† ============
(function(){
    const gradeTbody = document.getElementById('gradeTbody');
    const addGradeBtn = document.getElementById('addGradeBtn');
    const gradeModal = document.getElementById('gradeModal');
    const gradeModalClose = document.getElementById('gradeModalClose');
    const cancelGradeBtn = document.getElementById('cancelGradeBtn');
    const gradeForm = document.getElementById('gradeForm');
    const gradeModalTitle = document.getElementById('gradeModalTitle');
    const gradeSearchInput = document.getElementById('gradeSearchInput');

    const gradeIdInput = document.getElementById('gradeId');
    const gradeNameInput = document.getElementById('gradeNameInput');
    const gradeDescInput = document.getElementById('gradeDescInput');

    let gradeRawData = [];
    let gradeSortableInstance = null;
    let gradeHasUnsavedChanges = false;

    function initSortable() {
        if (gradeSortableInstance) {
            gradeSortableInstance.destroy();
        }
        
        gradeSortableInstance = new Sortable(gradeTbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                gradeHasUnsavedChanges = true;
                document.getElementById('saveGradeOrderBtn').style.display = 'inline-block';
            }
        });
    }

    async function saveOrder() {
        const rows = gradeTbody.querySelectorAll('tr[data-id]');
        const gradeIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        try {
            const res = await fetch(getApiUrl('/api/grades/reorder'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ grade_ids: gradeIds })
            });
            
            if (res.ok) {
                gradeHasUnsavedChanges = false;
                document.getElementById('saveGradeOrderBtn').style.display = 'none';
                showMessage('å¹´çº§æ’åºå·²ä¿å­˜', 'success');
                await fetchData();
                
                // ç«‹å³é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°
                notifyFrontendUpdate('GRADE_DATA_UPDATED', 'reordered');
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }

    function openModal(editData){
        gradeModal.style.display = 'flex';
        if(editData){
            gradeModalTitle.textContent = 'ç¼–è¾‘å¹´çº§';
            gradeIdInput.value = editData.id;
            gradeNameInput.value = editData.name || '';
            gradeDescInput.value = editData.description || editData.desc || '';
        }else{
            gradeModalTitle.textContent = 'æ–°å¢å¹´çº§';
            gradeForm.reset();
            gradeIdInput.value = '';
        }
    }
    
    function closeModal(){ 
        gradeModal.style.display = 'none'; 
    }

    function render(data){
        gradeTbody.innerHTML = data.map(item => `
            <tr class="sortable-item" data-id="${item.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>${item.name || ''}</td>
                <td>${item.member_count || 0}</td>
                <td>${item.created_at ? new Date(item.created_at).toLocaleDateString() : 'æœªçŸ¥'}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${item.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${item.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        if (data.length === 0) {
            gradeTbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.7);">
                        <i class="fas fa-graduation-cap" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        <p>æš‚æ— å¹´çº§æ•°æ®</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">ç‚¹å‡»"æ–°å¢å¹´çº§"æŒ‰é’®æ·»åŠ å¹´çº§</p>
                    </td>
                </tr>
            `;
        }
        
        initSortable();
    }

    async function fetchData(){
        try {
            console.log('ğŸ”„ å¼€å§‹åŠ è½½å¹´çº§æ•°æ®...');
            
            // ä½¿ç”¨æ–°çš„å¹´çº§API
            const gradeRes = await fetch(getApiUrl('/api/grades'));
            if (gradeRes.ok) {
                const gradeData = await gradeRes.json();
                // å¯¹å¹´çº§æ•°æ®è¿›è¡Œæ’åºï¼šæ–°å¢çš„å¹´çº§ï¼ˆIDæ›´å¤§ï¼‰æ”¾åœ¨æœ€ä¸Šé¢
                gradeRawData = gradeData.sort((a, b) => {
                    // é¦–å…ˆæŒ‰IDé™åºæ’åˆ—ï¼Œè®©æ–°å¢çš„å¹´çº§åœ¨å‰é¢
                    if (a.id && b.id) {
                        return b.id - a.id;
                    }
                    // å¦‚æœæ²¡æœ‰IDï¼ŒæŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åˆ—
                    if (a.created_at && b.created_at) {
                        return new Date(b.created_at) - new Date(a.created_at);
                    }
                    // æœ€åæŒ‰å¹´çº§åç§°é™åºæ’åˆ—ï¼ˆæ•°å­—å¤§çš„å¹´çº§åœ¨å‰é¢ï¼‰
                    const yearA = parseInt((a.name || '').replace(/[^\d]/g, ''));
                    const yearB = parseInt((b.name || '').replace(/[^\d]/g, ''));
                    return yearB - yearA;
                });
                console.log('âœ… å¹´çº§æ•°æ®åŠ è½½æˆåŠŸï¼Œå·²æŒ‰æ–°å¢é¡ºåºæ’åº:', gradeRawData);
                applyFilter();
            } else {
                throw new Error(`HTTP ${gradeRes.status}: ${gradeRes.statusText}`);
            }
        } catch (error) {
            console.error('âŒ åŠ è½½å¹´çº§æ•°æ®å¤±è´¥:', error);
            showMessage('åŠ è½½å¹´çº§æ•°æ®å¤±è´¥', 'error');
            gradeRawData = [];
            applyFilter();
        }
    }

    function applyFilter(){
        const kw = (gradeSearchInput.value || '').trim();
        const filtered = gradeRawData.filter(grade => {
            const hitKw = !kw || (grade.name || '').includes(kw);
            return hitKw;
        });
        render(filtered);
    }

    gradeTbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        const current = gradeRawData.find(x => x.id === id);
        
        if(action === 'edit'){
            openModal(current);
        }
        
        if(action === 'delete'){
            if(!confirm('ç¡®è®¤åˆ é™¤è¯¥å¹´çº§ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            try {
                const res = await fetch(getApiUrl(`/api/grades/${id}`), { 
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if(res.ok){ 
                    await fetchData();
                    showMessage('å¹´çº§åˆ é™¤æˆåŠŸ', 'success');
                    
                    // ç«‹å³é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°
                    notifyFrontendUpdate('GRADE_DATA_UPDATED', 'deleted');
                } else {
                    const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                    showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                console.error(e);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }
    });

    addGradeBtn.addEventListener('click', () => openModal());
    gradeModalClose.addEventListener('click', closeModal);
    cancelGradeBtn.addEventListener('click', closeModal);
    gradeModal.addEventListener('click', (e) => { if(e.target === gradeModal) closeModal(); });

    gradeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!gradeNameInput.value.trim()) {
            showMessage('è¯·å¡«å†™å¹´çº§åç§°', 'error');
            gradeNameInput.focus();
            return;
        }
        
        // éªŒè¯å¹´çº§æ ¼å¼
        const gradeName = gradeNameInput.value.trim();
        if (!/^\d{4}çº§$/.test(gradeName)) {
            showMessage('å¹´çº§æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºYYYYçº§æ ¼å¼ï¼ˆå¦‚ï¼š2025çº§ï¼‰', 'error');
            gradeNameInput.focus();
            return;
        }
        
        const payload = {
            name: gradeName,
            description: gradeDescInput.value.trim()
        };
        
        const id = gradeIdInput.value;
        const isEdit = !!id;
        
        try {
            console.log(`ğŸ”„ ${isEdit ? 'æ›´æ–°' : 'åˆ›å»º'}å¹´çº§:`, payload);
            
            const res = await fetch(getApiUrl(isEdit ? `/api/grades/${id}` : '/api/grades'), {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                const result = await res.json();
                console.log('âœ… å¹´çº§æ“ä½œæˆåŠŸ:', result);
                
                closeModal();
                await fetchData();
                showMessage(isEdit ? 'å¹´çº§æ›´æ–°æˆåŠŸ' : 'å¹´çº§æ·»åŠ æˆåŠŸ', 'success');
                
                // ç«‹å³é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°
                const operation = isEdit ? 'updated' : 'created';
                notifyFrontendUpdate('GRADE_DATA_UPDATED', operation);
                
                // é‡æ–°åŠ è½½å¹´çº§é€‰é¡¹
                await loadGradeOptions();
            } else {
                const errorData = await res.json().catch(() => ({error: 'æ“ä½œå¤±è´¥'}));
                console.error('âŒ å¹´çº§æ“ä½œå¤±è´¥:', errorData);
                showMessage(errorData.error || 'æ“ä½œå¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('âŒ å¹´çº§æ“ä½œç½‘ç»œé”™è¯¯:', error);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œæ“ä½œå¤±è´¥', 'error');
        }
    });

    gradeSearchInput.addEventListener('input', applyFilter);
    document.getElementById('saveGradeOrderBtn').addEventListener('click', saveOrder);

    fetchData();
})();

// ============ ç ”ç©¶é¢†åŸŸç®¡ç† ============
(function(){
    const researchTbody = document.getElementById('researchTbody');
    const addResearchBtn = document.getElementById('addResearchBtn');
    const researchModal = document.getElementById('researchModal');
    const researchModalClose = document.getElementById('researchModalClose');
    const researchCancelBtn = document.getElementById('researchCancelBtn');
    const researchForm = document.getElementById('researchForm');
    const researchModalTitle = document.getElementById('researchModalTitle');
    const researchSearchInput = document.getElementById('researchSearchInput');
    const categoryFilter = document.getElementById('categoryFilter');

    const researchIdInput = document.getElementById('researchId');
    const titleInput = document.getElementById('titleInputR');
    const categoryInput = document.getElementById('categoryInputR');
    const researchDescInput = document.getElementById('descInputR');
    const membersInput = document.getElementById('membersInputR');

    let researchRawData = [];
    let researchSortableInstance = null;
    let researchHasUnsavedChanges = false;

    function initSortable() {
        if (researchSortableInstance) {
            researchSortableInstance.destroy();
        }
        
        researchSortableInstance = new Sortable(researchTbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                researchHasUnsavedChanges = true;
                document.getElementById('saveResearchOrderBtn').style.display = 'inline-block';
            }
        });
    }

    async function saveOrder() {
        const rows = researchTbody.querySelectorAll('tr[data-id]');
        const researchIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        try {
            const res = await fetch(getApiUrl('/api/research-areas/reorder'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ area_ids: researchIds })
            });
            
            if (res.ok) {
                researchHasUnsavedChanges = false;
                document.getElementById('saveResearchOrderBtn').style.display = 'none';
                showMessage('ç ”ç©¶é¢†åŸŸæ’åºå·²ä¿å­˜', 'success');
                await fetchData();
                
                // ç«‹å³é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°
                notifyFrontendUpdate('RESEARCH_DATA_UPDATED', 'reordered');
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }

    function openModal(editData){
        researchModal.style.display = 'flex';
        if(editData){
            researchModalTitle.textContent = 'ç¼–è¾‘ç ”ç©¶é¢†åŸŸ';
            researchIdInput.value = editData.id;
            titleInput.value = editData.title || '';
            categoryInput.value = editData.category || 'æ·±åº¦å­¦ä¹ ';
            researchDescInput.value = editData.desc || editData.description || '';
            membersInput.value = Array.isArray(editData.members) ? editData.members.join(', ') : (editData.members || '');
        }else{
            researchModalTitle.textContent = 'æ–°å¢ç ”ç©¶é¢†åŸŸ';
            researchForm.reset();
            researchIdInput.value = '';
        }
    }
    function closeModal(){ researchModal.style.display = 'none'; }

    function truncate(text, n){
        const s = (text||'').trim();
        return s.length > n ? (s.slice(0, n) + '...') : s;
    }

    function render(data){
        researchTbody.innerHTML = data.map(item => `
            <tr class="sortable-item" data-id="${item.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>${item.title || ''}</td>
                <td>${item.category || ''}</td>
                <td title="${(item.desc||'').replace(/\"/g,'&quot;')}">${truncate(item.desc, 40)}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${item.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${item.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        initSortable();
    }

    async function fetchData(){
        try {
            console.log('ğŸ”„ å¼€å§‹åŠ è½½ç ”ç©¶é¢†åŸŸæ•°æ®...');
            // ç®¡ç†åå°éœ€è¦è·å–æ‰€æœ‰æ•°æ®ï¼Œè®¾ç½®è¾ƒå¤§çš„per_pageå€¼
            const res = await fetch(getApiUrl('/api/research-areas?per_page=100'));
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            const responseData = await res.json();
            
            // å¤„ç†åˆ†é¡µæ ¼å¼çš„å“åº”æ•°æ®
            if (responseData.data && Array.isArray(responseData.data)) {
                researchRawData = responseData.data;
            } else if (Array.isArray(responseData)) {
                // å…¼å®¹æ—§æ ¼å¼
                researchRawData = responseData;
            } else {
                researchRawData = [];
            }
            
            console.log('âœ… ç ”ç©¶é¢†åŸŸæ•°æ®åŠ è½½æˆåŠŸ:', researchRawData);
            applyFilter();
        } catch (error) {
            console.error('âŒ åŠ è½½ç ”ç©¶é¢†åŸŸæ•°æ®å¤±è´¥:', error);
            showMessage('åŠ è½½ç ”ç©¶é¢†åŸŸæ•°æ®å¤±è´¥', 'error');
            researchRawData = [];
            applyFilter();
        }
    }

    function applyFilter(){
        const kw = (researchSearchInput.value || '').trim();
        const c = categoryFilter.value || '';
        const filtered = researchRawData.filter(r => {
            const hitKw = !kw || [r.title, r.desc].some(v => (v||'').includes(kw));
            const hitC = !c || r.category === c;
            return hitKw && hitC;
        });
        render(filtered);
    }

    researchTbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        const current = researchRawData.find(x => x.id === id);
        if(action === 'edit'){
            openModal(current);
        }
        if(action === 'delete'){
            if(!confirm('ç¡®è®¤åˆ é™¤è¯¥ç ”ç©¶é¢†åŸŸï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const res = await fetch(getApiUrl(`/api/research-areas/${id}`), { method: 'DELETE' });
                if(res.ok){ 
                    await fetchData(); 
                    showMessage('ç ”ç©¶é¢†åŸŸåˆ é™¤æˆåŠŸ', 'success');
                    
                    // ç«‹å³é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°
                    notifyFrontendUpdate('RESEARCH_DATA_UPDATED', 'deleted');
                } else {
                    const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                    showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                console.error(e);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }
    });

    addResearchBtn.addEventListener('click', () => openModal());
    researchModalClose.addEventListener('click', closeModal);
    researchCancelBtn.addEventListener('click', closeModal);
    researchModal.addEventListener('click', (e) => { if(e.target === researchModal) closeModal(); });

    researchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!titleInput.value.trim()) {
            showMessage('è¯·å¡«å†™ç ”ç©¶é¢†åŸŸæ ‡é¢˜', 'error');
            titleInput.focus();
            return;
        }
        
        if (!researchDescInput.value.trim()) {
            showMessage('è¯·å¡«å†™ç ”ç©¶é¢†åŸŸæè¿°', 'error');
            researchDescInput.focus();
            return;
        }
        
        const membersRaw = (membersInput.value || '').trim();
        const members = membersRaw ? membersRaw.split(/[,ï¼Œã€]/).map(s => s.trim()).filter(Boolean) : [];
        const payload = {
            title: titleInput.value.trim(),
            category: categoryInput.value,
            description: researchDescInput.value.trim(),
            desc: researchDescInput.value.trim(),
            members: members
        };
        const id = researchIdInput.value;
        const isEdit = !!id;
        
        try {
            const res = await fetch(getApiUrl(isEdit ? `/api/research-areas/${id}` : '/api/research-areas'), {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if(res.ok){
                closeModal();
                await fetchData();
                showMessage(isEdit ? 'ç ”ç©¶é¢†åŸŸæ›´æ–°æˆåŠŸ' : 'ç ”ç©¶é¢†åŸŸæ·»åŠ æˆåŠŸ', 'success');
                
                // ç«‹å³é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°
                const operation = isEdit ? 'updated' : 'created';
                notifyFrontendUpdate('RESEARCH_DATA_UPDATED', operation);
            }else{
                const err = await res.json().catch(()=>({error:'æäº¤å¤±è´¥'}));
                showMessage(err.error || 'æäº¤å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œæäº¤å¤±è´¥', 'error');
        }
    });

    researchSearchInput.addEventListener('input', applyFilter);
    categoryFilter.addEventListener('change', applyFilter);
    document.getElementById('saveResearchOrderBtn').addEventListener('click', saveOrder);

    fetchData();
})();

// åŒæ­¥çŠ¶æ€ç®¡ç†
function updateSyncStatus(status, icon = 'ğŸ”„', text = 'åŒæ­¥ä¸­...') {
    const syncStatus = document.getElementById('syncStatus');
    const syncIcon = document.getElementById('syncIcon');
    const syncText = document.getElementById('syncText');
    
    if (syncStatus && syncIcon && syncText) {
        if (status === 'show') {
            syncStatus.style.display = 'block';
            syncIcon.textContent = icon;
            syncText.textContent = text;
        } else if (status === 'hide') {
            syncStatus.style.display = 'none';
        } else {
            syncIcon.textContent = icon;
            syncText.textContent = text;
        }
    }
}

    // é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°çš„å‡½æ•° - ä¼˜åŒ–ç‰ˆæœ¬
    function notifyFrontendUpdate(type, operation) {
        console.log(`ğŸ“¢ é€šçŸ¥å‰ç«¯æ›´æ–°: ${type}, æ“ä½œ: ${operation}`);
        
        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
        updateSyncStatus('show', 'ğŸ”„', 'æ­£åœ¨åŒæ­¥åˆ°å‰ç«¯é¡µé¢...');
        
        // é€šè¿‡postMessageé€šçŸ¥å‰ç«¯é¡µé¢
        try {
            window.postMessage({
                type: type,
                operation: operation,
                timestamp: Date.now()
            }, '*');
            console.log('âœ… postMessageé€šçŸ¥å·²å‘é€');
        } catch (error) {
            console.error('âŒ postMessageé€šçŸ¥å¤±è´¥:', error);
        }
        
        // é€šè¿‡Socket.IOé€šçŸ¥å‰ç«¯é¡µé¢ - ä¼˜åŒ–ç‰ˆæœ¬
        // if (typeof socket !== 'undefined' && socket && socket.connected) {  // Vercel ä¸æ”¯æŒ WebSocket
        //     try {
        //         // å‘é€åˆ°ç‰¹å®šé¡µé¢
        //         socket.emit('page_refresh', {
        //             page: 'home',
        //             operation: operation,
        //             type: type,
        //             timestamp: Date.now()
        //         });
        //         
        //         // åŒæ—¶å‘é€åˆ°å›¢é˜Ÿé¡µé¢
        //         socket.emit('page_refresh', {
        //             page: 'team',
        //             operation: operation,
        //             type: type,
        //             timestamp: Date.now()
        //         });
        //         
        //         // å‘é€åˆ°æ‰€æœ‰é¡µé¢
        //         socket.emit('page_refresh', {
        //             page: 'all',
        //             operation: operation,
        //             type: type,
        //             timestamp: Date.now()
        //         });
        //         
        //         // å‘é€ç‰¹å®šç±»å‹çš„é€šçŸ¥
        //         if (type === 'TEAM_MEMBERS_UPDATED') {
        //             socket.emit('team_members_updated', {
        //                 operation: operation,
        //                 timestamp: Date.now()
        //             });
        //         }
        //         
        //         console.log('âœ… Socket.IOé€šçŸ¥å·²å‘é€');
        //     } catch (error) {
        //         console.error('âŒ Socket.IOé€šçŸ¥å¤±è´¥:', error);
        //     }
        // } else {
        //     console.warn('âš ï¸ Socket.IOæœªè¿æ¥ï¼Œæ— æ³•å‘é€å®æ—¶é€šçŸ¥');
        // }
        
        // é€šè¿‡localStorageé€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µ
        try {
            let key;
            if (type === 'TEAM_MEMBERS_UPDATED') {
                key = 'team_data_updated';
            } else if (type === 'RESEARCH_DATA_UPDATED') {
                key = 'research_data_updated';
            } else if (type === 'GRADE_DATA_UPDATED') {
                key = 'grade_data_updated';
            } else {
                key = 'data_updated';
            }
            localStorage.setItem(key, Date.now().toString());
            console.log('âœ… localStorageé€šçŸ¥å·²å‘é€');
        } catch (error) {
            console.error('âŒ localStorageé€šçŸ¥å¤±è´¥:', error);
        }
        
        // é€šè¿‡fetch APIç›´æ¥é€šçŸ¥åç«¯ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        try {
            fetch(getApiUrl('/api/test-notification'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    page: 'home',
                    type: type,
                    operation: operation,
                    payload: {
                        notification: true,
                        message: `å›¢é˜Ÿæˆå‘˜æ•°æ®å·²${operation}`
                    }
                })
            }).catch(error => {
                console.warn('âš ï¸ åç«¯é€šçŸ¥å¤±è´¥:', error);
            });
        } catch (error) {
            console.warn('âš ï¸ åç«¯é€šçŸ¥è¯·æ±‚å¤±è´¥:', error);
        }
        
        // å»¶è¿Ÿéšè—åŒæ­¥çŠ¶æ€
        setTimeout(() => {
            updateSyncStatus('show', 'âœ…', 'åŒæ­¥å®Œæˆ');
            setTimeout(() => {
                updateSyncStatus('hide');
            }, 2000);
        }, 1000);
    }

// é¡µé¢åŠ è½½å®Œæˆæç¤º
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        showMessage('å›¢é˜Ÿç®¡ç†ç³»ç»Ÿå·²å°±ç»ªï¼', 'success');
    }, 500);
    
    // åˆå§‹åŒ–Socket.IOè¿æ¥
    // initAdminSocketIO();  // Vercel ä¸æ”¯æŒ WebSocket
});

// åˆå§‹åŒ–ç®¡ç†é¡µé¢çš„Socket.IOè¿æ¥
// function initAdminSocketIO() {  // Vercel ä¸æ”¯æŒ WebSocket
//     try {
//         // åˆ›å»ºSocket.IOè¿æ¥
//         const socket = io({
//             transports: ['websocket', 'polling'],
//             timeout: 15000,
//             reconnection: true,
//             reconnectionAttempts: 10,
//             reconnectionDelay: 1000,
//             reconnectionDelayMax: 5000,
//             maxReconnectionAttempts: 10,
//             forceNew: false,
//             autoConnect: true,
//             upgrade: true,
//             rememberUpgrade: true,
//             pingTimeout: 10000,
//             pingInterval: 5000
//         });
//         
//         // è¿æ¥æˆåŠŸ
//         socket.on('connect', function() {
//             console.log('âœ… ç®¡ç†é¡µé¢Socket.IOè¿æ¥æˆåŠŸ');
//             
//             // åŠ å…¥ç®¡ç†é¡µé¢æˆ¿é—´
//             socket.emit('join_page', { page: 'admin' });
//             console.log('ğŸ“¡ å·²åŠ å…¥ç®¡ç†é¡µé¢æˆ¿é—´');
//             
//             // æ›´æ–°è°ƒè¯•ä¿¡æ¯
//             updateDebugInfo();
//         });
//         
//         // è¿æ¥æ–­å¼€
//         socket.on('disconnect', function(reason) {
//             console.log('âŒ ç®¡ç†é¡µé¢Socket.IOè¿æ¥æ–­å¼€:', reason);
//             updateDebugInfo();
//         });
//         
//         // è¿æ¥é”™è¯¯
//         socket.on('connect_error', function(error) {
//             console.error('âŒ ç®¡ç†é¡µé¢Socket.IOè¿æ¥é”™è¯¯:', error);
//             updateDebugInfo();
//         });
//         
//         // ç›‘å¬å›¢é˜Ÿæˆå‘˜æ›´æ–°é€šçŸ¥
//         socket.on('team_members_updated', function(data) {
//             console.log('ğŸ”„ æ”¶åˆ°å›¢é˜Ÿæˆå‘˜æ›´æ–°é€šçŸ¥:', data);
//             showMessage('å›¢é˜Ÿæˆå‘˜æ•°æ®å·²æ›´æ–°', 'success', 3000);
//             
//             // è‡ªåŠ¨åˆ·æ–°å›¢é˜Ÿæˆå‘˜æ•°æ®
//             setTimeout(() => {
//                 fetchData();
//             }, 500);
//         });
//
//         // ç›‘å¬é¡µé¢åˆ·æ–°é€šçŸ¥
//         socket.on('page_refresh', function(data) {
//             console.log('ğŸ”„ æ”¶åˆ°é¡µé¢åˆ·æ–°é€šçŸ¥:', data);
//             
//             if (data.action === 'updated' || data.action === 'deleted' || data.action === 'reordered') {
//                 showMessage('æ•°æ®å·²æ›´æ–°ï¼Œæ­£åœ¨åˆ·æ–°...', 'info', 2000);
//                 
//                 // æ ¹æ®æ“ä½œç±»å‹åˆ·æ–°ç›¸åº”æ•°æ®
//                 setTimeout(() => {
//                     if (data.action === 'updated' || data.action === 'deleted') {
//                         fetchData();
//                     }
//                 }, 500);
//             }
//         });
//
//         // å°†socketå¯¹è±¡æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›notifyFrontendUpdateå‡½æ•°ä½¿ç”¨
//         window.socket = socket;
//         
//         // å®šæœŸæ›´æ–°è°ƒè¯•ä¿¡æ¯
//         setInterval(updateDebugInfo, 2000);
//         
//     } catch (error) {
//         console.error('âŒ åˆå§‹åŒ–ç®¡ç†é¡µé¢Socket.IOå¤±è´¥:', error);
//     }
// }

// æ›´æ–°è°ƒè¯•ä¿¡æ¯
function updateDebugInfo() {
    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
        const socketStatus = window.socket && window.socket.connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
        const connectionId = window.socket ? window.socket.id : 'N/A';
        
        debugInfo.innerHTML = `
            <div style="background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; font-size: 12px; margin-top: 10px;">
                <h4 style="margin: 0 0 8px 0;">ğŸ”§ è°ƒè¯•ä¿¡æ¯</h4>
                <div>Socket.IOçŠ¶æ€: <span style="color: ${socketStatus === 'å·²è¿æ¥' ? '#22c55e' : '#ef4444'}">${socketStatus}</span></div>
                <div>è¿æ¥ID: ${connectionId}</div>
                <div>å½“å‰æ—¶é—´: ${new Date().toLocaleTimeString()}</div>
            </div>
        `;
    }
}
</script>
{% endblock %} 