{% extends 'admin/base.html' %}
{% block title %}ACMå®éªŒå®¤ - åå°ä¸»é¡µ{% endblock %}
{% block page_title %}åå°ä¸»é¡µ{% endblock %}
{% block extra_head %}
<script>
// API URLè¾…åŠ©å‡½æ•° - å…¼å®¹Verceléƒ¨ç½²
function getApiUrl(path) {
    // åœ¨Vercelç¯å¢ƒä¸‹ä½¿ç”¨å½“å‰åŸŸåï¼Œæœ¬åœ°å¼€å‘ä½¿ç”¨ç›¸å¯¹è·¯å¾„
    if (window.location.hostname.includes('vercel.app') || window.location.hostname.includes('vercel.com')) {
        return window.location.origin + path;
    }
    return path;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
/* æ•´ä½“é¡µé¢ç¾åŒ– */
body {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #ffffff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.main-content {
    background: rgba(255, 255, 255, 0.05);
}

/* æ¶ˆæ¯æç¤ºç³»ç»Ÿ */
.message-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    max-width: 400px;
}

.message {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(450px);
    transition: transform 0.3s ease;
}

.message.show {
    transform: translateX(0);
}

.message.success { border-left-color: #22c55e; color: #166534; }
.message.error { border-left-color: #ef4444; color: #dc2626; }
.message.info { border-left-color: #3b82f6; color: #1d4ed8; }

.message-icon {
    font-size: 18px;
    font-weight: bold;
}

/* å¡ç‰‡ç¾åŒ– */
.card {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

/* è¡¨æ ¼ç¾åŒ– */
.data-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.data-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px;
    font-weight: 600;
    text-align: left;
    border: none;
}

.data-table td {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: background-color 0.3s ease;
}

.sortable-item {
    transition: all 0.3s ease;
    cursor: move;
}

.sortable-item:hover {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
    transform: scale(1.01);
}

.sortable-chosen {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important;
    transform: rotate(2deg) scale(1.05);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.sortable-ghost {
    opacity: 0.4;
    transform: scale(0.95);
}

/* æ‹–æ‹½æ‰‹æŸ„ç¾åŒ– */
.sort-handle {
    display: inline-block;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 6px;
    cursor: grab;
    position: relative;
    transition: all 0.3s ease;
    margin-right: 8px;
}

.sort-handle:before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 12px;
    height: 12px;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="19" cy="5" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/><circle cx="19" cy="19" r="2"/></svg>') no-repeat center;
    background-size: contain;
}

.sort-handle:hover {
    transform: scale(1.1) rotate(15deg);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.sort-handle:active {
    cursor: grabbing;
    transform: scale(0.95);
}

/* æŒ‰é’®ç¾åŒ– */
.btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    text-decoration: none;
    display: inline-block;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    color: white;
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.btn-success {
    background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    color: #1f2937;
}

.btn-success:hover {
    color: #1f2937;
    box-shadow: 0 8px 25px rgba(132, 250, 176, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
}

.btn-danger:hover {
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 8px;
}

/* è¡¨å•æ§ä»¶ç¾åŒ– */
input, select, textarea {
    background: rgba(26, 26, 46, 0.85);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 12px 16px;
    color: #ffffff;
    font-size: 14px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    background: rgba(102, 126, 234, 0.2);
}

input::placeholder, textarea::placeholder {
    color: rgba(255, 255, 255, 0.8);
}

/* ç¾åŒ–ä¸‹æ‹‰é€‰é¡¹ */
select option {
    background: #1a1a2e;
    color: #ffffff;
    padding: 8px;
}

/* æ¨¡æ€æ¡†ç¾åŒ– */
.modal {
    background: rgba(0, 0, 0, 0.8) !important;
    backdrop-filter: blur(8px);
}

.modal-content {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)) !important;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px !important;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    animation: modalSlideIn 0.3s ease;
    color: #ffffff;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal h3 {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 20px;
}

.modal label {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    margin-bottom: 8px;
}

.modal label span {
    color: #ffffff;
    font-weight: 600;
}

/* çŠ¶æ€å¾½ç« ç¾åŒ– */
.status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.status-inactive {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

/* æœç´¢å’Œç­›é€‰åŒºåŸŸç¾åŒ– */
.table-actions {
    background: rgba(255, 255, 255, 0.05);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* è¡¨æ ¼å“åº”å¼ */
.table-responsive {
    border-radius: 15px;
    overflow: hidden;
}

/* åŠ¨ç”»å¢å¼º */
.card, .btn, .sortable-item {
    will-change: transform;
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2, #667eea);
}

/* æ¬¢è¿å¡ç‰‡ */
.welcome-card {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    text-align: center;
}

.welcome-card h2 {
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 28px;
    margin-bottom: 15px;
}

.welcome-card p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 16px;
    line-height: 1.6;
}
</style>
{% endblock %}
{% block content %}
<!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
<div class="message-container" id="messageContainer"></div>

<!-- æ¬¢è¿å¡ç‰‡ -->
<div class="welcome-card">
    <h2>ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œ{{ username }}ï¼</h2>
    <p>è¿™é‡Œæ˜¯åå°ä¸»é¡µç®¡ç†ç³»ç»Ÿï¼Œæ‚¨å¯ä»¥ç®¡ç†å›¢é˜Ÿæ ¸å¿ƒé¢†å¯¼ã€ç§‘åˆ›æˆæœç­‰å†…å®¹ï¼Œè¿™äº›å†…å®¹å°†å®æ—¶æ˜¾ç¤ºåœ¨å‰ç«¯é¦–é¡µã€‚</p>
</div>

<!-- æŒ‡å¯¼è€å¸ˆç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ‘¨â€ğŸ« æŒ‡å¯¼è€å¸ˆç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="leaderSearchInput" type="text" placeholder="æœç´¢å§“å/èŒä½..." style="padding:10px 14px;min-width:220px;">
            <select id="statusFilter" style="padding:10px 14px;">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="active">æ´»è·ƒ</option>
                <option value="inactive">éæ´»è·ƒ</option>
            </select>
        </div>
        <div class="btn-group">
            <button id="addLeaderBtn" class="btn btn-primary">â• æ–°å¢æŒ‡å¯¼è€å¸ˆ</button>
            <button id="saveLeaderOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="leaderTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>å§“å</th>
                    <th>èŒä½</th>
                    <th>çŠ¶æ€</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="leaderTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- ç§‘åˆ›æˆæœç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸš€ ç§‘åˆ›æˆæœç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="projectSearchInput" type="text" placeholder="æœç´¢æ ‡é¢˜/æè¿°..." style="padding:10px 14px;min-width:220px;">
            <select id="projectStatusFilter" style="padding:10px 14px;">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="active">æ´»è·ƒ</option>
                <option value="inactive">éæ´»è·ƒ</option>
            </select>
        </div>
        <div class="btn-group">
            <button id="addProjectBtn" class="btn btn-primary">ğŸš€ æ–°å¢é¡¹ç›®</button>
            <button id="saveProjectOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="projectTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>é¡¹ç›®æ ‡é¢˜</th>
                    <th>ç±»åˆ«</th>
                    <th>çŠ¶æ€</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="projectTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘æŒ‡å¯¼è€å¸ˆ -->
<div id="leaderModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal-content" style="min-width:340px;max-width:640px;width:92vw;padding:16px 16px 8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="leaderModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢æŒ‡å¯¼è€å¸ˆ</h3>
            <button id="leaderModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="leaderForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="leaderId">
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å§“å</span>
                <input id="leaderNameInput" required>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>èŒç§°</span>
                <input id="leaderPositionInput" required>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>ç ”ç©¶æ–¹å‘</span>
                <textarea id="leaderDescInput" rows="3" placeholder="ç ”ç©¶æ–¹å‘ï¼ˆå¯é€‰ï¼‰"></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å¤´åƒè¾¹æ¡†é¢œè‰²</span>
                <select id="leaderBorderColorInput" required>
                    <option value="primary">ä¸»è‰²è°ƒ</option>
                    <option value="secondary">æ¬¡è‰²è°ƒ</option>
                    <option value="accent">å¼ºè°ƒè‰²</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>çŠ¶æ€</span>
                <select id="leaderStatusInput" required>
                    <option value="active">æ´»è·ƒ</option>
                    <option value="inactive">éæ´»è·ƒ</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>å¤´åƒå›¾ç‰‡URL</span>
                <input id="leaderImageInput" placeholder="https://...ï¼ˆå¯é€‰ï¼‰">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>é‚®ç®±</span>
                <input id="leaderEmailInput" type="email" placeholder="å¯é€‰">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>Google Scholar</span>
                <input id="leaderGoogleInput" placeholder="å¯é€‰">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>GitHub</span>
                <input id="leaderGithubInput" placeholder="å¯é€‰">
            </label>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="leaderCancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘ç§‘åˆ›æˆæœ -->
<div id="projectModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal-content" style="min-width:340px;max-width:720px;width:92vw;padding:16px 16px 8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="projectModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢ç§‘åˆ›æˆæœ</h3>
            <button id="projectModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="projectForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="projectId">
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>é¡¹ç›®æ ‡é¢˜</span>
                <input id="projectTitleInput" required placeholder="ä¾‹å¦‚ï¼šæ™ºèƒ½æ¨èç³»ç»Ÿå¹³å°">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>é¡¹ç›®ç±»åˆ«</span>
                <select id="projectCategoryInput" required>
                    <option value="å›½å®¶çº§åˆ›æ–°åˆ›ä¸šé¡¹ç›®">å›½å®¶çº§åˆ›æ–°åˆ›ä¸šé¡¹ç›®</option>
                    <option value="çœçº§åˆ›æ–°åˆ›ä¸šé¡¹ç›®">çœçº§åˆ›æ–°åˆ›ä¸šé¡¹ç›®</option>
                    <option value="æ ¡çº§åˆ›æ–°åˆ›ä¸šé¡¹ç›®">æ ¡çº§åˆ›æ–°åˆ›ä¸šé¡¹ç›®</option>
                    <option value="ä¼ä¸šåˆä½œé¡¹ç›®">ä¼ä¸šåˆä½œé¡¹ç›®</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>çŠ¶æ€</span>
                <select id="projectStatusInput" required>
                    <option value="active">æ´»è·ƒ</option>
                    <option value="inactive">éæ´»è·ƒ</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>é¡¹ç›®æè¿°</span>
                <textarea id="projectDescInput" rows="4" placeholder="è¯¦ç»†æè¿°é¡¹ç›®å†…å®¹" required></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æŠ€æœ¯æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</span>
                <input id="projectTagsInput" placeholder="ä¾‹å¦‚ï¼šæ¨èç®—æ³•,ç”¨æˆ·ç”»åƒ,å®æ—¶è®¡ç®—,A/Bæµ‹è¯•">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>é¡¹ç›®å›¾ç‰‡URL</span>
                <div style="display:flex;gap:8px;align-items:end;">
                    <input id="projectImageInput" placeholder="https://...ï¼ˆå¯é€‰ï¼‰" style="flex:1;">
                    <button type="button" id="uploadProjectImageBtn" class="btn btn-sm" style="white-space:nowrap;">ğŸ“ ä¸Šä¼ å›¾ç‰‡</button>
                </div>
                <input type="file" id="projectImageFile" accept="image/*" style="display:none;">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>è¯¦æƒ…é“¾æ¥</span>
                <input id="projectDetailInput" placeholder="https://...ï¼ˆå¯é€‰ï¼‰">
            </label>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="projectCancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<script>
// å…¨å±€æ¶ˆæ¯æç¤ºç³»ç»Ÿ
function showMessage(text, type = 'info') {
    const container = document.getElementById('messageContainer');
    const message = document.createElement('div');
    message.className = `message ${type}`;
    
    const iconMap = {
        success: 'âœ“',
        error: 'âœ•',
        info: 'â“˜'
    };
    
    message.innerHTML = `
        <span class="message-icon">${iconMap[type] || 'â“˜'}</span>
        <span>${text}</span>
    `;
    
    container.appendChild(message);
    
    // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => message.classList.add('show'), 100);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        message.classList.remove('show');
        setTimeout(() => {
            if (message.parentNode) {
                message.parentNode.removeChild(message);
            }
        }, 300);
    }, 3000);
}

// å›¢é˜Ÿæ ¸å¿ƒé¢†å¯¼ç®¡ç†
(function(){
    const leaderTbody = document.getElementById('leaderTbody');
    const addLeaderBtn = document.getElementById('addLeaderBtn');
    const leaderModal = document.getElementById('leaderModal');
    const leaderModalClose = document.getElementById('leaderModalClose');
    const leaderCancelBtn = document.getElementById('leaderCancelBtn');
    const leaderForm = document.getElementById('leaderForm');
    const leaderModalTitle = document.getElementById('leaderModalTitle');

    const leaderId = document.getElementById('leaderId');
    const leaderNameInput = document.getElementById('leaderNameInput');
    const leaderPositionInput = document.getElementById('leaderPositionInput');
    const leaderDescInput = document.getElementById('leaderDescInput');
    const leaderBorderColorInput = document.getElementById('leaderBorderColorInput');
    const leaderStatusInput = document.getElementById('leaderStatusInput');
    const leaderImageInput = document.getElementById('leaderImageInput');
    const leaderEmailInput = document.getElementById('leaderEmailInput');
    const leaderGoogleInput = document.getElementById('leaderGoogleInput');
    const leaderGithubInput = document.getElementById('leaderGithubInput');

    const leaderSearchInput = document.getElementById('leaderSearchInput');
    const statusFilter = document.getElementById('statusFilter');

    let leaderData = [];
    let leaderSortableInstance = null;
    let hasUnsavedLeaderChanges = false;

    // åˆå§‹åŒ–æ‹–æ‹½æ’åº
    function initLeaderSortable() {
        if (leaderSortableInstance) {
            leaderSortableInstance.destroy();
        }
        
        leaderSortableInstance = new Sortable(leaderTbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                hasUnsavedLeaderChanges = true;
                document.getElementById('saveLeaderOrderBtn').style.display = 'inline-block';
            }
        });
    }

    // ä¿å­˜æ’åº
    async function saveLeaderOrder() {
        const rows = leaderTbody.querySelectorAll('tr[data-id]');
        const leaderIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        try {
            const res = await fetch(getApiUrl('/api/advisors/reorder'), {
                method: 'POST',
                credentials: 'same-origin', // ç¡®ä¿åŒ…å«è®¤è¯cookie
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ advisor_ids: leaderIds })
            });
            
            if (res.ok) {
                hasUnsavedLeaderChanges = false;
                document.getElementById('saveLeaderOrderBtn').style.display = 'none';
                showMessage('æŒ‡å¯¼è€å¸ˆæ’åºå·²ä¿å­˜', 'success');
                await fetchLeaderData(); // é‡æ–°åŠ è½½æ•°æ®ä»¥åæ˜ æ–°çš„æ’åº
                
                // é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°å›¢é˜Ÿæ ¸å¿ƒé¢†å¯¼æ•°æ®
                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: 'TEAM_LEADERS_UPDATED',
                            timestamp: Date.now()
                        }, '*');
                    }
                } catch (e) {
                    console.log('æ— æ³•é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°');
                }
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }

    function statusBadge(text){
        const map = { 'active': 'status-active', 'inactive': 'status-inactive' };
        const cls = map[text] || 'status-inactive';
        return `<span class="status ${cls}">${text === 'active' ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}</span>`;
    }

    function openLeaderModal(editData){
        leaderModal.style.display = 'flex';
        if(editData){
            leaderModalTitle.textContent = 'ç¼–è¾‘æŒ‡å¯¼è€å¸ˆ';
            leaderId.value = editData.id;
            leaderNameInput.value = editData.name || '';
            leaderPositionInput.value = editData.position || '';
            leaderDescInput.value = editData.description || '';
            leaderBorderColorInput.value = editData.border_color || 'primary';
            leaderStatusInput.value = editData.status || 'active';
            leaderImageInput.value = editData.image_url || '';
            leaderEmailInput.value = editData.email || '';
            leaderGoogleInput.value = editData.google_scholar || '';
            leaderGithubInput.value = editData.github || '';
        }else{
            leaderModalTitle.textContent = 'æ–°å¢æŒ‡å¯¼è€å¸ˆ';
            leaderForm.reset();
            leaderId.value = '';
        }
    }
    function closeLeaderModal(){ leaderModal.style.display = 'none'; }

    function renderLeaders(data){
        leaderTbody.innerHTML = data.map(l => `
            <tr class="sortable-item" data-id="${l.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>${l.name || ''}</td>
                <td>${l.position || ''}</td>
                <td>${statusBadge(l.status || '')}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${l.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${l.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½
        initLeaderSortable();
    }

    async function fetchLeaderData(){
        try {
            const res = await fetch(getApiUrl('/api/advisors/admin'), {
                method: 'GET',
                credentials: 'same-origin', // ç¡®ä¿åŒ…å«è®¤è¯cookie
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (res.ok) {
                leaderData = await res.json();
                applyLeaderFilter();
            } else {
                console.error('è·å–æŒ‡å¯¼è€å¸ˆæ•°æ®å¤±è´¥:', res.status);
                showMessage('è·å–æŒ‡å¯¼è€å¸ˆæ•°æ®å¤±è´¥', 'error');
                leaderData = [];
                applyLeaderFilter();
            }
        } catch (error) {
            console.error('è·å–æŒ‡å¯¼è€å¸ˆæ•°æ®å‡ºé”™:', error);
            showMessage('è·å–æŒ‡å¯¼è€å¸ˆæ•°æ®å‡ºé”™', 'error');
            leaderData = [];
            applyLeaderFilter();
        }
    }

    function applyLeaderFilter(){
        const kw = (leaderSearchInput.value || '').trim();
        const s = statusFilter.value || '';
        const filtered = leaderData.filter(l => {
            const hitKw = !kw || [l.name, l.position].some(v => (v||'').includes(kw));
            const hitS = !s || l.status === s;
            return hitKw && hitS;
        });
        renderLeaders(filtered);
    }

    leaderTbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        const current = leaderData.find(x => x.id === id);
        if(action === 'edit'){
            openLeaderModal(current);
        }
        if(action === 'delete'){
            if(!confirm('ç¡®è®¤åˆ é™¤è¯¥æŒ‡å¯¼è€å¸ˆï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const res = await fetch(`/api/advisors/${id}`, { 
                    method: 'DELETE',
                    credentials: 'same-origin' // ç¡®ä¿åŒ…å«è®¤è¯cookie
                });
                if(res.ok){ 
                    await fetchLeaderData(); 
                    showMessage('æŒ‡å¯¼è€å¸ˆåˆ é™¤æˆåŠŸ', 'success');
                    
                    // é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°æŒ‡å¯¼è€å¸ˆæ•°æ®
                    try {
                        if (window.opener && !window.opener.closed) {
                            window.opener.postMessage({
                                type: 'ADVISORS_UPDATED',
                                timestamp: Date.now()
                            }, '*');
                        }
                    } catch (e) {
                        console.log('æ— æ³•é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°');
                    }
                } else {
                    const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                    showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                console.error(e);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }
    });

    addLeaderBtn.addEventListener('click', () => openLeaderModal());
    leaderModalClose.addEventListener('click', closeLeaderModal);
    leaderCancelBtn.addEventListener('click', closeLeaderModal);
    leaderModal.addEventListener('click', (e) => { if(e.target === leaderModal) closeLeaderModal(); });

    leaderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // è¡¨å•éªŒè¯
        if (!leaderNameInput.value.trim()) {
            showMessage('è¯·å¡«å†™æŒ‡å¯¼è€å¸ˆå§“å', 'error');
            leaderNameInput.focus();
            return;
        }
        
        if (!leaderPositionInput.value.trim()) {
            showMessage('è¯·å¡«å†™æŒ‡å¯¼è€å¸ˆèŒç§°', 'error');
            leaderPositionInput.focus();
            return;
        }
        
        const payload = {
            name: leaderNameInput.value.trim(),
            position: leaderPositionInput.value.trim(),
            description: leaderDescInput.value.trim(),
            border_color: leaderBorderColorInput.value,
            status: leaderStatusInput.value,
            image_url: leaderImageInput.value.trim(),
            email: leaderEmailInput.value.trim(),
            google_scholar: leaderGoogleInput.value.trim(),
            github: leaderGithubInput.value.trim()
        };
        const id = leaderId.value;
        const isEdit = !!id;
        const res = await fetch(isEdit ? `/api/advisors/${id}` : '/api/advisors', {
            method: isEdit ? 'PUT' : 'POST',
            credentials: 'same-origin', // ç¡®ä¿åŒ…å«è®¤è¯cookie
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if(res.ok){
            closeLeaderModal();
            await fetchLeaderData();
            showMessage(isEdit ? 'æŒ‡å¯¼è€å¸ˆä¿¡æ¯æ›´æ–°æˆåŠŸ' : 'æŒ‡å¯¼è€å¸ˆæ·»åŠ æˆåŠŸ', 'success');
            
            // é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°æŒ‡å¯¼è€å¸ˆæ•°æ®
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({
                        type: 'ADVISORS_UPDATED',
                        timestamp: Date.now()
                    }, '*');
                }
            } catch (e) {
                console.log('æ— æ³•é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°');
            }
        }else{
            const err = await res.json().catch(()=>({error:'æäº¤å¤±è´¥'}));
            showMessage(err.error || 'æäº¤å¤±è´¥', 'error');
        }
    });

    leaderSearchInput.addEventListener('input', applyLeaderFilter);
    statusFilter.addEventListener('change', applyLeaderFilter);

    // ä¿å­˜æ’åºæŒ‰é’®äº‹ä»¶
    document.getElementById('saveLeaderOrderBtn').addEventListener('click', saveLeaderOrder);

    fetchLeaderData();
})();

// ç§‘åˆ›æˆæœç®¡ç†
(function(){
    const projectTbody = document.getElementById('projectTbody');
    const addProjectBtn = document.getElementById('addProjectBtn');
    const projectModal = document.getElementById('projectModal');
    const projectModalClose = document.getElementById('projectModalClose');
    const projectCancelBtn = document.getElementById('projectCancelBtn');
    const projectForm = document.getElementById('projectForm');
    const projectModalTitle = document.getElementById('projectModalTitle');

    const projectId = document.getElementById('projectId');
    const projectTitleInput = document.getElementById('projectTitleInput');
    const projectCategoryInput = document.getElementById('projectCategoryInput');
    const projectStatusInput = document.getElementById('projectStatusInput');
    const projectDescInput = document.getElementById('projectDescInput');
    const projectTagsInput = document.getElementById('projectTagsInput');
    const projectImageInput = document.getElementById('projectImageInput');
    const projectDetailInput = document.getElementById('projectDetailInput');

    const projectSearchInput = document.getElementById('projectSearchInput');
    const projectStatusFilter = document.getElementById('projectStatusFilter');

    // å›¾ç‰‡ä¸Šä¼ ç›¸å…³å…ƒç´ 
    const uploadProjectImageBtn = document.getElementById('uploadProjectImageBtn');
    const projectImageFile = document.getElementById('projectImageFile');

    let projectData = [];
    let projectSortableInstance = null;
    let hasUnsavedProjectChanges = false;

    // çŠ¶æ€å¾½ç« å‡½æ•°
    function statusBadge(text){
        const map = { 'active': 'status-active', 'inactive': 'status-inactive' };
        const cls = map[text] || 'status-inactive';
        return `<span class="status ${cls}">${text === 'active' ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}</span>`;
    }

    // åˆå§‹åŒ–æ‹–æ‹½æ’åº
    function initProjectSortable() {
        if (projectSortableInstance) {
            projectSortableInstance.destroy();
        }
        
        projectSortableInstance = new Sortable(projectTbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                hasUnsavedProjectChanges = true;
                document.getElementById('saveProjectOrderBtn').style.display = 'inline-block';
            }
        });
    }

    // ä¿å­˜æ’åº
    async function saveProjectOrder() {
        const rows = projectTbody.querySelectorAll('tr[data-id]');
        const projectIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        try {
            const res = await fetch(getApiUrl('/api/innovation-projects/reorder'), {
                method: 'POST',
                credentials: 'same-origin', // ç¡®ä¿åŒ…å«è®¤è¯cookie
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_ids: projectIds })
            });
            
            if (res.ok) {
                hasUnsavedProjectChanges = false;
                document.getElementById('saveProjectOrderBtn').style.display = 'none';
                showMessage('ç§‘åˆ›æˆæœæ’åºå·²ä¿å­˜', 'success');
                await fetchProjectData(); // é‡æ–°åŠ è½½æ•°æ®ä»¥åæ˜ æ–°çš„æ’åº
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }

    function openProjectModal(editData){
        projectModal.style.display = 'flex';
        if(editData){
            projectModalTitle.textContent = 'ç¼–è¾‘ç§‘åˆ›æˆæœ';
            projectId.value = editData.id;
            projectTitleInput.value = editData.title || '';
            projectCategoryInput.value = editData.category || 'å›½å®¶çº§åˆ›æ–°åˆ›ä¸šé¡¹ç›®';
            projectStatusInput.value = editData.status || 'active';
            projectDescInput.value = editData.description || '';
            projectTagsInput.value = editData.tags || '';
            projectImageInput.value = editData.image_url || '';
            projectDetailInput.value = editData.detail_url || '';
        }else{
            projectModalTitle.textContent = 'æ–°å¢ç§‘åˆ›æˆæœ';
            projectForm.reset();
            projectId.value = '';
        }
    }
    function closeProjectModal(){ projectModal.style.display = 'none'; }

    function renderProjects(data){
        projectTbody.innerHTML = data.map(p => `
            <tr class="sortable-item" data-id="${p.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>${p.title || ''}</td>
                <td>${p.category || ''}</td>
                <td>${statusBadge(p.status || '')}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${p.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${p.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½
        initProjectSortable();
    }

    async function fetchProjectData(){
        try {
            const res = await fetch(getApiUrl('/api/innovation-projects/admin'), {
                method: 'GET',
                credentials: 'same-origin', // ç¡®ä¿åŒ…å«è®¤è¯cookie
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (res.ok) {
                projectData = await res.json();
                applyProjectFilter();
            } else {
                console.error('è·å–é¡¹ç›®æ•°æ®å¤±è´¥:', res.status);
                showMessage('è·å–é¡¹ç›®æ•°æ®å¤±è´¥', 'error');
                projectData = [];
                applyProjectFilter();
            }
        } catch (error) {
            console.error('è·å–é¡¹ç›®æ•°æ®å‡ºé”™:', error);
            showMessage('è·å–é¡¹ç›®æ•°æ®å‡ºé”™', 'error');
            projectData = [];
            applyProjectFilter();
        }
    }

    function applyProjectFilter(){
        const kw = (projectSearchInput.value || '').trim();
        const s = projectStatusFilter.value || '';
        const filtered = projectData.filter(p => {
            const hitKw = !kw || [p.title, p.description].some(v => (v||'').includes(kw));
            const hitS = !s || p.status === s;
            return hitKw && hitS;
        });
        renderProjects(filtered);
    }

    projectTbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        const current = projectData.find(x => x.id === id);
        if(action === 'edit'){
            openProjectModal(current);
        }
        if(action === 'delete'){
            if(!confirm('ç¡®è®¤åˆ é™¤è¯¥ç§‘åˆ›æˆæœï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const res = await fetch(`/api/innovation-projects/${id}`, { 
                    method: 'DELETE',
                    credentials: 'same-origin' // ç¡®ä¿åŒ…å«è®¤è¯cookie
                });
                if(res.ok){ 
                    await fetchProjectData(); 
                    showMessage('ç§‘åˆ›æˆæœåˆ é™¤æˆåŠŸ', 'success');
                    
                    // é€šçŸ¥å‰ç«¯é¡µé¢åˆ·æ–°æ•°æ®ï¼ˆå¦‚æœå‰ç«¯é¡µé¢æ‰“å¼€çš„è¯ï¼‰
                    try {
                        if (window.opener && !window.opener.closed) {
                            window.opener.postMessage({
                                type: 'INNOVATION_PROJECTS_UPDATED',
                                timestamp: Date.now()
                            }, '*');
                        }
                    } catch (e) {
                        console.log('æ— æ³•é€šçŸ¥å‰ç«¯é¡µé¢åˆ·æ–°');
                    }
                } else {
                    const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                    showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                console.error(e);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }
    });

    addProjectBtn.addEventListener('click', () => openProjectModal());
    projectModalClose.addEventListener('click', closeProjectModal);
    projectCancelBtn.addEventListener('click', closeProjectModal);
    projectModal.addEventListener('click', (e) => { if(e.target === projectModal) closeProjectModal(); });

    // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
    uploadProjectImageBtn.addEventListener('click', () => {
        projectImageFile.click();
    });

    projectImageFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            showMessage('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆJPGã€PNGã€GIFã€WebPï¼‰', 'error');
            return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
        if (file.size > 5 * 1024 * 1024) {
            showMessage('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(getApiUrl('/api/innovation-projects/upload-image'), {
                method: 'POST',
                credentials: 'same-origin', // ç¡®ä¿åŒ…å«è®¤è¯cookie
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                projectImageInput.value = result.image_url;
                showMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
            } else {
                const error = await response.json().catch(() => ({error: 'ä¸Šä¼ å¤±è´¥'}));
                showMessage(error.error || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
            showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    });

    projectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // è¡¨å•éªŒè¯
        if (!projectTitleInput.value.trim()) {
            showMessage('è¯·å¡«å†™é¡¹ç›®æ ‡é¢˜', 'error');
            projectTitleInput.focus();
            return;
        }
        
        if (!projectDescInput.value.trim()) {
            showMessage('è¯·å¡«å†™é¡¹ç›®æè¿°', 'error');
            projectDescInput.focus();
            return;
        }
        
        const payload = {
            title: projectTitleInput.value.trim(),
            category: projectCategoryInput.value,
            status: projectStatusInput.value,
            description: projectDescInput.value.trim(),
            tags: projectTagsInput.value.trim(),
            image_url: projectImageInput.value.trim(),
            detail_url: projectDetailInput.value.trim()
        };
        const id = projectId.value;
        const isEdit = !!id;
        const res = await fetch(isEdit ? `/api/innovation-projects/${id}` : '/api/innovation-projects', {
            method: isEdit ? 'PUT' : 'POST',
            credentials: 'same-origin', // ç¡®ä¿åŒ…å«è®¤è¯cookie
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if(res.ok){
            closeProjectModal();
            await fetchProjectData();
            showMessage(isEdit ? 'ç§‘åˆ›æˆæœæ›´æ–°æˆåŠŸ' : 'ç§‘åˆ›æˆæœæ·»åŠ æˆåŠŸ', 'success');
            
            // é€šçŸ¥å‰ç«¯é¡µé¢åˆ·æ–°æ•°æ®ï¼ˆå¦‚æœå‰ç«¯é¡µé¢æ‰“å¼€çš„è¯ï¼‰
            try {
                // å°è¯•é€šçŸ¥å‰ç«¯é¡µé¢åˆ·æ–°æ•°æ®
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({
                        type: 'INNOVATION_PROJECTS_UPDATED',
                        timestamp: Date.now()
                    }, '*');
                }
            } catch (e) {
                console.log('æ— æ³•é€šçŸ¥å‰ç«¯é¡µé¢åˆ·æ–°');
            }
        }else{
            const err = await res.json().catch(()=>({error:'æäº¤å¤±è´¥'}));
            showMessage(err.error || 'æäº¤å¤±è´¥', 'error');
        }
    });

    projectSearchInput.addEventListener('input', applyProjectFilter);
    projectStatusFilter.addEventListener('change', applyProjectFilter);

    // ä¿å­˜æ’åºæŒ‰é’®äº‹ä»¶
    document.getElementById('saveProjectOrderBtn').addEventListener('click', saveProjectOrder);

    fetchProjectData();
    
    // ç›‘å¬æ¥è‡ªå‰ç«¯é¡µé¢çš„æ¶ˆæ¯ï¼Œç”¨äºå®æ—¶æ›´æ–°
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'FRONTEND_READY') {
            console.log('å‰ç«¯é¡µé¢å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ¥æ”¶æ›´æ–°é€šçŸ¥');
        }
    });
})();

// Socket.IO å®æ—¶åˆ·æ–°åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    // è®¾ç½®å½“å‰é¡µé¢
    if (typeof setCurrentPage === 'function') {
        setCurrentPage('home');
    }
    
    // åˆå§‹åŒ–Socket.IOè¿æ¥
    if (typeof initSocketIO === 'function') {
        initSocketIO();
    }
    
    // ç›‘å¬é¡µé¢åˆ·æ–°äº‹ä»¶
    if (typeof socket !== 'undefined' && socket) {
        socket.on('page_refresh', function(data) {
            console.log('æ”¶åˆ°ä¸»é¡µæ•°æ®æ›´æ–°é€šçŸ¥:', data);
            
            // å¦‚æœæ˜¯é¦–é¡µç›¸å…³æ•°æ®æ›´æ–°ï¼Œé‡æ–°åŠ è½½é¡µé¢å†…å®¹
            if (data.page === 'home' || data.page === 'all') {
                console.log('åˆ·æ–°ä¸»é¡µå†…å®¹...');
                // æ£€æŸ¥æ˜¯å¦æ˜¯æŒ‡å¯¼è€å¸ˆç›¸å…³æ›´æ–°
                if (data.payload && (data.payload.type === 'advisor_created' || 
                    data.payload.type === 'advisor_updated' || 
                    data.payload.type === 'advisor_deleted' || 
                    data.payload.type === 'advisors_reordered')) {
                    console.log('æ”¶åˆ°æŒ‡å¯¼è€å¸ˆæ•°æ®æ›´æ–°ï¼Œåˆ·æ–°æŒ‡å¯¼è€å¸ˆåˆ—è¡¨');
                    if (typeof fetchLeaderData === 'function') {
                        fetchLeaderData();
                    }
                } else {
                    // å…¶ä»–æ•°æ®æ›´æ–°ï¼Œç®€å•åˆ·æ–°é¡µé¢
                    location.reload();
                }
            }
        });
    }
    
    console.log('ä¸»é¡µç®¡ç† - Socket.IOå®æ—¶åˆ·æ–°å·²åˆå§‹åŒ–');
});
</script>
{% endblock %} 