{% extends 'admin/base.html' %}
{% block title %}ACMå®éªŒå®¤ - ç§‘åˆ›ç®¡ç†{% endblock %}
{% block page_title %}ç§‘åˆ›ç®¡ç†{% endblock %}
{% block extra_head %}
<script>
// API URLè¾…åŠ©å‡½æ•° - å…¼å®¹Verceléƒ¨ç½²
function getApiUrl(path) {
    // åœ¨Vercelç¯å¢ƒä¸‹ä½¿ç”¨å½“å‰åŸŸåï¼Œæœ¬åœ°å¼€å‘ä½¿ç”¨ç›¸å¯¹è·¯å¾„
    if (window.location.hostname.includes('vercel.app') || window.location.hostname.includes('vercel.com')) {
        return window.location.origin + path;
    }
    return path;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
/* æ•´ä½“é¡µé¢ç¾åŒ– */
body {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #ffffff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.main-content {
    background: rgba(255, 255, 255, 0.05);
}

/* æ¶ˆæ¯æç¤ºç³»ç»Ÿ */
.message-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    max-width: 400px;
}

.message {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(450px);
    transition: transform 0.3s ease;
}

.message.show {
    transform: translateX(0);
}

.message.success { border-left-color: #22c55e; color: #166534; }
.message.error { border-left-color: #ef4444; color: #dc2626; }
.message.info { border-left-color: #3b82f6; color: #1d4ed8; }

.message-icon {
    font-size: 18px;
    font-weight: bold;
}

/* å¡ç‰‡ç¾åŒ– */
.card {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

/* è¡¨æ ¼ç¾åŒ– */
.data-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.data-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px;
    font-weight: 600;
    text-align: left;
    border: none;
}

.data-table td {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: background-color 0.3s ease;
}

.sortable-item {
    transition: all 0.3s ease;
    cursor: move;
}

.sortable-item:hover {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
    transform: scale(1.01);
}

.sortable-chosen {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important;
    transform: rotate(2deg) scale(1.05);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.sortable-ghost {
    opacity: 0.4;
    transform: scale(0.95);
}

/* æ‹–æ‹½æ‰‹æŸ„ç¾åŒ– */
.sort-handle {
    display: inline-block;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 6px;
    cursor: grab;
    position: relative;
    transition: all 0.3s ease;
    margin-right: 8px;
}

.sort-handle:before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 12px;
    height: 12px;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="19" cy="5" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/><circle cx="19" cy="19" r="2"/></svg>') no-repeat center;
    background-size: contain;
}

.sort-handle:hover {
    transform: scale(1.1) rotate(15deg);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.sort-handle:active {
    cursor: grabbing;
    transform: scale(0.95);
}

/* æŒ‰é’®ç¾åŒ– */
.btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    text-decoration: none;
    display: inline-block;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    color: white;
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.btn-success {
    background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    color: #1f2937;
}

.btn-success:hover {
    color: #1f2937;
    box-shadow: 0 8px 25px rgba(132, 250, 176, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
}

.btn-danger:hover {
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 8px;
}

/* è¡¨å•æ§ä»¶ç¾åŒ– */
input, select, textarea {
    background: rgba(26, 26, 46, 0.85);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 12px 16px;
    color: #ffffff;
    font-size: 14px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    background: rgba(102, 126, 234, 0.2);
}

input::placeholder, textarea::placeholder {
    color: rgba(255, 255, 255, 0.8);
}

/* ç¾åŒ–ä¸‹æ‹‰é€‰é¡¹ */
select option {
    background: #1a1a2e;
    color: #ffffff;
    padding: 8px;
}

/* ç‰¹åˆ«ä¼˜åŒ–çŠ¶æ€é€‰æ‹©æ¡† */
#statsStatusInput, #fieldsStatusInput, #achievementsStatusInput, #carouselStatusInput {
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M7 10l5 5 5-5z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
}

#statsStatusInput:hover, #fieldsStatusInput:hover, #achievementsStatusInput:hover, #carouselStatusInput:hover {
    border-color: #667eea;
    background-color: rgba(102, 126, 234, 0.1);
}

/* ç¡®ä¿é€‰æ‹©æ¡†åœ¨æ¨¡æ€æ¡†ä¸­çš„å±‚çº§ */
.modal select {
    position: relative;
    z-index: 10001;
}

/* æ¨¡æ€æ¡†æ ·å¼å·²ç»Ÿä¸€åˆ°base.htmlä¸­ */

/* çŠ¶æ€å¾½ç« ç¾åŒ– */
.status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.status-inactive {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

/* æœç´¢å’Œç­›é€‰åŒºåŸŸç¾åŒ– */
.table-actions {
    background: rgba(255, 255, 255, 0.05);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* è¡¨æ ¼å“åº”å¼ */
.table-responsive {
    border-radius: 15px;
    overflow: hidden;
}

/* é¢œè‰²é€‰æ‹©å™¨ */
.color-picker {
    width: 60px;
    height: 40px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

/* åŠ¨ç”»å¢å¼º */
.card, .btn, .sortable-item {
    will-change: transform;
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2, #667eea);
}

/* è½®æ’­å›¾ç‰¹æ®Šæ ·å¼ */
.carousel-preview-container {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
}

.carousel-preview-container:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.image-upload-area {
    border: 2px dashed rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.02);
}

.image-upload-area:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}

.image-upload-area.dragover {
    border-color: #764ba2;
    background: rgba(118, 75, 162, 0.2);
    transform: scale(1.02);
}

.range-slider {
    appearance: none;
    height: 6px;
    border-radius: 5px;
    background: linear-gradient(90deg, #1a1a2e 0%, #667eea 100%);
    outline: none;
    transition: all 0.3s ease;
}

.range-slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
}

.range-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.6);
}

.preview-overlay-text {
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-content {
    max-height: 90vh;
    overflow-y: auto;
}
</style>
{% endblock %}
{% block content %}
<!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
<div class="message-container" id="messageContainer"></div>

<!-- é¡¹ç›®ç»Ÿè®¡ç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ“Š é¡¹ç›®ç»Ÿè®¡ç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="statsSearchInput" type="text" placeholder="æœç´¢ç»Ÿè®¡é¡¹åç§°..." style="padding:10px 14px;min-width:220px;">
        </div>
        <div class="btn-group">
            <button id="addStatsBtn" class="btn btn-primary">â• æ–°å¢ç»Ÿè®¡</button>
            <button id="saveStatsOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="statsTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>åç§°</th>
                    <th>æ•°å€¼</th>
                    <th>å›¾æ ‡</th>
                    <th>æè¿°</th>
                    <th>çŠ¶æ€</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="statsTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>



<!-- è½®æ’­å›¾ç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ–¼ï¸ è½®æ’­å›¾ç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="carouselSearchInput" type="text" placeholder="æœç´¢è½®æ’­å›¾æ ‡é¢˜..." style="padding:10px 14px;min-width:220px;">
        </div>
        <div class="btn-group">
            <button id="addCarouselBtn" class="btn btn-primary">ğŸ–¼ï¸ æ–°å¢è½®æ’­å›¾</button>
            <button id="saveCarouselOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="carouselTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>é¢„è§ˆ</th>
                    <th>æ ‡é¢˜</th>
                    <th>æè¿°</th>
                    <th>ä½ç½®</th>
                    <th>çŠ¶æ€</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="carouselTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- æˆæœä¸è£èª‰ç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ† æˆæœä¸è£èª‰ç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="achievementsSearchInput" type="text" placeholder="æœç´¢æˆæœæ ‡é¢˜..." style="padding:10px 14px;min-width:220px;">
            <select id="typeFilter" style="padding:10px 14px;">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="award">é¡¹ç›®è·å¥–</option>
                <option value="patent">çŸ¥è¯†äº§æƒ</option>
            </select>
        </div>
        <div class="btn-group">
            <button id="addAchievementBtn" class="btn btn-primary">ğŸ† æ–°å¢æˆæœ</button>
            <button id="saveAchievementsOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="achievementsTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>æ ‡é¢˜</th>
                    <th>ç±»å‹</th>
                    <th>æè¿°</th>
                    <th>æ—¥æœŸ</th>
                    <th>çŠ¶æ€</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="achievementsTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šè®­ç»ƒè®¡åˆ’ç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ“ å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šè®­ç»ƒè®¡åˆ’ç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="trainingProjectsSearchInput" type="text" placeholder="æœç´¢é¡¹ç›®æ ‡é¢˜..." style="padding:10px 14px;min-width:220px;">
            <select id="categoryFilter" style="padding:10px 14px;">
                <option value="">å…¨éƒ¨ç±»åˆ«</option>
                <option value="äººå·¥æ™ºèƒ½">äººå·¥æ™ºèƒ½</option>
                <option value="å¤§æ•°æ®">å¤§æ•°æ®</option>
                <option value="ç‰©è”ç½‘">ç‰©è”ç½‘</option>
                <option value="åŒºå—é“¾">åŒºå—é“¾</option>
                <option value="äº‘è®¡ç®—">äº‘è®¡ç®—</option>
            </select>
        </div>
        <div class="btn-group">
            <button id="addTrainingProjectBtn" class="btn btn-primary">ğŸ“ æ–°å¢é¡¹ç›®</button>
            <button id="saveTrainingProjectsOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="trainingProjectsTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>é¢„è§ˆ</th>
                    <th>æ ‡é¢˜</th>
                    <th>ç±»åˆ«</th>
                    <th>è¿›åº¦</th>
                    <th>è´Ÿè´£äºº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="trainingProjectsTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- çŸ¥è¯†äº§æƒç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ“‹ çŸ¥è¯†äº§æƒç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="intellectualPropertiesSearchInput" type="text" placeholder="æœç´¢çŸ¥è¯†äº§æƒæ ‡é¢˜..." style="padding:10px 14px;min-width:220px;">
            <select id="propertyTypeFilter" style="padding:10px 14px;">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="patent">ä¸“åˆ©</option>
                <option value="copyright">è‘—ä½œæƒ</option>
                <option value="trademark">å•†æ ‡</option>
            </select>
        </div>
        <div class="btn-group">
            <button id="addIntellectualPropertyBtn" class="btn btn-primary">ğŸ“‹ æ–°å¢çŸ¥è¯†äº§æƒ</button>
            <button id="saveIntellectualPropertiesOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="intellectualPropertiesTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>é¢„è§ˆ</th>
                    <th>æ ‡é¢˜</th>
                    <th>ç±»å‹</th>
                    <th>ä¸“åˆ©å·</th>
                    <th>å‘æ˜äºº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="intellectualPropertiesTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- æ ¡ä¼åˆä½œç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ¤ æ ¡ä¼åˆä½œç®¡ç†</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="enterpriseCooperationsSearchInput" type="text" placeholder="æœç´¢åˆä½œé¡¹ç›®æ ‡é¢˜..." style="padding:10px 14px;min-width:220px;">
            <select id="enterpriseFilter" style="padding:10px 14px;">
                <option value="">å…¨éƒ¨ä¼ä¸š</option>
                <option value="åä¸ºæŠ€æœ¯">åä¸ºæŠ€æœ¯</option>
                <option value="è…¾è®¯ç§‘æŠ€">è…¾è®¯ç§‘æŠ€</option>
                <option value="é˜¿é‡Œå·´å·´">é˜¿é‡Œå·´å·´</option>
                <option value="ç™¾åº¦">ç™¾åº¦</option>
                <option value="å­—èŠ‚è·³åŠ¨">å­—èŠ‚è·³åŠ¨</option>
            </select>
        </div>
        <div class="btn-group">
            <button id="addEnterpriseCooperationBtn" class="btn btn-primary">ğŸ¤ æ–°å¢åˆä½œ</button>
            <button id="saveEnterpriseCooperationsOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="enterpriseCooperationsTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>é¢„è§ˆ</th>
                    <th>é¡¹ç›®æ ‡é¢˜</th>
                    <th>åˆä½œä¼ä¸š</th>
                    <th>ç±»åˆ«</th>
                    <th>è´Ÿè´£äºº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="enterpriseCooperationsTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘é¡¹ç›®ç»Ÿè®¡ -->
<div id="statsModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
            <div class="modal-content" style="min-width:340px;max-width:640px;width:92vw;padding:16px 16px 8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <h3 id="statsModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢é¡¹ç›®ç»Ÿè®¡</h3>
                <button id="statsModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="statsForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="statsId">
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>åç§°</span>
                <input id="statsNameInput" required placeholder="ä¾‹å¦‚ï¼šå·²å®Œæˆé¡¹ç›®">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>æ•°å€¼</span>
                <input id="statsValueInput" type="number" required placeholder="ä¾‹å¦‚ï¼š25">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å›¾æ ‡</span>
                <input id="statsIconInput" placeholder="ä¾‹å¦‚ï¼šfa-lightbulb-o">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>çŠ¶æ€</span>
                <select id="statsStatusInput" required>
                    <option value="active">å¯ç”¨</option>
                    <option value="inactive">ç¦ç”¨</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æè¿°</span>
                <textarea id="statsDescInput" rows="3" placeholder="æè¿°ä¿¡æ¯"></textarea>
            </label>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="statsCancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>



<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘è½®æ’­å›¾ -->
<div id="carouselModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal-content" style="min-width:400px;max-width:700px;width:95vw;padding:16px 16px 8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="carouselModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢è½®æ’­å›¾</h3>
            <button id="carouselModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="carouselForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="carouselId">
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æ ‡é¢˜</span>
                <input id="carouselTitleInput" required placeholder="ä¾‹å¦‚ï¼šæ™ºèƒ½è§†è§‰åˆ†æç³»ç»Ÿ">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æè¿°</span>
                <textarea id="carouselDescInput" rows="3" placeholder="é¡¹ç›®æè¿°" required></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å›¾ç‰‡</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input id="carouselImageInput" type="file" accept="image/*" style="display:none;">
                    <button type="button" id="carouselImageBtn" class="btn" style="padding:8px 12px;font-size:14px;">ğŸ“ é€‰æ‹©å›¾ç‰‡</button>
                    <span id="carouselImageName" style="font-size:12px;color:#666;"></span>
                </div>
                <input id="carouselImageUrlInput" placeholder="æˆ–è¾“å…¥å›¾ç‰‡URL" style="margin-top:4px;">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>é“¾æ¥åœ°å€ (å¯é€‰)</span>
                <input id="carouselLinkInput" placeholder="ä¾‹å¦‚ï¼šhttps://example.com">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>æ–‡å­—ä½ç½®</span>
                <select id="carouselTextPositionInput" required>
                    <option value="bottom-left">å·¦ä¸‹è§’</option>
                    <option value="bottom-right">å³ä¸‹è§’</option>
                    <option value="center">å±…ä¸­</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>é®ç½©é€æ˜åº¦</span>
                <input id="carouselOpacityInput" type="range" min="0" max="1" step="0.1" value="0.3" class="range-slider" style="margin-bottom:4px;">
                <span id="carouselOpacityValue" style="font-size:12px;color:#666;">0.3</span>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>çŠ¶æ€</span>
                <select id="carouselStatusInput" required>
                    <option value="active">å¯ç”¨</option>
                    <option value="inactive">ç¦ç”¨</option>
                </select>
            </label>
            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <div id="carouselPreview" style="grid-column:1 / -1;display:none;margin-top:8px;">
                <label style="color:#666;font-size:14px;margin-bottom:8px;">é¢„è§ˆï¼š</label>
                <div class="carousel-preview-container" style="position:relative;width:100%;height:200px;border:1px solid #ddd;background:#f5f5f5;">
                    <img id="carouselPreviewImg" style="width:100%;height:100%;object-fit:cover;">
                    <div id="carouselPreviewOverlay" style="position:absolute;inset:0;background:rgba(0,0,0,0.3);display:flex;align-items:end;padding:16px;">
                        <div id="carouselPreviewText" class="preview-overlay-text" style="background:rgba(15,23,42,0.8);padding:12px;border-radius:8px;color:white;max-width:60%;">
                            <h4 id="carouselPreviewTitle" style="margin:0 0 4px 0;font-size:16px;">æ ‡é¢˜é¢„è§ˆ</h4>
                            <p id="carouselPreviewDesc" style="margin:0;font-size:14px;opacity:0.9;">æè¿°é¢„è§ˆ</p>
                        </div>
                    </div>
                </div>
            </div>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="carouselCancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘æˆæœä¸è£èª‰ -->
<div id="achievementsModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal-content" style="min-width:340px;max-width:640px;width:92vw;padding:16px 16px 8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="achievementsModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢æˆæœä¸è£èª‰</h3>
            <button id="achievementsModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="achievementsForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="achievementsId">
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æ ‡é¢˜</span>
                <input id="achievementsTitleInput" required placeholder="ä¾‹å¦‚ï¼šå…¨å›½å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šå¤§èµ›é‡‘å¥–">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>ç±»å‹</span>
                <select id="achievementsTypeInput" required>
                    <option value="award">é¡¹ç›®è·å¥–</option>
                    <option value="patent">çŸ¥è¯†äº§æƒ</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>æ—¥æœŸ</span>
                <input id="achievementsDateInput" type="date">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å›¾æ ‡</span>
                <input id="achievementsIconInput" placeholder="ä¾‹å¦‚ï¼šfa-trophy">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>çŠ¶æ€</span>
                <select id="achievementsStatusInput" required>
                    <option value="active">å¯ç”¨</option>
                    <option value="inactive">ç¦ç”¨</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æè¿°</span>
                <textarea id="achievementsDescInput" rows="3" placeholder="æˆæœæè¿°" required></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æ‰©å±•æ•°æ® (JSONæ ¼å¼ï¼Œå¯é€‰)</span>
                <textarea id="achievementsExtraInput" rows="3" placeholder='ä¾‹å¦‚ï¼š{"progress": 90, "category": "å‘æ˜ä¸“åˆ©"}'></textarea>
            </label>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="achievementsCancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šè®­ç»ƒè®¡åˆ’ -->
<div id="trainingProjectsModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal-content" style="min-width:400px;max-width:800px;width:95vw;padding:16px 16px 8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="trainingProjectsModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šè®­ç»ƒè®¡åˆ’</h3>
            <button id="trainingProjectsModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="trainingProjectsForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="trainingProjectsId">
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>é¡¹ç›®æ ‡é¢˜</span>
                <input id="trainingProjectsTitleInput" required placeholder="ä¾‹å¦‚ï¼šæ™ºèƒ½è§†è§‰åˆ†æç³»ç»Ÿ">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>é¡¹ç›®æè¿°</span>
                <textarea id="trainingProjectsDescInput" rows="3" placeholder="é¡¹ç›®è¯¦ç»†æè¿°" required></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>é¡¹ç›®ç±»åˆ«</span>
                <select id="trainingProjectsCategoryInput" required>
                    <option value="äººå·¥æ™ºèƒ½">äººå·¥æ™ºèƒ½</option>
                    <option value="å¤§æ•°æ®">å¤§æ•°æ®</option>
                    <option value="ç‰©è”ç½‘">ç‰©è”ç½‘</option>
                    <option value="åŒºå—é“¾">åŒºå—é“¾</option>
                    <option value="äº‘è®¡ç®—">äº‘è®¡ç®—</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>é¡¹ç›®è¿›åº¦ (%)</span>
                <input id="trainingProjectsProgressInput" type="number" min="0" max="100" value="0" required>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å¼€å§‹æ—¶é—´</span>
                <input id="trainingProjectsStartDateInput" type="date">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>ç»“æŸæ—¶é—´</span>
                <input id="trainingProjectsEndDateInput" type="date">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>é¡¹ç›®ç»è´¹</span>
                <input id="trainingProjectsBudgetInput" placeholder="ä¾‹å¦‚ï¼šÂ¥2,800,000">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>é¡¹ç›®è´Ÿè´£äºº</span>
                <input id="trainingProjectsLeaderInput" placeholder="ä¾‹å¦‚ï¼šææ•™æˆ">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å‚ä¸äººå‘˜æ•°é‡</span>
                <input id="trainingProjectsMembersCountInput" type="number" min="0" value="0">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>è”ç³»é‚®ç®±</span>
                <input id="trainingProjectsContactEmailInput" type="email" placeholder="ä¾‹å¦‚ï¼šli@acmlab.edu.cn">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>è”ç³»ç”µè¯</span>
                <input id="trainingProjectsContactPhoneInput" placeholder="ä¾‹å¦‚ï¼š138-1234-5678">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å¾®ä¿¡å·</span>
                <input id="trainingProjectsContactWechatInput" placeholder="ä¾‹å¦‚ï¼šli_professor_2024">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>çŠ¶æ€</span>
                <select id="trainingProjectsStatusInput" required>
                    <option value="active">å¯ç”¨</option>
                    <option value="inactive">ç¦ç”¨</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>é¡¹ç›®å›¾ç‰‡</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input id="trainingProjectsImageInput" type="file" accept="image/*" style="display:none;">
                    <button type="button" id="trainingProjectsImageBtn" class="btn" style="padding:8px 12px;font-size:14px;">ğŸ“ é€‰æ‹©å›¾ç‰‡</button>
                    <span id="trainingProjectsImageName" style="font-size:12px;color:#666;"></span>
                </div>
                <input id="trainingProjectsImageUrlInput" placeholder="æˆ–è¾“å…¥å›¾ç‰‡URL" style="margin-top:4px;">
            </label>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="trainingProjectsCancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘çŸ¥è¯†äº§æƒ -->
<div id="intellectualPropertiesModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal-content" style="min-width:400px;max-width:800px;width:95vw;padding:16px 16px 8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="intellectualPropertiesModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢çŸ¥è¯†äº§æƒ</h3>
            <button id="intellectualPropertiesModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="intellectualPropertiesForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="intellectualPropertiesId">
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>çŸ¥è¯†äº§æƒæ ‡é¢˜</span>
                <input id="intellectualPropertiesTitleInput" required placeholder="ä¾‹å¦‚ï¼šä¸€ç§åŸºäºæ·±åº¦å­¦ä¹ çš„å›¾åƒè¯†åˆ«æ–¹æ³•">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>æè¿°å†…å®¹</span>
                <textarea id="intellectualPropertiesDescInput" rows="3" placeholder="çŸ¥è¯†äº§æƒè¯¦ç»†æè¿°" required></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>ç±»å‹</span>
                <select id="intellectualPropertiesTypeInput" required>
                    <option value="patent">ä¸“åˆ©</option>
                    <option value="copyright">è‘—ä½œæƒ</option>
                    <option value="trademark">å•†æ ‡</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>æŠ€æœ¯ç±»åˆ«</span>
                <input id="intellectualPropertiesCategoryInput" placeholder="ä¾‹å¦‚ï¼šäººå·¥æ™ºèƒ½">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>ç”³è¯·æ—¶é—´</span>
                <input id="intellectualPropertiesApplicationDateInput" type="date">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>æˆæƒæ—¶é—´</span>
                <input id="intellectualPropertiesGrantDateInput" type="date">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>ä¸“åˆ©å·</span>
                <input id="intellectualPropertiesPatentNumberInput" placeholder="ä¾‹å¦‚ï¼šCN123456789A">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å‘æ˜äºº</span>
                <input id="intellectualPropertiesInventorsInput" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ã€æå››">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>çŠ¶æ€</span>
                <select id="intellectualPropertiesStatusInput" required>
                    <option value="active">å¯ç”¨</option>
                    <option value="inactive">ç¦ç”¨</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>å›¾ç‰‡</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input id="intellectualPropertiesImageInput" type="file" accept="image/*" style="display:none;">
                    <button type="button" id="intellectualPropertiesImageBtn" class="btn" style="padding:8px 12px;font-size:14px;">ğŸ“ é€‰æ‹©å›¾ç‰‡</button>
                    <span id="intellectualPropertiesImageName" style="font-size:12px;color:#666;"></span>
                </div>
                <input id="intellectualPropertiesImageUrlInput" placeholder="æˆ–è¾“å…¥å›¾ç‰‡URL" style="margin-top:4px;">
            </label>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="intellectualPropertiesCancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘æ ¡ä¼åˆä½œ -->
<div id="enterpriseCooperationsModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal-content" style="min-width:400px;max-width:800px;width:95vw;padding:16px 16px 8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="enterpriseCooperationsModalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢æ ¡ä¼åˆä½œ</h3>
            <button id="enterpriseCooperationsModalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        <form id="enterpriseCooperationsForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="enterpriseCooperationsId">
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>åˆä½œé¡¹ç›®æ ‡é¢˜</span>
                <input id="enterpriseCooperationsTitleInput" required placeholder="ä¾‹å¦‚ï¼šAIç®—æ³•ä¼˜åŒ–ä¸èŠ¯ç‰‡é€‚é…">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>é¡¹ç›®æè¿°</span>
                <textarea id="enterpriseCooperationsDescInput" rows="3" placeholder="åˆä½œé¡¹ç›®è¯¦ç»†æè¿°" required></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>åˆä½œä¼ä¸šåç§°</span>
                <input id="enterpriseCooperationsEnterpriseNameInput" required placeholder="ä¾‹å¦‚ï¼šåä¸ºæŠ€æœ¯æœ‰é™å…¬å¸">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>åˆä½œç±»åˆ«</span>
                <input id="enterpriseCooperationsCategoryInput" placeholder="ä¾‹å¦‚ï¼šæŠ€æœ¯ç ”å‘">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>å¼€å§‹æ—¶é—´</span>
                <input id="enterpriseCooperationsStartDateInput" type="date">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>ç»“æŸæ—¶é—´</span>
                <input id="enterpriseCooperationsEndDateInput" type="date">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>åˆä½œç»è´¹</span>
                <input id="enterpriseCooperationsBudgetInput" placeholder="ä¾‹å¦‚ï¼šÂ¥1,500,000">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>é¡¹ç›®è´Ÿè´£äºº</span>
                <input id="enterpriseCooperationsLeaderInput" placeholder="ä¾‹å¦‚ï¼šç‹æ•™æˆ">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>çŠ¶æ€</span>
                <select id="enterpriseCooperationsStatusInput" required>
                    <option value="active">å¯ç”¨</option>
                    <option value="inactive">ç¦ç”¨</option>
                </select>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>åˆä½œæˆæœ</span>
                <textarea id="enterpriseCooperationsAchievementInput" rows="3" placeholder="åˆä½œå–å¾—çš„æˆæœå’Œå½±å“"></textarea>
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;">
                <span>ä¼ä¸šLogo URL</span>
                <input id="enterpriseCooperationsEnterpriseLogoInput" placeholder="ä¼ä¸šlogoå›¾ç‰‡URL">
            </label>
            <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                <span>é¡¹ç›®å›¾ç‰‡</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input id="enterpriseCooperationsImageInput" type="file" accept="image/*" style="display:none;">
                    <button type="button" id="enterpriseCooperationsImageBtn" class="btn" style="padding:8px 12px;font-size:14px;">ğŸ“ é€‰æ‹©å›¾ç‰‡</button>
                    <span id="enterpriseCooperationsImageName" style="font-size:12px;color:#666;"></span>
                </div>
                <input id="enterpriseCooperationsImageUrlInput" placeholder="æˆ–è¾“å…¥å›¾ç‰‡URL" style="margin-top:4px;">
            </label>
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="enterpriseCooperationsCancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<script>
// æ¶ˆæ¯æç¤ºç³»ç»Ÿ
function showMessage(text, type = 'info') {
    const container = document.getElementById('messageContainer');
    const message = document.createElement('div');
    message.className = `message ${type}`;
    
    const iconMap = {
        success: 'âœ“',
        error: 'âœ•',
        info: 'â“˜'
    };
    
    message.innerHTML = `
        <span class="message-icon">${iconMap[type] || 'â“˜'}</span>
        <span>${text}</span>
    `;
    
    container.appendChild(message);
    
    // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => message.classList.add('show'), 100);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        message.classList.remove('show');
        setTimeout(() => {
            if (message.parentNode) {
                message.parentNode.removeChild(message);
            }
        }, 300);
    }, 3000);
}

// ============ é¡¹ç›®ç»Ÿè®¡ç®¡ç† ============
(function(){
    const tbody = document.getElementById('statsTbody');
    const addBtn = document.getElementById('addStatsBtn');
    const modal = document.getElementById('statsModal');
    const modalClose = document.getElementById('statsModalClose');
    const cancelBtn = document.getElementById('statsCancelBtn');
    const form = document.getElementById('statsForm');
    const modalTitle = document.getElementById('statsModalTitle');
    const searchInput = document.getElementById('statsSearchInput');

    const idInput = document.getElementById('statsId');
    const nameInput = document.getElementById('statsNameInput');
    const valueInput = document.getElementById('statsValueInput');
    const iconInput = document.getElementById('statsIconInput');
    const descInput = document.getElementById('statsDescInput');
    const statusInput = document.getElementById('statsStatusInput');

    let rawData = [];
    let sortableInstance = null;
    let hasUnsavedChanges = false;

    // åˆå§‹åŒ–æ‹–æ‹½æ’åº
    function initSortable() {
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        
        sortableInstance = new Sortable(tbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                hasUnsavedChanges = true;
                document.getElementById('saveStatsOrderBtn').style.display = 'inline-block';
            }
        });
    }

    // ä¿å­˜æ’åº
    async function saveOrder() {
        const rows = tbody.querySelectorAll('tr[data-id]');
        const statsIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        try {
            const res = await fetch(getApiUrl('/api/innovation/stats/reorder'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stats_ids: statsIds })
            });
            
            if (res.ok) {
                hasUnsavedChanges = false;
                document.getElementById('saveStatsOrderBtn').style.display = 'none';
                showMessage('é¡¹ç›®ç»Ÿè®¡æ’åºå·²ä¿å­˜', 'success');
                await fetchData();
                
                // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µæ•°æ®å·²æ›´æ–°
                localStorage.setItem('innovation_data_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }

    function statusBadge(text){
        const map = { 'active': 'status-active', 'inactive': 'status-inactive' };
        const cls = map[text] || 'status-inactive';
        const displayText = text === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨';
        return `<span class="status ${cls}">${displayText}</span>`;
    }

    function openModal(editData){
        modal.style.display = 'flex';
        if(editData){
            modalTitle.textContent = 'ç¼–è¾‘é¡¹ç›®ç»Ÿè®¡';
            idInput.value = editData.id;
            nameInput.value = editData.name || '';
            valueInput.value = editData.value || 0;
            iconInput.value = editData.icon || '';
            descInput.value = editData.description || '';
            statusInput.value = editData.status || 'active';
        }else{
            modalTitle.textContent = 'æ–°å¢é¡¹ç›®ç»Ÿè®¡';
            form.reset();
            idInput.value = '';
            statusInput.value = 'active';
        }
    }
    function closeModal(){ modal.style.display = 'none'; }

    function render(data){
        tbody.innerHTML = data.map(item => `
            <tr class="sortable-item" data-id="${item.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>${item.name || ''}</td>
                <td>${item.value || 0}</td>
                <td><i class="fa ${item.icon || ''}"></i> ${item.icon || ''}</td>
                <td>${item.description || ''}</td>
                <td>${statusBadge(item.status || '')}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${item.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${item.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        initSortable();
    }

    async function fetchData(){
        try {
            const res = await fetch(getApiUrl('/api/innovation/stats'));
            rawData = await res.json();
            applyFilter();
        } catch (e) {
            console.error(e);
            showMessage('æ•°æ®åŠ è½½å¤±è´¥', 'error');
        }
    }

    function applyFilter(){
        const kw = (searchInput.value || '').trim().toLowerCase();
        console.log('ğŸ” é¡¹ç›®ç»Ÿè®¡æœç´¢å…³é”®è¯:', kw);
        const filtered = rawData.filter(item => {
            const nameMatch = !kw || (item.name && item.name.toLowerCase().includes(kw));
            const descMatch = !kw || (item.description && item.description.toLowerCase().includes(kw));
            return nameMatch || descMatch;
        });
        console.log('ğŸ“‹ è¿‡æ»¤åçš„é¡¹ç›®ç»Ÿè®¡æ•°æ®:', filtered);
        render(filtered);
    }

    tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        const current = rawData.find(x => x.id === id);
        if(action === 'edit'){
            openModal(current);
        }
        if(action === 'delete'){
            if(!confirm('ç¡®è®¤åˆ é™¤è¯¥ç»Ÿè®¡é¡¹ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const res = await fetch(`/api/innovation/stats/${id}`, { method: 'DELETE' });
                if(res.ok){ 
                    await fetchData(); 
                    showMessage('ç»Ÿè®¡é¡¹åˆ é™¤æˆåŠŸ', 'success');
                    
                    // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µæ•°æ®å·²æ›´æ–°
                    localStorage.setItem('innovation_data_updated', Date.now().toString());
                    setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
                } else {
                    const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                    showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                console.error(e);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }
    });

    addBtn.addEventListener('click', () => openModal());
    modalClose.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!nameInput.value.trim()) {
            showMessage('è¯·å¡«å†™ç»Ÿè®¡é¡¹åç§°', 'error');
            nameInput.focus();
            return;
        }
        
        const payload = {
            name: nameInput.value.trim(),
            value: parseInt(valueInput.value) || 0,
            icon: iconInput.value.trim(),
            description: descInput.value.trim(),
            status: statusInput.value
        };
        const id = idInput.value;
        const isEdit = !!id;
        
        try {
            const res = await fetch(isEdit ? `/api/innovation/stats/${id}` : '/api/innovation/stats', {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if(res.ok){
                closeModal();
                await fetchData();
                showMessage(isEdit ? 'ç»Ÿè®¡é¡¹æ›´æ–°æˆåŠŸ' : 'ç»Ÿè®¡é¡¹æ·»åŠ æˆåŠŸ', 'success');
                
                // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µæ•°æ®å·²æ›´æ–°
                localStorage.setItem('innovation_data_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
            }else{
                const err = await res.json().catch(()=>({error:'æäº¤å¤±è´¥'}));
                showMessage(err.error || 'æäº¤å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œæäº¤å¤±è´¥', 'error');
        }
    });

    // ç›´æ¥ç»‘å®šæœç´¢äº‹ä»¶ç›‘å¬å™¨
    searchInput.addEventListener('input', () => {
        console.log('ğŸ” é¡¹ç›®ç»Ÿè®¡æœç´¢è¾“å…¥:', searchInput.value);
        applyFilter();
    });
    
    const saveStatsOrderBtn = document.getElementById('saveStatsOrderBtn');
    if (saveStatsOrderBtn) {
        saveStatsOrderBtn.addEventListener('click', saveOrder);
        console.log('âœ… é¡¹ç›®ç»Ÿè®¡ä¿å­˜æ’åºæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
    }

    fetchData();
})();



// ============ æˆæœä¸è£èª‰ç®¡ç† ============
(function(){
    const tbody = document.getElementById('achievementsTbody');
    const addBtn = document.getElementById('addAchievementBtn');
    const modal = document.getElementById('achievementsModal');
    const modalClose = document.getElementById('achievementsModalClose');
    const cancelBtn = document.getElementById('achievementsCancelBtn');
    const form = document.getElementById('achievementsForm');
    const modalTitle = document.getElementById('achievementsModalTitle');
    const searchInput = document.getElementById('achievementsSearchInput');
    const typeFilter = document.getElementById('typeFilter');

    const idInput = document.getElementById('achievementsId');
    const titleInput = document.getElementById('achievementsTitleInput');
    const typeInput = document.getElementById('achievementsTypeInput');
    const dateInput = document.getElementById('achievementsDateInput');
    const iconInput = document.getElementById('achievementsIconInput');
    const descInput = document.getElementById('achievementsDescInput');
    const statusInput = document.getElementById('achievementsStatusInput');
    const extraInput = document.getElementById('achievementsExtraInput');

    let rawData = [];
    let sortableInstance = null;
    let hasUnsavedChanges = false;

    function initSortable() {
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        
        sortableInstance = new Sortable(tbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                hasUnsavedChanges = true;
                document.getElementById('saveAchievementsOrderBtn').style.display = 'inline-block';
            }
        });
    }

    async function saveOrder() {
        const rows = tbody.querySelectorAll('tr[data-id]');
        const achievementIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        try {
            const res = await fetch(getApiUrl('/api/innovation/achievements/reorder'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ achievement_ids: achievementIds })
            });
            
            if (res.ok) {
                hasUnsavedChanges = false;
                document.getElementById('saveAchievementsOrderBtn').style.display = 'none';
                showMessage('æˆæœè£èª‰æ’åºå·²ä¿å­˜', 'success');
                await fetchData();
                
                // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µæ•°æ®å·²æ›´æ–°
                localStorage.setItem('innovation_data_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }

    function statusBadge(text){
        const map = { 'active': 'status-active', 'inactive': 'status-inactive' };
        const cls = map[text] || 'status-inactive';
        const displayText = text === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨';
        return `<span class="status ${cls}">${displayText}</span>`;
    }

    function typeDisplay(text) {
        const map = { 'award': 'é¡¹ç›®è·å¥–', 'patent': 'çŸ¥è¯†äº§æƒ' };
        return map[text] || text;
    }

    function truncate(text, n){
        const s = (text||'').trim();
        return s.length > n ? (s.slice(0, n) + '...') : s;
    }

    function openModal(editData){
        modal.style.display = 'flex';
        if(editData){
            modalTitle.textContent = 'ç¼–è¾‘æˆæœä¸è£èª‰';
            idInput.value = editData.id;
            titleInput.value = editData.title || '';
            typeInput.value = editData.type || 'award';
            dateInput.value = editData.date || '';
            iconInput.value = editData.icon || '';
            descInput.value = editData.description || '';
            statusInput.value = editData.status || 'active';
            extraInput.value = editData.extra_data ? JSON.stringify(editData.extra_data, null, 2) : '';
        }else{
            modalTitle.textContent = 'æ–°å¢æˆæœä¸è£èª‰';
            form.reset();
            idInput.value = '';
            typeInput.value = 'award';
            statusInput.value = 'active';
        }
    }
    function closeModal(){ modal.style.display = 'none'; }

    function render(data){
        tbody.innerHTML = data.map(item => `
            <tr class="sortable-item" data-id="${item.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>${item.title || ''}</td>
                <td>${typeDisplay(item.type)}</td>
                <td title="${(item.description||'').replace(/\"/g,'&quot;')}">${truncate(item.description, 30)}</td>
                <td>${item.date || ''}</td>
                <td>${statusBadge(item.status || '')}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${item.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${item.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        initSortable();
    }

    async function fetchData(){
        try {
            const res = await fetch(getApiUrl('/api/innovation/achievements'));
            rawData = await res.json();
            applyFilter();
        } catch (e) {
            console.error(e);
            showMessage('æ•°æ®åŠ è½½å¤±è´¥', 'error');
        }
    }

    function applyFilter(){
        const kw = (searchInput.value || '').trim().toLowerCase();
        const type = typeFilter.value || '';
        console.log('ğŸ” æˆæœè£èª‰æœç´¢æ¡ä»¶:', { kw, type });
        const filtered = rawData.filter(item => {
            const titleMatch = !kw || (item.title && item.title.toLowerCase().includes(kw));
            const descMatch = !kw || (item.description && item.description.toLowerCase().includes(kw));
            const typeMatch = !type || item.type === type;
            return (titleMatch || descMatch) && typeMatch;
        });
        console.log('ğŸ“‹ è¿‡æ»¤åçš„æˆæœè£èª‰æ•°æ®:', filtered);
        render(filtered);
    }

    tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        const current = rawData.find(x => x.id === id);
        if(action === 'edit'){
            openModal(current);
        }
        if(action === 'delete'){
            if(!confirm('ç¡®è®¤åˆ é™¤è¯¥æˆæœï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const res = await fetch(`/api/innovation/achievements/${id}`, { method: 'DELETE' });
                if(res.ok){ 
                    await fetchData(); 
                    showMessage('æˆæœåˆ é™¤æˆåŠŸ', 'success');
                    
                    // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µæ•°æ®å·²æ›´æ–°
                    localStorage.setItem('innovation_data_updated', Date.now().toString());
                    setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
                } else {
                    const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                    showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                console.error(e);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }
    });

    addBtn.addEventListener('click', () => openModal());
    modalClose.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!titleInput.value.trim()) {
            showMessage('è¯·å¡«å†™æˆæœæ ‡é¢˜', 'error');
            titleInput.focus();
            return;
        }
        
        if (!descInput.value.trim()) {
            showMessage('è¯·å¡«å†™æˆæœæè¿°', 'error');
            descInput.focus();
            return;
        }

        let extraData = null;
        if (extraInput.value.trim()) {
            try {
                extraData = JSON.parse(extraInput.value.trim());
            } catch (e) {
                showMessage('æ‰©å±•æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„JSONæ ¼å¼', 'error');
                extraInput.focus();
                return;
            }
        }
        
        const payload = {
            title: titleInput.value.trim(),
            type: typeInput.value,
            description: descInput.value.trim(),
            date: dateInput.value || null,
            icon: iconInput.value.trim(),
            status: statusInput.value,
            extra_data: extraData
        };
        const id = idInput.value;
        const isEdit = !!id;
        
        try {
            const res = await fetch(isEdit ? `/api/innovation/achievements/${id}` : '/api/innovation/achievements', {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if(res.ok){
                closeModal();
                await fetchData();
                showMessage(isEdit ? 'æˆæœæ›´æ–°æˆåŠŸ' : 'æˆæœæ·»åŠ æˆåŠŸ', 'success');
                
                // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µæ•°æ®å·²æ›´æ–°
                localStorage.setItem('innovation_data_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
            }else{
                const err = await res.json().catch(()=>({error:'æäº¤å¤±è´¥'}));
                showMessage(err.error || 'æäº¤å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œæäº¤å¤±è´¥', 'error');
        }
    });

    // ç›´æ¥ç»‘å®šæœç´¢å’Œç­›é€‰äº‹ä»¶ç›‘å¬å™¨
    searchInput.addEventListener('input', () => {
        console.log('ğŸ” æˆæœè£èª‰æœç´¢è¾“å…¥:', searchInput.value);
        applyFilter();
    });
    
    typeFilter.addEventListener('change', () => {
        console.log('ğŸ” æˆæœè£èª‰ç±»å‹ç­›é€‰:', typeFilter.value);
        applyFilter();
    });
    
    const saveAchievementsOrderBtn = document.getElementById('saveAchievementsOrderBtn');
    if (saveAchievementsOrderBtn) {
        saveAchievementsOrderBtn.addEventListener('click', saveOrder);
        console.log('âœ… æˆæœè£èª‰ä¿å­˜æ’åºæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
    }

    fetchData();
})();

// ============ è½®æ’­å›¾ç®¡ç† ============
(function(){
    console.log('ğŸ–¼ï¸ è½®æ’­å›¾ç®¡ç†æ¨¡å—å¼€å§‹åˆå§‹åŒ–...');
    
    const tbody = document.getElementById('carouselTbody');
    const addBtn = document.getElementById('addCarouselBtn');
    const modal = document.getElementById('carouselModal');
    const modalClose = document.getElementById('carouselModalClose');
    const cancelBtn = document.getElementById('carouselCancelBtn');
    const form = document.getElementById('carouselForm');
    const modalTitle = document.getElementById('carouselModalTitle');
    const searchInput = document.getElementById('carouselSearchInput');
    
    console.log('è½®æ’­å›¾å…ƒç´ æ£€æŸ¥:', {
        tbody: !!tbody,
        addBtn: !!addBtn,
        modal: !!modal,
        searchInput: !!searchInput
    });

    const idInput = document.getElementById('carouselId');
    const titleInput = document.getElementById('carouselTitleInput');
    const descInput = document.getElementById('carouselDescInput');
    const imageInput = document.getElementById('carouselImageInput');
    const imageBtn = document.getElementById('carouselImageBtn');
    const imageName = document.getElementById('carouselImageName');
    const imageUrlInput = document.getElementById('carouselImageUrlInput');
    const linkInput = document.getElementById('carouselLinkInput');
    const textPositionInput = document.getElementById('carouselTextPositionInput');
    const opacityInput = document.getElementById('carouselOpacityInput');
    const opacityValue = document.getElementById('carouselOpacityValue');
    const statusInput = document.getElementById('carouselStatusInput');
    
    // é¢„è§ˆç›¸å…³å…ƒç´ 
    const previewContainer = document.getElementById('carouselPreview');
    const previewImg = document.getElementById('carouselPreviewImg');
    const previewOverlay = document.getElementById('carouselPreviewOverlay');
    const previewText = document.getElementById('carouselPreviewText');
    const previewTitle = document.getElementById('carouselPreviewTitle');
    const previewDesc = document.getElementById('carouselPreviewDesc');

    let rawData = [];
    let sortableInstance = null;
    let hasUnsavedChanges = false;
    let uploadedImageUrl = null;

    function initSortable() {
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        
        sortableInstance = new Sortable(tbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                hasUnsavedChanges = true;
                document.getElementById('saveCarouselOrderBtn').style.display = 'inline-block';
            }
        });
    }

    async function saveOrder() {
        const rows = tbody.querySelectorAll('tr[data-id]');
        const carouselIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        try {
            const res = await fetch(getApiUrl('/api/innovation/carousel/reorder'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ carousel_ids: carouselIds })
            });
            
            if (res.ok) {
                hasUnsavedChanges = false;
                document.getElementById('saveCarouselOrderBtn').style.display = 'none';
                showMessage('è½®æ’­å›¾æ’åºå·²ä¿å­˜', 'success');
                await fetchData();
                
                // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µæ•°æ®å·²æ›´æ–°
                localStorage.setItem('innovation_data_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
                
                // é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°è½®æ’­å›¾æ•°æ®
                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: 'INNOVATION_CAROUSEL_UPDATED',
                            timestamp: Date.now()
                        }, '*');
                    }
                } catch (e) {
                    console.log('æ— æ³•é€šçŸ¥å‰ç«¯é¡µé¢');
                }
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }

    function statusBadge(text){
        const map = { 'active': 'status-active', 'inactive': 'status-inactive' };
        const cls = map[text] || 'status-inactive';
        const displayText = text === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨';
        return `<span class="status ${cls}">${displayText}</span>`;
    }

    function textPositionDisplay(position) {
        const map = { 
            'bottom-left': 'å·¦ä¸‹è§’', 
            'bottom-right': 'å³ä¸‹è§’', 
            'center': 'å±…ä¸­' 
        };
        return map[position] || position;
    }

    function truncate(text, n){
        const s = (text||'').trim();
        return s.length > n ? (s.slice(0, n) + '...') : s;
    }

    function updatePreview() {
        const title = titleInput.value.trim();
        const desc = descInput.value.trim();
        const opacity = parseFloat(opacityInput.value);
        const textPosition = textPositionInput.value;
        const imageUrl = uploadedImageUrl || imageUrlInput.value.trim();

        if (title || desc || imageUrl) {
            previewContainer.style.display = 'block';
            
            if (imageUrl) {
                previewImg.src = imageUrl;
                previewImg.style.display = 'block';
            } else {
                previewImg.style.display = 'none';
            }
            
            previewTitle.textContent = title || 'æ ‡é¢˜é¢„è§ˆ';
            previewDesc.textContent = desc || 'æè¿°é¢„è§ˆ';
            previewOverlay.style.background = `rgba(0,0,0,${opacity})`;
            
            // è°ƒæ•´æ–‡å­—ä½ç½®
            previewOverlay.style.alignItems = textPosition === 'center' ? 'center' : 'end';
            previewOverlay.style.justifyContent = textPosition === 'bottom-right' ? 'end' : 
                                               textPosition === 'center' ? 'center' : 'start';
            previewText.style.maxWidth = textPosition === 'center' ? '80%' : '60%';
            previewText.style.textAlign = textPosition === 'center' ? 'center' : 'left';
        } else {
            previewContainer.style.display = 'none';
        }
    }

    // å›¾ç‰‡ä¸Šä¼ å¤„ç†
    imageBtn.addEventListener('click', () => imageInput.click());
    
    imageInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        imageName.textContent = 'ä¸Šä¼ ä¸­...';
        imageBtn.disabled = true;
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            const res = await fetch(getApiUrl('/api/innovation/carousel/upload'), {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                const result = await res.json();
                uploadedImageUrl = result.url;
                imageName.textContent = file.name;
                imageUrlInput.value = result.url;
                showMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                updatePreview();
            } else {
                const err = await res.json().catch(() => ({error: 'ä¸Šä¼ å¤±è´¥'}));
                showMessage(err.error || 'ä¸Šä¼ å¤±è´¥', 'error');
                imageName.textContent = '';
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥', 'error');
            imageName.textContent = '';
        } finally {
            imageBtn.disabled = false;
        }
    });

    // ç›‘å¬é¢„è§ˆæ›´æ–°
    titleInput.addEventListener('input', updatePreview);
    descInput.addEventListener('input', updatePreview);
    imageUrlInput.addEventListener('input', updatePreview);
    textPositionInput.addEventListener('change', updatePreview);
    opacityInput.addEventListener('input', () => {
        opacityValue.textContent = opacityInput.value;
        updatePreview();
    });

    function openModal(editData){
        modal.style.display = 'flex';
        uploadedImageUrl = null;
        
        if(editData){
            modalTitle.textContent = 'ç¼–è¾‘è½®æ’­å›¾';
            idInput.value = editData.id;
            titleInput.value = editData.title || '';
            descInput.value = editData.description || '';
            imageUrlInput.value = editData.image_display_url || editData.image_url || '';
            linkInput.value = editData.link_url || '';
            textPositionInput.value = editData.text_position || 'bottom-left';
            opacityInput.value = editData.overlay_opacity || 0.3;
            opacityValue.textContent = editData.overlay_opacity || 0.3;
            statusInput.value = editData.status || 'active';
            imageName.textContent = editData.image_file || '';
        } else {
            modalTitle.textContent = 'æ–°å¢è½®æ’­å›¾';
            form.reset();
            idInput.value = '';
            textPositionInput.value = 'bottom-left';
            opacityInput.value = 0.3;
            opacityValue.textContent = '0.3';
            statusInput.value = 'active';
            imageName.textContent = '';
        }
        
        updatePreview();
    }
    
    function closeModal() { 
        modal.style.display = 'none'; 
        previewContainer.style.display = 'none';
        uploadedImageUrl = null;
    }

    function render(data){
        console.log('ğŸ¨ æ¸²æŸ“è½®æ’­å›¾åˆ—è¡¨ï¼Œæ•°æ®æ¡æ•°:', data.length);
        tbody.innerHTML = data.map(item => `
            <tr class="sortable-item" data-id="${item.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>
                    ${item.image_display_url ? 
                        `<img src="${item.image_display_url}" style="width:60px;height:40px;object-fit:cover;border-radius:4px;">` : 
                        '<span style="color:#999;">æ— å›¾ç‰‡</span>'
                    }
                </td>
                <td>${item.title || ''}</td>
                <td title="${(item.description||'').replace(/\"/g,'&quot;')}">${truncate(item.description, 30)}</td>
                <td>${textPositionDisplay(item.text_position)}</td>
                <td>${statusBadge(item.status || '')}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${item.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${item.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        console.log('ğŸ“ è½®æ’­å›¾è¡¨æ ¼HTMLå·²æ›´æ–°');
        initSortable();
    }

    async function fetchData(){
        try {
            console.log('ğŸ”„ å¼€å§‹è·å–è½®æ’­å›¾æ•°æ®...');
            const res = await fetch(getApiUrl('/api/innovation/carousel'));
            rawData = await res.json();
            console.log('ğŸ“Š è½®æ’­å›¾æ•°æ®:', rawData);
            applyFilter();
        } catch (e) {
            console.error('âŒ è½®æ’­å›¾æ•°æ®åŠ è½½å¤±è´¥:', e);
            showMessage('æ•°æ®åŠ è½½å¤±è´¥', 'error');
        }
    }

    function applyFilter(){
        const kw = (searchInput.value || '').trim();
        const filtered = rawData.filter(item => {
            const hitKw = !kw || [item.title, item.description].some(v => (v||'').includes(kw));
            return hitKw;
        });
        render(filtered);
    }

    tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        const current = rawData.find(x => x.id === id);
        if(action === 'edit'){
            openModal(current);
        }
        if(action === 'delete'){
            if(!confirm('ç¡®è®¤åˆ é™¤è¯¥è½®æ’­å›¾ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const res = await fetch(`/api/innovation/carousel/${id}`, { method: 'DELETE' });
                if(res.ok){ 
                    await fetchData(); 
                    showMessage('è½®æ’­å›¾åˆ é™¤æˆåŠŸ', 'success');
                    
                    // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µæ•°æ®å·²æ›´æ–°
                    localStorage.setItem('innovation_data_updated', Date.now().toString());
                    setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
                    
                    // é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°è½®æ’­å›¾æ•°æ®
                    try {
                        if (window.opener && !window.opener.closed) {
                            window.opener.postMessage({
                                type: 'INNOVATION_CAROUSEL_UPDATED',
                                timestamp: Date.now()
                            }, '*');
                        }
                    } catch (e) {
                        console.log('æ— æ³•é€šçŸ¥å‰ç«¯é¡µé¢');
                    }
                } else {
                    const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                    showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                console.error(e);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }
    });

    addBtn.addEventListener('click', () => openModal());
    modalClose.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!titleInput.value.trim()) {
            showMessage('è¯·å¡«å†™è½®æ’­å›¾æ ‡é¢˜', 'error');
            titleInput.focus();
            return;
        }
        
        if (!descInput.value.trim()) {
            showMessage('è¯·å¡«å†™è½®æ’­å›¾æè¿°', 'error');
            descInput.focus();
            return;
        }

        const imageUrl = uploadedImageUrl || imageUrlInput.value.trim();
        if (!imageUrl) {
            showMessage('è¯·é€‰æ‹©å›¾ç‰‡æˆ–è¾“å…¥å›¾ç‰‡URL', 'error');
            return;
        }
        
        const payload = {
            title: titleInput.value.trim(),
            description: descInput.value.trim(),
            image_url: imageUrl,
            link_url: linkInput.value.trim(),
            text_position: textPositionInput.value,
            overlay_opacity: parseFloat(opacityInput.value),
            status: statusInput.value
        };
        const id = idInput.value;
        const isEdit = !!id;
        
        try {
            const res = await fetch(isEdit ? `/api/innovation/carousel/${id}` : '/api/innovation/carousel', {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if(res.ok){
                closeModal();
                await fetchData();
                showMessage(isEdit ? 'è½®æ’­å›¾æ›´æ–°æˆåŠŸ' : 'è½®æ’­å›¾æ·»åŠ æˆåŠŸ', 'success');
                
                // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µæ•°æ®å·²æ›´æ–°
                localStorage.setItem('innovation_data_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
                
                // é€šçŸ¥å‰ç«¯é¡µé¢æ›´æ–°è½®æ’­å›¾æ•°æ®
                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: 'INNOVATION_CAROUSEL_UPDATED',
                            timestamp: Date.now()
                        }, '*');
                    }
                } catch (e) {
                    console.log('æ— æ³•é€šçŸ¥å‰ç«¯é¡µé¢');
                }
            }else{
                const err = await res.json().catch(()=>({error:'æäº¤å¤±è´¥'}));
                showMessage(err.error || 'æäº¤å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œæäº¤å¤±è´¥', 'error');
        }
    });

    // ç›´æ¥ç»‘å®šæœç´¢äº‹ä»¶ç›‘å¬å™¨
    searchInput.addEventListener('input', () => {
        console.log('ğŸ” è½®æ’­å›¾æœç´¢è¾“å…¥:', searchInput.value);
        applyFilter();
    });
    
    const saveCarouselOrderBtn = document.getElementById('saveCarouselOrderBtn');
    if (saveCarouselOrderBtn) {
        saveCarouselOrderBtn.addEventListener('click', saveOrder);
        console.log('âœ… è½®æ’­å›¾ä¿å­˜æ’åºæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
    }

    fetchData();
})();

    // é¡µé¢åŠ è½½å®Œæˆåçš„è°ƒè¯•ä¿¡æ¯
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ” é¡µé¢DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–ç§‘åˆ›ç®¡ç†é¡µé¢...');
    
    // ç§»é™¤è°ƒè¯•ä»£ç ï¼Œä¸“æ³¨äºåŠŸèƒ½ä¿®å¤
    console.log('ğŸ“Š å¼€å§‹ä¿®å¤ä¸‰ä¸ªæ¨¡å—çš„åŠŸèƒ½é—®é¢˜...');
    
    // åˆå§‹åŒ–æµ‹è¯•ä¿¡æ¯
    updateTestInfo();
    
    // ç®€åŒ–åˆå§‹åŒ–ï¼Œç›´æ¥ç»‘å®šäº‹ä»¶å’Œè·å–æ•°æ®
    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–ä¸‰ä¸ªæ¨¡å—...');
    
    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
    initThreeModulesEvents();
    
    // è·å–åˆå§‹æ•°æ®
    Promise.all([
        fetchTrainingProjectsData(),
        fetchIntellectualPropertiesData(),
        fetchEnterpriseCooperationsData()
    ]).then(() => {
        console.log('âœ… æ‰€æœ‰æ¨¡å—æ•°æ®åˆå§‹åŒ–å®Œæˆ');
        showMessage('ç§‘åˆ›ç®¡ç†é¡µé¢åŠ è½½å®Œæˆ', 'success');
    }).catch(e => {
        console.error('âŒ æ¨¡å—æ•°æ®åˆå§‹åŒ–å¤±è´¥:', e);
        showMessage('éƒ¨åˆ†æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    });
    
    // Socket.IOå®æ—¶åˆ·æ–°åŠŸèƒ½
    function initSocketIOFeatures() {
        console.log('ğŸ”Œ åˆå§‹åŒ–Socket.IOåŠŸèƒ½...');
        
        // è®¾ç½®å½“å‰é¡µé¢
        if (typeof setCurrentPage === 'function') {
            setCurrentPage('innovation');
        }
        
        // åˆå§‹åŒ–Socket.IOè¿æ¥
        if (typeof initSocketIO === 'function') {
            initSocketIO();
        }
        
        // ç›‘å¬é¡µé¢åˆ·æ–°äº‹ä»¶
        if (typeof socket !== 'undefined' && socket) {
            socket.on('page_refresh', function(data) {
                console.log('æ”¶åˆ°ç§‘åˆ›æ•°æ®æ›´æ–°é€šçŸ¥:', data);
                
                // å¦‚æœæ˜¯ç§‘åˆ›ç›¸å…³æ•°æ®æ›´æ–°ï¼Œé‡æ–°åŠ è½½å†…å®¹
                if (data.page === 'innovation' || data.page === 'all') {
                    console.log('åˆ·æ–°ç§‘åˆ›ç®¡ç†å†…å®¹...');
                    // é‡æ–°è·å–æ‰€æœ‰æ•°æ®
                    Promise.all([
                        fetchTrainingProjectsData(),
                        fetchIntellectualPropertiesData(),
                        fetchEnterpriseCooperationsData()
                    ]).then(() => {
                        console.log('âœ… æ•°æ®åˆ·æ–°å®Œæˆ');
                    }).catch(e => {
                        console.error('âŒ æ•°æ®åˆ·æ–°å¤±è´¥:', e);
                    });
                }
            });
        }
        
        // ç›‘å¬å­˜å‚¨å˜åŒ–äº‹ä»¶ï¼ˆå¤šæ ‡ç­¾é¡µåŒæ­¥ï¼‰
        window.addEventListener('storage', (e) => {
            if (e.key === 'innovation_data_updated') {
                console.log('æ£€æµ‹åˆ°å…¶ä»–æ ‡ç­¾é¡µæ•°æ®æ›´æ–°ï¼Œåˆ·æ–°å½“å‰é¡µé¢æ•°æ®');
                // é‡æ–°è·å–æ‰€æœ‰æ•°æ®
                Promise.all([
                    fetchTrainingProjectsData(),
                    fetchIntellectualPropertiesData(),
                    fetchEnterpriseCooperationsData()
                ]).then(() => {
                    console.log('âœ… æ•°æ®åŒæ­¥å®Œæˆ');
                }).catch(e => {
                    console.error('âŒ æ•°æ®åŒæ­¥å¤±è´¥:', e);
                });
            }
        });
        
        console.log('ç§‘åˆ›ç®¡ç† - Socket.IOå®æ—¶åˆ·æ–°å·²åˆå§‹åŒ–');
        
        // æ·»åŠ æµ‹è¯•åŒºåŸŸ
        addTestArea();
    }
    
    // æ·»åŠ æµ‹è¯•åŒºåŸŸ
    function addTestArea() {
        const testArea = document.createElement('div');
        testArea.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 10000;
            max-width: 300px;
        `;
        
        testArea.innerHTML = `
            <div style="margin-bottom: 10px; font-weight: bold;">ğŸ§ª å®æ—¶åŒæ­¥æµ‹è¯•</div>
            <div>æœ€åæ›´æ–°: <span id="lastUpdateTime">-</span></div>
            <div>æ•°æ®çŠ¶æ€: <span id="dataStatus">æ­£å¸¸</span></div>
            <button id="testRefreshBtn" style="margin-top: 10px; padding: 5px 10px; background: #667eea; border: none; border-radius: 5px; color: white; cursor: pointer;">æµ‹è¯•åˆ·æ–°</button>
        `;
        
        document.body.appendChild(testArea);
        
        // æµ‹è¯•åˆ·æ–°æŒ‰é’®
        const testRefreshBtn = document.getElementById('testRefreshBtn');
        if (testRefreshBtn) {
            testRefreshBtn.addEventListener('click', () => {
                console.log('ğŸ§ª æ‰‹åŠ¨æµ‹è¯•æ•°æ®åˆ·æ–°...');
                updateTestInfo();
                
                // åˆ·æ–°æ‰€æœ‰æ•°æ®
                Promise.all([
                    fetchTrainingProjectsData(),
                    fetchIntellectualPropertiesData(),
                    fetchEnterpriseCooperationsData()
                ]).then(() => {
                    console.log('âœ… æµ‹è¯•åˆ·æ–°å®Œæˆ');
                    showMessage('æµ‹è¯•åˆ·æ–°å®Œæˆ', 'success');
                }).catch(e => {
                    console.error('âŒ æµ‹è¯•åˆ·æ–°å¤±è´¥:', e);
                    showMessage('æµ‹è¯•åˆ·æ–°å¤±è´¥', 'error');
                });
            });
        }
        
        // ç›‘å¬æ•°æ®æ›´æ–°
        window.addEventListener('storage', (e) => {
            if (e.key === 'innovation_data_updated') {
                console.log('ğŸ§ª æ£€æµ‹åˆ°æ•°æ®æ›´æ–°äº‹ä»¶');
                updateTestInfo();
            }
        });
        
        // åˆå§‹åŒ–æµ‹è¯•ä¿¡æ¯
        updateTestInfo();
    }
    
    // ============ å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šè®­ç»ƒè®¡åˆ’ç®¡ç† ============
    
    // æ•°æ®å˜é‡
    let trainingProjectsData = [];
    let trainingProjectsSortable = null;
    let trainingProjectsHasUnsavedChanges = false;
    let trainingProjectsUploadedImageUrl = null;
    let trainingProjectsSubmitting = false; // é˜²é‡å¤æäº¤æ ‡å¿—
    
    // è¾…åŠ©å‡½æ•°
    function openTrainingProjectModal() {
        document.getElementById('trainingProjectsForm').reset();
        document.getElementById('trainingProjectsId').value = '';
        document.getElementById('trainingProjectsImageName').textContent = '';
        trainingProjectsUploadedImageUrl = null;
        
        document.getElementById('trainingProjectsCategoryInput').value = 'äººå·¥æ™ºèƒ½';
        document.getElementById('trainingProjectsProgressInput').value = '0';
        document.getElementById('trainingProjectsMembersCountInput').value = '0';
        document.getElementById('trainingProjectsStatusInput').value = 'active';
        
        document.getElementById('trainingProjectsModalTitle').textContent = 'æ–°å¢å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šè®­ç»ƒè®¡åˆ’';
        document.getElementById('trainingProjectsModal').style.display = 'flex';
    }
    
    function closeTrainingProjectModal() {
        document.getElementById('trainingProjectsModal').style.display = 'none';
    }
    
    // çŸ¥è¯†äº§æƒæ•°æ®å˜é‡
    let intellectualPropertiesData = [];
    let intellectualPropertiesSortable = null;
    let intellectualPropertiesHasUnsavedChanges = false;
    let intellectualPropertiesUploadedImageUrl = null;
    let intellectualPropertiesSubmitting = false; // é˜²é‡å¤æäº¤æ ‡å¿—
    
    // çŸ¥è¯†äº§æƒè¾…åŠ©å‡½æ•°
    function openIntellectualPropertyModal() {
        document.getElementById('intellectualPropertiesForm').reset();
        document.getElementById('intellectualPropertiesId').value = '';
        document.getElementById('intellectualPropertiesImageName').textContent = '';
        intellectualPropertiesUploadedImageUrl = null;
        
        document.getElementById('intellectualPropertiesTypeInput').value = 'patent';
        document.getElementById('intellectualPropertiesStatusInput').value = 'active';
        
        document.getElementById('intellectualPropertiesModalTitle').textContent = 'æ–°å¢çŸ¥è¯†äº§æƒ';
        document.getElementById('intellectualPropertiesModal').style.display = 'flex';
    }
    
    function closeIntellectualPropertyModal() {
        document.getElementById('intellectualPropertiesModal').style.display = 'none';
    }
    
    // æ ¡ä¼åˆä½œæ•°æ®å˜é‡
    let enterpriseCooperationsData = [];
    let enterpriseCooperationsSortable = null;
    let enterpriseCooperationsHasUnsavedChanges = false;
    let enterpriseCooperationsUploadedImageUrl = null;
    let enterpriseCooperationsSubmitting = false; // é˜²é‡å¤æäº¤æ ‡å¿—
    
    // æ ¡ä¼åˆä½œè¾…åŠ©å‡½æ•°
    function openEnterpriseCooperationModal() {
        document.getElementById('enterpriseCooperationsForm').reset();
        document.getElementById('enterpriseCooperationsId').value = '';
        document.getElementById('enterpriseCooperationsImageName').textContent = '';
        enterpriseCooperationsUploadedImageUrl = null;
        
        document.getElementById('enterpriseCooperationsStatusInput').value = 'active';
        
        document.getElementById('enterpriseCooperationsModalTitle').textContent = 'æ–°å¢æ ¡ä¼åˆä½œ';
        document.getElementById('enterpriseCooperationsModal').style.display = 'flex';
    }
    
    function closeEnterpriseCooperationModal() {
        document.getElementById('enterpriseCooperationsModal').style.display = 'none';
    }
    
    // è¡¨å•æäº¤å¤„ç†å‡½æ•°
    async function handleIntellectualPropertySubmit(e) {
        e.preventDefault();
        console.log('ğŸ“‹ çŸ¥è¯†äº§æƒè¡¨å•æäº¤...');
        
        const formData = {
            title: document.getElementById('intellectualPropertiesTitleInput').value,
            description: document.getElementById('intellectualPropertiesDescInput').value,
            type: document.getElementById('intellectualPropertiesTypeInput').value,
            category: document.getElementById('intellectualPropertiesCategoryInput').value,
            application_date: document.getElementById('intellectualPropertiesApplicationDateInput').value,
            grant_date: document.getElementById('intellectualPropertiesGrantDateInput').value,
            patent_number: document.getElementById('intellectualPropertiesPatentNumberInput').value,
            inventors: document.getElementById('intellectualPropertiesInventorsInput').value,
            status: document.getElementById('intellectualPropertiesStatusInput').value,
            image_url: intellectualPropertiesUploadedImageUrl || document.getElementById('intellectualPropertiesImageUrlInput').value
        };
        
        const id = document.getElementById('intellectualPropertiesId').value;
        const url = id ? `/api/innovation/intellectual-properties/${id}` : '/api/innovation/intellectual-properties';
        const method = id ? 'PUT' : 'POST';
        
        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            if (res.ok) {
                showMessage(id ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ', 'success');
                closeIntellectualPropertyModal();
                await fetchIntellectualPropertiesData();
                
                localStorage.setItem('innovation_data_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
            } else {
                const err = await res.json().catch(() => ({error: 'æ“ä½œå¤±è´¥'}));
                showMessage(err.error || 'æ“ä½œå¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œæ“ä½œå¤±è´¥', 'error');
        }
    }
    
    async function handleEnterpriseCooperationSubmit(e) {
        e.preventDefault();
        console.log('ğŸ¤ æ ¡ä¼åˆä½œè¡¨å•æäº¤...');
        
        const formData = {
            title: document.getElementById('enterpriseCooperationsTitleInput').value,
            description: document.getElementById('enterpriseCooperationsDescInput').value,
            enterprise_name: document.getElementById('enterpriseCooperationsEnterpriseNameInput').value,
            category: document.getElementById('enterpriseCooperationsCategoryInput').value,
            start_date: document.getElementById('enterpriseCooperationsStartDateInput').value,
            end_date: document.getElementById('enterpriseCooperationsEndDateInput').value,
            budget: document.getElementById('enterpriseCooperationsBudgetInput').value,
            leader: document.getElementById('enterpriseCooperationsLeaderInput').value,
            status: document.getElementById('enterpriseCooperationsStatusInput').value,
            achievement: document.getElementById('enterpriseCooperationsAchievementInput').value,
            enterprise_logo: document.getElementById('enterpriseCooperationsEnterpriseLogoInput').value,
            image_url: enterpriseCooperationsUploadedImageUrl || document.getElementById('enterpriseCooperationsImageUrlInput').value
        };
        
        const id = document.getElementById('enterpriseCooperationsId').value;
        const url = id ? `/api/innovation/enterprise-cooperations/${id}` : '/api/innovation/enterprise-cooperations';
        const method = id ? 'PUT' : 'POST';
        
        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            if (res.ok) {
                showMessage(id ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ', 'success');
                closeEnterpriseCooperationModal();
                await fetchEnterpriseCooperationsData();
                
                localStorage.setItem('innovation_data_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
            } else {
                const err = await res.json().catch(() => ({error: 'æ“ä½œå¤±è´¥'}));
                showMessage(err.error || 'æ“ä½œå¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œæ“ä½œå¤±è´¥', 'error');
        }
    }
    
    console.log('ğŸ“ è®­ç»ƒè®¡åˆ’ç®¡ç†æ¨¡å—åˆå§‹åŒ–...');
    
    // å·¥å…·å‡½æ•°
    function truncate(text, n) {
        const s = (text || '').trim();
        return s.length > n ? (s.slice(0, n) + '...') : s;
    }
    
    function statusBadge(text) {
        const map = { 'active': 'status-active', 'inactive': 'status-inactive' };
        const cls = map[text] || 'status-inactive';
        const displayText = text === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨';
        return `<span class="status ${cls}">${displayText}</span>`;
    }
    
    // åˆå§‹åŒ–è®­ç»ƒè®¡åˆ’æ’åº
    function initTrainingProjectsSortable() {
        const tbody = document.getElementById('trainingProjectsTbody');
        if (trainingProjectsSortable) {
            trainingProjectsSortable.destroy();
        }
        
        trainingProjectsSortable = new Sortable(tbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                console.log('ğŸ“ è®­ç»ƒè®¡åˆ’æ’åºå·²æ›´æ”¹');
                trainingProjectsHasUnsavedChanges = true;
                const saveBtn = document.getElementById('saveTrainingProjectsOrderBtn');
                if (saveBtn) {
                    saveBtn.style.display = 'inline-block';
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = 'pointer';
                }
                console.log('âœ… è®­ç»ƒè®¡åˆ’ä¿å­˜æ’åºæŒ‰é’®å·²å¯ç”¨');
            }
        });
    }
    
    // åˆå§‹åŒ–çŸ¥è¯†äº§æƒæ’åº
    function initIntellectualPropertiesSortable() {
        const tbody = document.getElementById('intellectualPropertiesTbody');
        if (intellectualPropertiesSortable) {
            intellectualPropertiesSortable.destroy();
        }
        
        intellectualPropertiesSortable = new Sortable(tbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                console.log('ğŸ“‹ çŸ¥è¯†äº§æƒæ’åºå·²æ›´æ”¹');
                intellectualPropertiesHasUnsavedChanges = true;
                const saveBtn = document.getElementById('saveIntellectualPropertiesOrderBtn');
                if (saveBtn) {
                    saveBtn.style.display = 'inline-block';
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = 'pointer';
                }
                console.log('âœ… çŸ¥è¯†äº§æƒä¿å­˜æ’åºæŒ‰é’®å·²å¯ç”¨');
            }
        });
    }
    
    // åˆå§‹åŒ–æ ¡ä¼åˆä½œæ’åº
    function initEnterpriseCooperationsSortable() {
        const tbody = document.getElementById('enterpriseCooperationsTbody');
        if (enterpriseCooperationsSortable) {
            enterpriseCooperationsSortable.destroy();
        }
        
        enterpriseCooperationsSortable = new Sortable(tbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                console.log('ğŸ¤ æ ¡ä¼åˆä½œæ’åºå·²æ›´æ”¹');
                enterpriseCooperationsHasUnsavedChanges = true;
                const saveBtn = document.getElementById('saveEnterpriseCooperationsOrderBtn');
                if (saveBtn) {
                    saveBtn.style.display = 'inline-block';
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = 'pointer';
                }
                console.log('âœ… æ ¡ä¼åˆä½œä¿å­˜æ’åºæŒ‰é’®å·²å¯ç”¨');
            }
        });
    }
    
    // è·å–è®­ç»ƒè®¡åˆ’æ•°æ®
    async function fetchTrainingProjectsData() {
        try {
            console.log('ğŸ”„ å¼€å§‹è·å–è®­ç»ƒè®¡åˆ’æ•°æ®...');
            const res = await fetch(getApiUrl('/api/innovation/training-projects'));
            console.log('ğŸ“¡ è®­ç»ƒè®¡åˆ’APIå“åº”çŠ¶æ€:', res.status);
            
            if (res.ok) {
                trainingProjectsData = await res.json();
                console.log('ğŸ“Š è®­ç»ƒè®¡åˆ’æ•°æ®:', trainingProjectsData);
                renderTrainingProjectsTable();
                initTrainingProjectsSortable();
                console.log('âœ… è®­ç»ƒè®¡åˆ’æ•°æ®è·å–æˆåŠŸ');
            } else {
                const errorText = await res.text();
                console.error('âŒ è·å–è®­ç»ƒè®¡åˆ’æ•°æ®å¤±è´¥:', errorText);
                showMessage('è·å–è®­ç»ƒè®¡åˆ’æ•°æ®å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error('âŒ è®­ç»ƒè®¡åˆ’æ•°æ®è·å–å¼‚å¸¸:', e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œè·å–æ•°æ®å¤±è´¥', 'error');
        }
    }
    
    // è·å–çŸ¥è¯†äº§æƒæ•°æ®
    async function fetchIntellectualPropertiesData() {
        try {
            console.log('ğŸ”„ å¼€å§‹è·å–çŸ¥è¯†äº§æƒæ•°æ®...');
            const res = await fetch(getApiUrl('/api/innovation/intellectual-properties'));
            console.log('ğŸ“¡ çŸ¥è¯†äº§æƒAPIå“åº”çŠ¶æ€:', res.status);
            
            if (res.ok) {
                intellectualPropertiesData = await res.json();
                console.log('ğŸ“Š çŸ¥è¯†äº§æƒæ•°æ®:', intellectualPropertiesData);
                renderIntellectualPropertiesTable();
                initIntellectualPropertiesSortable();
                console.log('âœ… çŸ¥è¯†äº§æƒæ•°æ®è·å–æˆåŠŸ');
            } else {
                const errorText = await res.text();
                console.error('âŒ è·å–çŸ¥è¯†äº§æƒæ•°æ®å¤±è´¥:', errorText);
                showMessage('è·å–çŸ¥è¯†äº§æƒæ•°æ®å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error('âŒ çŸ¥è¯†äº§æƒæ•°æ®è·å–å¼‚å¸¸:', e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œè·å–æ•°æ®å¤±è´¥', 'error');
        }
    }
    
    // è·å–æ ¡ä¼åˆä½œæ•°æ®
    async function fetchEnterpriseCooperationsData() {
        try {
            console.log('ğŸ”„ å¼€å§‹è·å–æ ¡ä¼åˆä½œæ•°æ®...');
            const res = await fetch(getApiUrl('/api/innovation/enterprise-cooperations'));
            console.log('ğŸ“¡ æ ¡ä¼åˆä½œAPIå“åº”çŠ¶æ€:', res.status);
            
            if (res.ok) {
                enterpriseCooperationsData = await res.json();
                console.log('ğŸ“Š æ ¡ä¼åˆä½œæ•°æ®:', enterpriseCooperationsData);
                renderEnterpriseCooperationsTable();
                initEnterpriseCooperationsSortable();
                console.log('âœ… æ ¡ä¼åˆä½œæ•°æ®è·å–æˆåŠŸ');
            } else {
                const errorText = await res.text();
                console.error('âŒ è·å–æ ¡ä¼åˆä½œæ•°æ®å¤±è´¥:', errorText);
                showMessage('è·å–æ ¡ä¼åˆä½œæ•°æ®å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error('âŒ æ ¡ä¼åˆä½œæ•°æ®è·å–å¼‚å¸¸:', e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œè·å–æ•°æ®å¤±è´¥', 'error');
        }
    }
    
    // æ¸²æŸ“è®­ç»ƒè®¡åˆ’è¡¨æ ¼
    function renderTrainingProjectsTable() {
        console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“è®­ç»ƒè®¡åˆ’è¡¨æ ¼...');
        const tbody = document.getElementById('trainingProjectsTbody');
        if (!tbody) {
            console.error('âŒ æ‰¾ä¸åˆ°è®­ç»ƒè®¡åˆ’è¡¨æ ¼ä½“å…ƒç´ ');
            return;
        }
        
        const searchInput = document.getElementById('trainingProjectsSearchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const categoryValue = categoryFilter ? categoryFilter.value : '';
        
        console.log('ğŸ” è®­ç»ƒè®¡åˆ’æœç´¢æ¡ä»¶:', { searchTerm, categoryValue });
        console.log('ğŸ“Š åŸå§‹æ•°æ®æ¡æ•°:', trainingProjectsData.length);
        
        const filteredData = trainingProjectsData.filter(item => {
            const titleMatch = !searchTerm || (item.title && item.title.toLowerCase().includes(searchTerm));
            const descMatch = !searchTerm || (item.description && item.description.toLowerCase().includes(searchTerm));
            const categoryMatch = !categoryValue || item.category === categoryValue;
            
            return (titleMatch || descMatch) && categoryMatch;
        });
        
        console.log('ğŸ“‹ è¿‡æ»¤åçš„è®­ç»ƒè®¡åˆ’æ•°æ®:', filteredData);
        
        tbody.innerHTML = filteredData.map(item => `
            <tr class="sortable-item" data-id="${item.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>
                    ${item.image_display_url ? 
                        `<img src="${item.image_display_url}" alt="${item.title}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;">` : 
                        '<div style="width:40px;height:40px;background:#f0f0f0;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#999;">æ— å›¾</div>'
                    }
                </td>
                <td>${truncate(item.title, 30)}</td>
                <td>${item.category}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <div style="flex:1;height:6px;background:#f0f0f0;border-radius:3px;overflow:hidden;">
                            <div style="width:${item.progress}%;height:100%;background:linear-gradient(90deg,#667eea,#764ba2);"></div>
                        </div>
                        <span style="font-size:12px;color:#666;">${item.progress}%</span>
                    </div>
                </td>
                <td>${item.leader || '-'}</td>
                <td>${statusBadge(item.status)}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${item.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${item.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        console.log('âœ… è®­ç»ƒè®¡åˆ’è¡¨æ ¼æ¸²æŸ“å®Œæˆ');
        
        // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
        bindTrainingProjectsTableEvents();
    }
    
    // ç»‘å®šè®­ç»ƒè®¡åˆ’è¡¨æ ¼äº‹ä»¶
    function bindTrainingProjectsTableEvents() {
        const tbody = document.getElementById('trainingProjectsTbody');
        if (!tbody) return;
        
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        tbody.removeEventListener('click', handleTrainingProjectsTableClick);
        
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        tbody.addEventListener('click', handleTrainingProjectsTableClick);
        console.log('âœ… è®­ç»ƒè®¡åˆ’è¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨å·²é‡æ–°ç»‘å®š');
    }
    
    // è®­ç»ƒè®¡åˆ’è¡¨æ ¼ç‚¹å‡»å¤„ç†å‡½æ•°
    async function handleTrainingProjectsTableClick(e) {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        console.log('ğŸ“ è®­ç»ƒè®¡åˆ’è¡¨æ ¼ç‚¹å‡»:', { id, action });
        
        if (action === 'edit') {
            window.editTrainingProject(id);
        } else if (action === 'delete') {
            await window.deleteTrainingProject(id);
        }
    }
    
    // ä¿å­˜è®­ç»ƒè®¡åˆ’æ’åº
    async function saveTrainingProjectsOrder() {
        console.log('ğŸ“ ä¿å­˜è®­ç»ƒè®¡åˆ’æ’åº...');
        const tbody = document.getElementById('trainingProjectsTbody');
        const rows = tbody.querySelectorAll('tr[data-id]');
        const projectIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        console.log('ğŸ“‹ æ’åºåçš„é¡¹ç›®ID:', projectIds);
        
        try {
            const res = await fetch(getApiUrl('/api/innovation/training-projects/reorder'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_ids: projectIds })
            });
            
            if (res.ok) {
                trainingProjectsHasUnsavedChanges = false;
                const saveBtn = document.getElementById('saveTrainingProjectsOrderBtn');
                if (saveBtn) {
                    saveBtn.style.display = 'none';
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                }
                showMessage('è®­ç»ƒè®¡åˆ’æ’åºå·²ä¿å­˜', 'success');
                await fetchTrainingProjectsData();
                // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
                bindTrainingProjectsTableEvents();
                console.log('âœ… è®­ç»ƒè®¡åˆ’æ’åºä¿å­˜æˆåŠŸ');
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error('âŒ ä¿å­˜è®­ç»ƒè®¡åˆ’æ’åºå¤±è´¥:', e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }
    
    // ç¼–è¾‘è®­ç»ƒè®¡åˆ’ - ä¿®å¤ç¼–è¾‘åŠŸèƒ½
    window.editTrainingProject = function(id) {
        console.log('ğŸ“ ç¼–è¾‘è®­ç»ƒè®¡åˆ’ï¼ŒID:', id);
        const item = trainingProjectsData.find(item => item.id === id);
        if (!item) {
            console.error('âŒ æ‰¾ä¸åˆ°è®­ç»ƒè®¡åˆ’æ•°æ®ï¼ŒID:', id);
            showMessage('æ‰¾ä¸åˆ°è¦ç¼–è¾‘çš„æ•°æ®', 'error');
            return;
        }
        
        console.log('ğŸ“ è®­ç»ƒè®¡åˆ’æ•°æ®:', item);
        
        // å¡«å……è¡¨å•æ•°æ®
        document.getElementById('trainingProjectsModalTitle').textContent = 'ç¼–è¾‘å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šè®­ç»ƒè®¡åˆ’';
        document.getElementById('trainingProjectsId').value = item.id;
        document.getElementById('trainingProjectsTitleInput').value = item.title || '';
        document.getElementById('trainingProjectsDescInput').value = item.description || '';
        document.getElementById('trainingProjectsCategoryInput').value = item.category || 'äººå·¥æ™ºèƒ½';
        document.getElementById('trainingProjectsProgressInput').value = item.progress || 0;
        document.getElementById('trainingProjectsStartDateInput').value = item.start_date || '';
        document.getElementById('trainingProjectsEndDateInput').value = item.end_date || '';
        document.getElementById('trainingProjectsBudgetInput').value = item.budget || '';
        document.getElementById('trainingProjectsLeaderInput').value = item.leader || '';
        document.getElementById('trainingProjectsMembersCountInput').value = item.members_count || 0;
        document.getElementById('trainingProjectsContactEmailInput').value = item.contact_email || '';
        document.getElementById('trainingProjectsContactPhoneInput').value = item.contact_phone || '';
        document.getElementById('trainingProjectsContactWechatInput').value = item.contact_wechat || '';
        document.getElementById('trainingProjectsStatusInput').value = item.status || 'active';
        document.getElementById('trainingProjectsImageUrlInput').value = item.image_url || '';
        document.getElementById('trainingProjectsImageName').textContent = item.image_file || '';
        
        trainingProjectsUploadedImageUrl = item.image_display_url;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('trainingProjectsModal').style.display = 'flex';
        console.log('âœ… è®­ç»ƒè®¡åˆ’ç¼–è¾‘æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
    };
    
    // åˆ é™¤è®­ç»ƒè®¡åˆ’
    window.deleteTrainingProject = async function(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®­ç»ƒè®¡åˆ’å—ï¼Ÿ')) return;
        
        try {
            const res = await fetch(`/api/innovation/training-projects/${id}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                await fetchTrainingProjectsData();
                // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
                bindTrainingProjectsTableEvents();
            } else {
                const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
        }
    };
    
    // ä¸Šä¼ è®­ç»ƒè®¡åˆ’å›¾ç‰‡
    async function uploadTrainingProjectImage(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch(getApiUrl('/api/innovation/training-projects/upload'), {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                const result = await res.json();
                trainingProjectsUploadedImageUrl = result.url;
                document.getElementById('trainingProjectsImageName').textContent = result.filename;
                document.getElementById('trainingProjectsImageUrlInput').value = result.url;
                showMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
            } else {
                const err = await res.json().catch(() => ({error: 'ä¸Šä¼ å¤±è´¥'}));
                showMessage(err.error || 'ä¸Šä¼ å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥', 'error');
        }
    }
    
    // ============ çŸ¥è¯†äº§æƒç®¡ç† ============
    
    // æ¸²æŸ“çŸ¥è¯†äº§æƒè¡¨æ ¼
    function renderIntellectualPropertiesTable() {
        console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“çŸ¥è¯†äº§æƒè¡¨æ ¼...');
        const tbody = document.getElementById('intellectualPropertiesTbody');
        if (!tbody) {
            console.error('âŒ æ‰¾ä¸åˆ°çŸ¥è¯†äº§æƒè¡¨æ ¼ä½“å…ƒç´ ');
            return;
        }
        
        const searchInput = document.getElementById('intellectualPropertiesSearchInput');
        const typeFilter = document.getElementById('propertyTypeFilter');
        
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const typeValue = typeFilter ? typeFilter.value : '';
        
        console.log('ğŸ” çŸ¥è¯†äº§æƒæœç´¢æ¡ä»¶:', { searchTerm, typeValue });
        console.log('ğŸ“Š åŸå§‹æ•°æ®æ¡æ•°:', intellectualPropertiesData.length);
        
        const filteredData = intellectualPropertiesData.filter(item => {
            const titleMatch = !searchTerm || (item.title && item.title.toLowerCase().includes(searchTerm));
            const descMatch = !searchTerm || (item.description && item.description.toLowerCase().includes(searchTerm));
            const typeMatch = !typeValue || item.type === typeValue;
            
            return (titleMatch || descMatch) && typeMatch;
        });
        
        console.log('ğŸ“‹ è¿‡æ»¤åçš„çŸ¥è¯†äº§æƒæ•°æ®:', filteredData);
        
        tbody.innerHTML = filteredData.map(item => `
            <tr class="sortable-item" data-id="${item.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>
                    ${item.image_display_url ? 
                        `<img src="${item.image_display_url}" alt="${item.title}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;">` : 
                        '<div style="width:40px;height:40px;background:#f0f0f0;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#999;">æ— å›¾</div>'
                    }
                </td>
                <td>${truncate(item.title, 30)}</td>
                <td>${item.type === 'patent' ? 'ä¸“åˆ©' : item.type === 'copyright' ? 'è‘—ä½œæƒ' : 'å•†æ ‡'}</td>
                <td>${item.patent_number || '-'}</td>
                <td>${item.inventors || '-'}</td>
                <td>${statusBadge(item.status)}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${item.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${item.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
        bindIntellectualPropertiesTableEvents();
    }
    
    // ç»‘å®šçŸ¥è¯†äº§æƒè¡¨æ ¼äº‹ä»¶
    function bindIntellectualPropertiesTableEvents() {
        const tbody = document.getElementById('intellectualPropertiesTbody');
        if (!tbody) return;
        
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        tbody.removeEventListener('click', handleIntellectualPropertiesTableClick);
        
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        tbody.addEventListener('click', handleIntellectualPropertiesTableClick);
        console.log('âœ… çŸ¥è¯†äº§æƒè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨å·²é‡æ–°ç»‘å®š');
    }
    
    // çŸ¥è¯†äº§æƒè¡¨æ ¼ç‚¹å‡»å¤„ç†å‡½æ•°
    async function handleIntellectualPropertiesTableClick(e) {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        console.log('ğŸ“‹ çŸ¥è¯†äº§æƒè¡¨æ ¼ç‚¹å‡»:', { id, action });
        
        if (action === 'edit') {
            window.editIntellectualProperty(id);
        } else if (action === 'delete') {
            await window.deleteIntellectualProperty(id);
        }
    }
    
    // ä¿å­˜çŸ¥è¯†äº§æƒæ’åº
    async function saveIntellectualPropertiesOrder() {
        console.log('ğŸ“‹ ä¿å­˜çŸ¥è¯†äº§æƒæ’åº...');
        const tbody = document.getElementById('intellectualPropertiesTbody');
        const rows = tbody.querySelectorAll('tr[data-id]');
        const propertyIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        console.log('ğŸ“‹ æ’åºåçš„çŸ¥è¯†äº§æƒID:', propertyIds);
        
        try {
            const res = await fetch(getApiUrl('/api/innovation/intellectual-properties/reorder'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ property_ids: propertyIds })
            });
            
            if (res.ok) {
                intellectualPropertiesHasUnsavedChanges = false;
                const saveBtn = document.getElementById('saveIntellectualPropertiesOrderBtn');
                if (saveBtn) {
                    saveBtn.style.display = 'none';
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                }
                showMessage('çŸ¥è¯†äº§æƒæ’åºå·²ä¿å­˜', 'success');
                await fetchIntellectualPropertiesData();
                // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
                bindIntellectualPropertiesTableEvents();
                console.log('âœ… çŸ¥è¯†äº§æƒæ’åºä¿å­˜æˆåŠŸ');
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error('âŒ ä¿å­˜çŸ¥è¯†äº§æƒæ’åºå¤±è´¥:', e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }
    
    // ç¼–è¾‘çŸ¥è¯†äº§æƒ - ä¿®å¤ç¼–è¾‘åŠŸèƒ½
    window.editIntellectualProperty = function(id) {
        console.log('ğŸ“‹ ç¼–è¾‘çŸ¥è¯†äº§æƒï¼ŒID:', id);
        const item = intellectualPropertiesData.find(item => item.id === id);
        if (!item) {
            console.error('âŒ æ‰¾ä¸åˆ°çŸ¥è¯†äº§æƒæ•°æ®ï¼ŒID:', id);
            showMessage('æ‰¾ä¸åˆ°è¦ç¼–è¾‘çš„æ•°æ®', 'error');
            return;
        }
        
        console.log('ğŸ“ çŸ¥è¯†äº§æƒæ•°æ®:', item);
        
        // å¡«å……è¡¨å•æ•°æ®
        document.getElementById('intellectualPropertiesModalTitle').textContent = 'ç¼–è¾‘çŸ¥è¯†äº§æƒ';
        document.getElementById('intellectualPropertiesId').value = item.id;
        document.getElementById('intellectualPropertiesTitleInput').value = item.title || '';
        document.getElementById('intellectualPropertiesDescInput').value = item.description || '';
        document.getElementById('intellectualPropertiesTypeInput').value = item.type || 'patent';
        document.getElementById('intellectualPropertiesCategoryInput').value = item.category || '';
        document.getElementById('intellectualPropertiesApplicationDateInput').value = item.application_date || '';
        document.getElementById('intellectualPropertiesGrantDateInput').value = item.grant_date || '';
        document.getElementById('intellectualPropertiesPatentNumberInput').value = item.patent_number || '';
        document.getElementById('intellectualPropertiesInventorsInput').value = item.inventors || '';
        document.getElementById('intellectualPropertiesStatusInput').value = item.status || 'active';
        document.getElementById('intellectualPropertiesImageUrlInput').value = item.image_url || '';
        document.getElementById('intellectualPropertiesImageName').textContent = item.image_file || '';
        
        intellectualPropertiesUploadedImageUrl = item.image_display_url;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('intellectualPropertiesModal').style.display = 'flex';
        console.log('âœ… çŸ¥è¯†äº§æƒç¼–è¾‘æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
    };
    
    // åˆ é™¤çŸ¥è¯†äº§æƒ
    window.deleteIntellectualProperty = async function(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŸ¥è¯†äº§æƒå—ï¼Ÿ')) return;
        
        try {
            const res = await fetch(`/api/innovation/intellectual-properties/${id}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                await fetchIntellectualPropertiesData();
                // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
                bindIntellectualPropertiesTableEvents();
            } else {
                const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
        }
    };
    
    // ä¸Šä¼ çŸ¥è¯†äº§æƒå›¾ç‰‡
    async function uploadIntellectualPropertyImage(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch(getApiUrl('/api/innovation/intellectual-properties/upload'), {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                const result = await res.json();
                intellectualPropertiesUploadedImageUrl = result.url;
                document.getElementById('intellectualPropertiesImageName').textContent = result.filename;
                document.getElementById('intellectualPropertiesImageUrlInput').value = result.url;
                showMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
            } else {
                const err = await res.json().catch(() => ({error: 'ä¸Šä¼ å¤±è´¥'}));
                showMessage(err.error || 'ä¸Šä¼ å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥', 'error');
        }
    }
    
    // ============ æ ¡ä¼åˆä½œç®¡ç† ============
    
    // æ¸²æŸ“æ ¡ä¼åˆä½œè¡¨æ ¼
    function renderEnterpriseCooperationsTable() {
        console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“æ ¡ä¼åˆä½œè¡¨æ ¼...');
        const tbody = document.getElementById('enterpriseCooperationsTbody');
        if (!tbody) {
            console.error('âŒ æ‰¾ä¸åˆ°æ ¡ä¼åˆä½œè¡¨æ ¼ä½“å…ƒç´ ');
            return;
        }
        
        const searchInput = document.getElementById('enterpriseCooperationsSearchInput');
        const enterpriseFilter = document.getElementById('enterpriseFilter');
        
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const enterpriseValue = enterpriseFilter ? enterpriseFilter.value : '';
        
        console.log('ğŸ” æ ¡ä¼åˆä½œæœç´¢æ¡ä»¶:', { searchTerm, enterpriseValue });
        console.log('ğŸ“Š åŸå§‹æ•°æ®æ¡æ•°:', enterpriseCooperationsData.length);
        
        const filteredData = enterpriseCooperationsData.filter(item => {
            const titleMatch = !searchTerm || (item.title && item.title.toLowerCase().includes(searchTerm));
            const descMatch = !searchTerm || (item.description && item.description.toLowerCase().includes(searchTerm));
            const enterpriseMatch = !enterpriseValue || item.enterprise_name === enterpriseValue;
            
            return (titleMatch || descMatch) && enterpriseMatch;
        });
        
        console.log('ğŸ“‹ è¿‡æ»¤åçš„æ ¡ä¼åˆä½œæ•°æ®:', filteredData);
        
        tbody.innerHTML = filteredData.map(item => `
            <tr class="sortable-item" data-id="${item.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td>
                    ${item.image_display_url ? 
                        `<img src="${item.image_display_url}" alt="${item.title}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;">` : 
                        '<div style="width:40px;height:40px;background:#f0f0f0;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#999;">æ— å›¾</div>'
                    }
                </td>
                <td>${truncate(item.title, 30)}</td>
                <td>${item.enterprise_name}</td>
                <td>${item.category || '-'}</td>
                <td>${item.leader || '-'}</td>
                <td>${statusBadge(item.status)}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${item.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${item.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
        bindEnterpriseCooperationsTableEvents();
    }
    
    // ç»‘å®šæ ¡ä¼åˆä½œè¡¨æ ¼äº‹ä»¶
    function bindEnterpriseCooperationsTableEvents() {
        const tbody = document.getElementById('enterpriseCooperationsTbody');
        if (!tbody) return;
        
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        tbody.removeEventListener('click', handleEnterpriseCooperationsTableClick);
        
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        tbody.addEventListener('click', handleEnterpriseCooperationsTableClick);
        console.log('âœ… æ ¡ä¼åˆä½œè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨å·²é‡æ–°ç»‘å®š');
    }
    
    // æ ¡ä¼åˆä½œè¡¨æ ¼ç‚¹å‡»å¤„ç†å‡½æ•°
    async function handleEnterpriseCooperationsTableClick(e) {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        console.log('ğŸ¤ æ ¡ä¼åˆä½œè¡¨æ ¼ç‚¹å‡»:', { id, action });
        
        if (action === 'edit') {
            window.editEnterpriseCooperation(id);
        } else if (action === 'delete') {
            await window.deleteEnterpriseCooperation(id);
        }
    }
    
    // ä¿å­˜æ ¡ä¼åˆä½œæ’åº
    async function saveEnterpriseCooperationsOrder() {
        console.log('ğŸ¤ ä¿å­˜æ ¡ä¼åˆä½œæ’åº...');
        const tbody = document.getElementById('enterpriseCooperationsTbody');
        const rows = tbody.querySelectorAll('tr[data-id]');
        const cooperationIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        console.log('ğŸ“‹ æ’åºåçš„æ ¡ä¼åˆä½œID:', cooperationIds);
        
        try {
            const res = await fetch(getApiUrl('/api/innovation/enterprise-cooperations/reorder'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cooperation_ids: cooperationIds })
            });
            
            if (res.ok) {
                enterpriseCooperationsHasUnsavedChanges = false;
                const saveBtn = document.getElementById('saveEnterpriseCooperationsOrderBtn');
                if (saveBtn) {
                    saveBtn.style.display = 'none';
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                }
                showMessage('æ ¡ä¼åˆä½œæ’åºå·²ä¿å­˜', 'success');
                await fetchEnterpriseCooperationsData();
                // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
                bindEnterpriseCooperationsTableEvents();
                console.log('âœ… æ ¡ä¼åˆä½œæ’åºä¿å­˜æˆåŠŸ');
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error('âŒ ä¿å­˜æ ¡ä¼åˆä½œæ’åºå¤±è´¥:', e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }
    
    // ç¼–è¾‘æ ¡ä¼åˆä½œ - ä¿®å¤ç¼–è¾‘åŠŸèƒ½
    window.editEnterpriseCooperation = function(id) {
        console.log('ğŸ¤ ç¼–è¾‘æ ¡ä¼åˆä½œï¼ŒID:', id);
        const item = enterpriseCooperationsData.find(item => item.id === id);
        if (!item) {
            console.error('âŒ æ‰¾ä¸åˆ°æ ¡ä¼åˆä½œæ•°æ®ï¼ŒID:', id);
            showMessage('æ‰¾ä¸åˆ°è¦ç¼–è¾‘çš„æ•°æ®', 'error');
            return;
        }
        
        console.log('ğŸ“ æ ¡ä¼åˆä½œæ•°æ®:', item);
        
        // å¡«å……è¡¨å•æ•°æ®
        document.getElementById('enterpriseCooperationsModalTitle').textContent = 'ç¼–è¾‘æ ¡ä¼åˆä½œ';
        document.getElementById('enterpriseCooperationsId').value = item.id;
        document.getElementById('enterpriseCooperationsTitleInput').value = item.title || '';
        document.getElementById('enterpriseCooperationsDescInput').value = item.description || '';
        document.getElementById('enterpriseCooperationsEnterpriseNameInput').value = item.enterprise_name || '';
        document.getElementById('enterpriseCooperationsCategoryInput').value = item.category || '';
        document.getElementById('enterpriseCooperationsStartDateInput').value = item.start_date || '';
        document.getElementById('enterpriseCooperationsEndDateInput').value = item.end_date || '';
        document.getElementById('enterpriseCooperationsBudgetInput').value = item.budget || '';
        document.getElementById('enterpriseCooperationsLeaderInput').value = item.leader || '';
        document.getElementById('enterpriseCooperationsStatusInput').value = item.status || 'active';
        document.getElementById('enterpriseCooperationsAchievementInput').value = item.achievement || '';
        document.getElementById('enterpriseCooperationsEnterpriseLogoInput').value = item.enterprise_logo || '';
        document.getElementById('enterpriseCooperationsImageUrlInput').value = item.image_url || '';
        document.getElementById('enterpriseCooperationsImageName').textContent = item.image_file || '';
        
        enterpriseCooperationsUploadedImageUrl = item.image_display_url;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('enterpriseCooperationsModal').style.display = 'flex';
        console.log('âœ… æ ¡ä¼åˆä½œç¼–è¾‘æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
    };
    
    // åˆ é™¤æ ¡ä¼åˆä½œ
    window.deleteEnterpriseCooperation = async function(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ ¡ä¼åˆä½œå—ï¼Ÿ')) return;
        
        try {
            const res = await fetch(`/api/innovation/enterprise-cooperations/${id}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                await fetchEnterpriseCooperationsData();
                // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
                bindEnterpriseCooperationsTableEvents();
            } else {
                const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
        }
    };
    
    // ä¸Šä¼ æ ¡ä¼åˆä½œå›¾ç‰‡
    async function uploadEnterpriseCooperationImage(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch(getApiUrl('/api/innovation/enterprise-cooperations/upload'), {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                const result = await res.json();
                enterpriseCooperationsUploadedImageUrl = result.url;
                document.getElementById('enterpriseCooperationsImageName').textContent = result.filename;
                document.getElementById('enterpriseCooperationsImageUrlInput').value = result.url;
                showMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
            } else {
                const err = await res.json().catch(() => ({error: 'ä¸Šä¼ å¤±è´¥'}));
                showMessage(err.error || 'ä¸Šä¼ å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥', 'error');
        }
    }
    
    // ============ ç®€åŒ–çš„äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ– ============
    
    function initThreeModulesEvents() {
        console.log('ğŸ“„ å¼€å§‹åˆå§‹åŒ–ä¸‰ä¸ªæ¨¡å—çš„äº‹ä»¶ç›‘å¬å™¨...');
        
        // === è®­ç»ƒè®¡åˆ’æ¨¡å—äº‹ä»¶ç»‘å®š ===
        const trainingSearchInput = document.getElementById('trainingProjectsSearchInput');
        if (trainingSearchInput) {
            trainingSearchInput.addEventListener('input', renderTrainingProjectsTable);
            console.log('âœ… è®­ç»ƒè®¡åˆ’æœç´¢äº‹ä»¶å·²ç»‘å®š');
        }
        
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter) {
            categoryFilter.addEventListener('change', renderTrainingProjectsTable);
            console.log('âœ… è®­ç»ƒè®¡åˆ’ç±»åˆ«ç­›é€‰äº‹ä»¶å·²ç»‘å®š');
        }
        
        // è®­ç»ƒè®¡åˆ’æ–°å¢æŒ‰é’®
        const addTrainingProjectBtn = document.getElementById('addTrainingProjectBtn');
        if (addTrainingProjectBtn) {
            addTrainingProjectBtn.addEventListener('click', openTrainingProjectModal);
            console.log('âœ… è®­ç»ƒè®¡åˆ’æ–°å¢æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        }
        
        // è®­ç»ƒè®¡åˆ’ä¿å­˜æ’åºæŒ‰é’®
        const saveTrainingProjectsOrderBtn = document.getElementById('saveTrainingProjectsOrderBtn');
        if (saveTrainingProjectsOrderBtn) {
            saveTrainingProjectsOrderBtn.addEventListener('click', saveTrainingProjectsOrder);
            console.log('âœ… è®­ç»ƒè®¡åˆ’ä¿å­˜æ’åºæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        }
        
        // è®­ç»ƒè®¡åˆ’æ¨¡æ€æ¡†å…³é—­åŠŸèƒ½
        const trainingProjectsModalClose = document.getElementById('trainingProjectsModalClose');
        const trainingProjectsCancelBtn = document.getElementById('trainingProjectsCancelBtn');
        const trainingProjectsModal = document.getElementById('trainingProjectsModal');
        
        if (trainingProjectsModalClose) {
            trainingProjectsModalClose.addEventListener('click', closeTrainingProjectModal);
        }
        if (trainingProjectsCancelBtn) {
            trainingProjectsCancelBtn.addEventListener('click', closeTrainingProjectModal);
        }
        if (trainingProjectsModal) {
            trainingProjectsModal.addEventListener('click', (e) => {
                if (e.target === trainingProjectsModal) closeTrainingProjectModal();
            });
        }
        
        // è®­ç»ƒè®¡åˆ’å›¾ç‰‡ä¸Šä¼ 
        const trainingProjectsImageBtn = document.getElementById('trainingProjectsImageBtn');
        const trainingProjectsImageInput = document.getElementById('trainingProjectsImageInput');
        
        if (trainingProjectsImageBtn) {
            trainingProjectsImageBtn.addEventListener('click', () => {
                trainingProjectsImageInput.click();
            });
        }
        if (trainingProjectsImageInput) {
            trainingProjectsImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) uploadTrainingProjectImage(file);
            });
        }
        
        // è®­ç»ƒè®¡åˆ’è¡¨å•æäº¤
        const trainingProjectsForm = document.getElementById('trainingProjectsForm');
        if (trainingProjectsForm) {
            trainingProjectsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // é˜²é‡å¤æäº¤æ£€æŸ¥
                if (trainingProjectsSubmitting) {
                    console.log('ğŸ“ è®­ç»ƒè®¡åˆ’æ­£åœ¨æäº¤ä¸­ï¼Œå¿½ç•¥é‡å¤æäº¤');
                    return;
                }
                
                trainingProjectsSubmitting = true;
                console.log('ğŸ“ è®­ç»ƒè®¡åˆ’è¡¨å•æäº¤...');
                
                const formData = {
                    title: document.getElementById('trainingProjectsTitleInput').value,
                    description: document.getElementById('trainingProjectsDescInput').value,
                    category: document.getElementById('trainingProjectsCategoryInput').value,
                    progress: parseInt(document.getElementById('trainingProjectsProgressInput').value),
                    start_date: document.getElementById('trainingProjectsStartDateInput').value,
                    end_date: document.getElementById('trainingProjectsEndDateInput').value,
                    budget: document.getElementById('trainingProjectsBudgetInput').value,
                    leader: document.getElementById('trainingProjectsLeaderInput').value,
                    members_count: parseInt(document.getElementById('trainingProjectsMembersCountInput').value),
                    contact_email: document.getElementById('trainingProjectsContactEmailInput').value,
                    contact_phone: document.getElementById('trainingProjectsContactPhoneInput').value,
                    contact_wechat: document.getElementById('trainingProjectsContactWechatInput').value,
                    status: document.getElementById('trainingProjectsStatusInput').value,
                    image_url: trainingProjectsUploadedImageUrl || document.getElementById('trainingProjectsImageUrlInput').value
                };
                
                const id = document.getElementById('trainingProjectsId').value;
                const url = id ? `/api/innovation/training-projects/${id}` : '/api/innovation/training-projects';
                const method = id ? 'PUT' : 'POST';
                
                try {
                    const res = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    if (res.ok) {
                        showMessage(id ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ', 'success');
                        closeTrainingProjectModal();
                        await fetchTrainingProjectsData();
                        bindTrainingProjectsTableEvents();
                        localStorage.setItem('innovation_data_updated', Date.now().toString());
                        setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
                    } else {
                        const err = await res.json().catch(() => ({error: 'æ“ä½œå¤±è´¥'}));
                        showMessage(err.error || 'æ“ä½œå¤±è´¥', 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showMessage('ç½‘ç»œé”™è¯¯ï¼Œæ“ä½œå¤±è´¥', 'error');
                } finally {
                    // é‡ç½®æäº¤çŠ¶æ€
                    trainingProjectsSubmitting = false;
                }
            });
            console.log('âœ… è®­ç»ƒè®¡åˆ’è¡¨å•æäº¤äº‹ä»¶å·²ç»‘å®š');
        }
        
        // === çŸ¥è¯†äº§æƒæ¨¡å—äº‹ä»¶ç»‘å®š ===
        const intellectualSearchInput = document.getElementById('intellectualPropertiesSearchInput');
        if (intellectualSearchInput) {
            intellectualSearchInput.addEventListener('input', renderIntellectualPropertiesTable);
            console.log('âœ… çŸ¥è¯†äº§æƒæœç´¢äº‹ä»¶å·²ç»‘å®š');
        }
        
        const propertyTypeFilter = document.getElementById('propertyTypeFilter');
        if (propertyTypeFilter) {
            propertyTypeFilter.addEventListener('change', renderIntellectualPropertiesTable);
            console.log('âœ… çŸ¥è¯†äº§æƒç±»å‹ç­›é€‰äº‹ä»¶å·²ç»‘å®š');
        }
        
        // çŸ¥è¯†äº§æƒç›¸å…³æŒ‰é’®
        const addIntellectualPropertyBtn = document.getElementById('addIntellectualPropertyBtn');
        if (addIntellectualPropertyBtn) {
            addIntellectualPropertyBtn.addEventListener('click', openIntellectualPropertyModal);
            console.log('âœ… çŸ¥è¯†äº§æƒæ–°å¢æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        }
        
        // çŸ¥è¯†äº§æƒä¿å­˜æ’åºæŒ‰é’®å’Œæ¨¡æ€æ¡†
        const saveIntellectualPropertiesOrderBtn = document.getElementById('saveIntellectualPropertiesOrderBtn');
        if (saveIntellectualPropertiesOrderBtn) {
            saveIntellectualPropertiesOrderBtn.addEventListener('click', saveIntellectualPropertiesOrder);
        }
        
        // çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†å…³é—­
        const intellectualModalClose = document.getElementById('intellectualPropertiesModalClose');
        const intellectualCancelBtn = document.getElementById('intellectualPropertiesCancelBtn');
        const intellectualModal = document.getElementById('intellectualPropertiesModal');
        
        if (intellectualModalClose) intellectualModalClose.addEventListener('click', closeIntellectualPropertyModal);
        if (intellectualCancelBtn) intellectualCancelBtn.addEventListener('click', closeIntellectualPropertyModal);
        if (intellectualModal) intellectualModal.addEventListener('click', (e) => {
            if (e.target === intellectualModal) closeIntellectualPropertyModal();
        });
        
        // çŸ¥è¯†äº§æƒè¡¨å•æäº¤ï¼ˆå·²åœ¨åç»­ä»£ç ä¸­å¤„ç†ï¼‰
        
        // === æ ¡ä¼åˆä½œæ¨¡å—äº‹ä»¶ç»‘å®š ===
        const enterpriseSearchInput = document.getElementById('enterpriseCooperationsSearchInput');
        if (enterpriseSearchInput) {
            enterpriseSearchInput.addEventListener('input', renderEnterpriseCooperationsTable);
        }
        
        const enterpriseFilter = document.getElementById('enterpriseFilter');
        if (enterpriseFilter) {
            enterpriseFilter.addEventListener('change', renderEnterpriseCooperationsTable);
        }
        
        // æ ¡ä¼åˆä½œç›¸å…³æŒ‰é’®
        const addEnterpriseBtn = document.getElementById('addEnterpriseCooperationBtn');
        if (addEnterpriseBtn) {
            addEnterpriseBtn.addEventListener('click', openEnterpriseCooperationModal);
        }
        
        const saveEnterpriseOrderBtn = document.getElementById('saveEnterpriseCooperationsOrderBtn');
        if (saveEnterpriseOrderBtn) {
            saveEnterpriseOrderBtn.addEventListener('click', saveEnterpriseCooperationsOrder);
        }
        
        // æ ¡ä¼åˆä½œæ¨¡æ€æ¡†å…³é—­
        const enterpriseModalClose = document.getElementById('enterpriseCooperationsModalClose');
        const enterpriseCancelBtn = document.getElementById('enterpriseCooperationsCancelBtn');
        const enterpriseModal = document.getElementById('enterpriseCooperationsModal');
        
        if (enterpriseModalClose) enterpriseModalClose.addEventListener('click', closeEnterpriseCooperationModal);
        if (enterpriseCancelBtn) enterpriseCancelBtn.addEventListener('click', closeEnterpriseCooperationModal);
        if (enterpriseModal) enterpriseModal.addEventListener('click', (e) => {
            if (e.target === enterpriseModal) closeEnterpriseCooperationModal();
        });
        
        // æ ¡ä¼åˆä½œè¡¨å•æäº¤ï¼ˆå·²åœ¨åç»­ä»£ç ä¸­å¤„ç†ï¼‰
        
        console.log('âœ… ä¸‰ä¸ªæ¨¡å—çš„äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');
    }
        
        const intellectualPropertiesModalClose = document.getElementById('intellectualPropertiesModalClose');
        if (intellectualPropertiesModalClose) {
            intellectualPropertiesModalClose.addEventListener('click', () => {
                console.log('ğŸ“‹ ç‚¹å‡»çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†å…³é—­æŒ‰é’®');
                document.getElementById('intellectualPropertiesModal').style.display = 'none';
            });
            console.log('âœ… çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†å…³é—­æŒ‰é’®');
        }
        
        const intellectualPropertiesCancelBtn = document.getElementById('intellectualPropertiesCancelBtn');
        if (intellectualPropertiesCancelBtn) {
            intellectualPropertiesCancelBtn.addEventListener('click', () => {
                console.log('ğŸ“‹ ç‚¹å‡»çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†å–æ¶ˆæŒ‰é’®');
                document.getElementById('intellectualPropertiesModal').style.display = 'none';
            });
            console.log('âœ… çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†å–æ¶ˆæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†å–æ¶ˆæŒ‰é’®');
        }
        
        // æ·»åŠ çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
        const intellectualPropertiesModal = document.getElementById('intellectualPropertiesModal');
        if (intellectualPropertiesModal) {
            intellectualPropertiesModal.addEventListener('click', (e) => {
                if (e.target === intellectualPropertiesModal) {
                    console.log('ğŸ“‹ ç‚¹å‡»çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†èƒŒæ™¯å…³é—­');
                    intellectualPropertiesModal.style.display = 'none';
                }
            });
            console.log('âœ… çŸ¥è¯†äº§æƒæ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        }
        
        const intellectualPropertiesImageBtn = document.getElementById('intellectualPropertiesImageBtn');
        if (intellectualPropertiesImageBtn) {
            intellectualPropertiesImageBtn.addEventListener('click', () => {
                document.getElementById('intellectualPropertiesImageInput').click();
            });
        }
        
        const intellectualPropertiesImageInput = document.getElementById('intellectualPropertiesImageInput');
        if (intellectualPropertiesImageInput) {
            intellectualPropertiesImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadIntellectualPropertyImage(file);
                }
            });
        }
        
        const intellectualPropertiesForm = document.getElementById('intellectualPropertiesForm');
        if (intellectualPropertiesForm) {
            intellectualPropertiesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // é˜²é‡å¤æäº¤æ£€æŸ¥
                if (intellectualPropertiesSubmitting) {
                    console.log('ğŸ“‹ çŸ¥è¯†äº§æƒæ­£åœ¨æäº¤ä¸­ï¼Œå¿½ç•¥é‡å¤æäº¤');
                    return;
                }
                
                intellectualPropertiesSubmitting = true;
                console.log('ğŸ“‹ çŸ¥è¯†äº§æƒè¡¨å•æäº¤...');
                
                const formData = {
                    title: document.getElementById('intellectualPropertiesTitleInput').value,
                    description: document.getElementById('intellectualPropertiesDescInput').value,
                    type: document.getElementById('intellectualPropertiesTypeInput').value,
                    category: document.getElementById('intellectualPropertiesCategoryInput').value,
                    application_date: document.getElementById('intellectualPropertiesApplicationDateInput').value,
                    grant_date: document.getElementById('intellectualPropertiesGrantDateInput').value,
                    patent_number: document.getElementById('intellectualPropertiesPatentNumberInput').value,
                    inventors: document.getElementById('intellectualPropertiesInventorsInput').value,
                    status: document.getElementById('intellectualPropertiesStatusInput').value,
                    image_url: intellectualPropertiesUploadedImageUrl || document.getElementById('intellectualPropertiesImageUrlInput').value
                };
                
                console.log('ğŸ“ çŸ¥è¯†äº§æƒè¡¨å•æ•°æ®:', formData);
                
                const id = document.getElementById('intellectualPropertiesId').value;
                const url = id ? `/api/innovation/intellectual-properties/${id}` : '/api/innovation/intellectual-properties';
                const method = id ? 'PUT' : 'POST';
                
                try {
                    const res = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    if (res.ok) {
                        showMessage(id ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ', 'success');
                        document.getElementById('intellectualPropertiesModal').style.display = 'none';
                        
                        // ç«‹å³åˆ·æ–°æ•°æ®
                        await fetchIntellectualPropertiesData();
                        console.log('âœ… çŸ¥è¯†äº§æƒæ•°æ®å·²åˆ·æ–°');
                        
                        // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µ
                        localStorage.setItem('innovation_data_updated', Date.now().toString());
                        setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
                    } else {
                        const err = await res.json().catch(() => ({error: 'æ“ä½œå¤±è´¥'}));
                        showMessage(err.error || 'æ“ä½œå¤±è´¥', 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showMessage('ç½‘ç»œé”™è¯¯ï¼Œæ“ä½œå¤±è´¥', 'error');
                } finally {
                    // é‡ç½®æäº¤çŠ¶æ€
                    intellectualPropertiesSubmitting = false;
                }
            });
        }
        
        // æ ¡ä¼åˆä½œäº‹ä»¶ç›‘å¬å™¨ - æœç´¢å’Œç­›é€‰
        const enterpriseSearchInput = document.getElementById('enterpriseCooperationsSearchInput');
        if (enterpriseSearchInput) {
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨å¹¶é‡æ–°ç»‘å®š
            const newEnterpriseSearchInput = enterpriseSearchInput.cloneNode(true);
            enterpriseSearchInput.parentNode.replaceChild(newEnterpriseSearchInput, enterpriseSearchInput);
            const freshEnterpriseSearchInput = document.getElementById('enterpriseCooperationsSearchInput');
            
            freshEnterpriseSearchInput.addEventListener('input', () => {
                console.log('ğŸ” æ ¡ä¼åˆä½œæœç´¢è¾“å…¥:', freshEnterpriseSearchInput.value);
                renderEnterpriseCooperationsTable();
            });
            console.log('âœ… æ ¡ä¼åˆä½œæœç´¢è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°æ ¡ä¼åˆä½œæœç´¢è¾“å…¥æ¡†');
        }
        
        const enterpriseFilter = document.getElementById('enterpriseFilter');
        if (enterpriseFilter) {
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨å¹¶é‡æ–°ç»‘å®š
            const newEnterpriseFilter = enterpriseFilter.cloneNode(true);
            enterpriseFilter.parentNode.replaceChild(newEnterpriseFilter, enterpriseFilter);
            const freshEnterpriseFilter = document.getElementById('enterpriseFilter');
            
            freshEnterpriseFilter.addEventListener('change', () => {
                console.log('ğŸ” æ ¡ä¼åˆä½œä¼ä¸šç­›é€‰:', freshEnterpriseFilter.value);
                renderEnterpriseCooperationsTable();
            });
            console.log('âœ… ä¼ä¸šç­›é€‰å™¨äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°ä¼ä¸šç­›é€‰å™¨');
        }
        
        const addEnterpriseCooperationBtn = document.getElementById('addEnterpriseCooperationBtn');
        if (addEnterpriseCooperationBtn) {
            addEnterpriseCooperationBtn.addEventListener('click', () => {
                console.log('ğŸ¤ ç‚¹å‡»æ–°å¢æ ¡ä¼åˆä½œæŒ‰é’®');
                // é‡ç½®è¡¨å•
                document.getElementById('enterpriseCooperationsForm').reset();
                document.getElementById('enterpriseCooperationsId').value = '';
                document.getElementById('enterpriseCooperationsImageName').textContent = '';
                enterpriseCooperationsUploadedImageUrl = null;
                
                // è®¾ç½®é»˜è®¤å€¼
                document.getElementById('enterpriseCooperationsStatusInput').value = 'active';
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('enterpriseCooperationsModalTitle').textContent = 'æ–°å¢æ ¡ä¼åˆä½œ';
                document.getElementById('enterpriseCooperationsModal').style.display = 'flex';
                console.log('âœ… æ ¡ä¼åˆä½œæ–°å¢æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
            });
            console.log('âœ… æ ¡ä¼åˆä½œæ–°å¢æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°æ ¡ä¼åˆä½œæ–°å¢æŒ‰é’®');
        }
        
        const saveEnterpriseCooperationsOrderBtn = document.getElementById('saveEnterpriseCooperationsOrderBtn');
        if (saveEnterpriseCooperationsOrderBtn) {
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨å¹¶é‡æ–°ç»‘å®š
            const newSaveEnterpriseCooperationsOrderBtn = saveEnterpriseCooperationsOrderBtn.cloneNode(true);
            saveEnterpriseCooperationsOrderBtn.parentNode.replaceChild(newSaveEnterpriseCooperationsOrderBtn, saveEnterpriseCooperationsOrderBtn);
            const freshSaveEnterpriseCooperationsOrderBtn = document.getElementById('saveEnterpriseCooperationsOrderBtn');
            
            freshSaveEnterpriseCooperationsOrderBtn.addEventListener('click', saveEnterpriseCooperationsOrder);
            console.log('âœ… æ ¡ä¼åˆä½œä¿å­˜æ’åºæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°æ ¡ä¼åˆä½œä¿å­˜æ’åºæŒ‰é’®');
        }
        
        const enterpriseCooperationsModalClose = document.getElementById('enterpriseCooperationsModalClose');
        if (enterpriseCooperationsModalClose) {
            enterpriseCooperationsModalClose.addEventListener('click', () => {
                console.log('ğŸ¤ ç‚¹å‡»æ ¡ä¼åˆä½œæ¨¡æ€æ¡†å…³é—­æŒ‰é’®');
                document.getElementById('enterpriseCooperationsModal').style.display = 'none';
            });
            console.log('âœ… æ ¡ä¼åˆä½œæ¨¡æ€æ¡†å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°æ ¡ä¼åˆä½œæ¨¡æ€æ¡†å…³é—­æŒ‰é’®');
        }
        
        const enterpriseCooperationsCancelBtn = document.getElementById('enterpriseCooperationsCancelBtn');
        if (enterpriseCooperationsCancelBtn) {
            enterpriseCooperationsCancelBtn.addEventListener('click', () => {
                console.log('ğŸ¤ ç‚¹å‡»æ ¡ä¼åˆä½œæ¨¡æ€æ¡†å–æ¶ˆæŒ‰é’®');
                document.getElementById('enterpriseCooperationsModal').style.display = 'none';
            });
            console.log('âœ… æ ¡ä¼åˆä½œæ¨¡æ€æ¡†å–æ¶ˆæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°æ ¡ä¼åˆä½œæ¨¡æ€æ¡†å–æ¶ˆæŒ‰é’®');
        }
        
        // æ·»åŠ æ ¡ä¼åˆä½œæ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
        const enterpriseCooperationsModal = document.getElementById('enterpriseCooperationsModal');
        if (enterpriseCooperationsModal) {
            enterpriseCooperationsModal.addEventListener('click', (e) => {
                if (e.target === enterpriseCooperationsModal) {
                    console.log('ğŸ¤ ç‚¹å‡»æ ¡ä¼åˆä½œæ¨¡æ€æ¡†èƒŒæ™¯å…³é—­');
                    enterpriseCooperationsModal.style.display = 'none';
                }
            });
            console.log('âœ… æ ¡ä¼åˆä½œæ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        }
        
        const enterpriseCooperationsImageBtn = document.getElementById('enterpriseCooperationsImageBtn');
        if (enterpriseCooperationsImageBtn) {
            enterpriseCooperationsImageBtn.addEventListener('click', () => {
                document.getElementById('enterpriseCooperationsImageInput').click();
            });
        }
        
        const enterpriseCooperationsImageInput = document.getElementById('enterpriseCooperationsImageInput');
        if (enterpriseCooperationsImageInput) {
            enterpriseCooperationsImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadEnterpriseCooperationImage(file);
                }
            });
        }
        
        const enterpriseCooperationsForm = document.getElementById('enterpriseCooperationsForm');
        if (enterpriseCooperationsForm) {
            enterpriseCooperationsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // é˜²é‡å¤æäº¤æ£€æŸ¥
                if (enterpriseCooperationsSubmitting) {
                    console.log('ğŸ¤ æ ¡ä¼åˆä½œæ­£åœ¨æäº¤ä¸­ï¼Œå¿½ç•¥é‡å¤æäº¤');
                    return;
                }
                
                enterpriseCooperationsSubmitting = true;
                console.log('ğŸ¤ æ ¡ä¼åˆä½œè¡¨å•æäº¤...');
                
                const formData = {
                    title: document.getElementById('enterpriseCooperationsTitleInput').value,
                    description: document.getElementById('enterpriseCooperationsDescInput').value,
                    enterprise_name: document.getElementById('enterpriseCooperationsEnterpriseNameInput').value,
                    category: document.getElementById('enterpriseCooperationsCategoryInput').value,
                    start_date: document.getElementById('enterpriseCooperationsStartDateInput').value,
                    end_date: document.getElementById('enterpriseCooperationsEndDateInput').value,
                    budget: document.getElementById('enterpriseCooperationsBudgetInput').value,
                    leader: document.getElementById('enterpriseCooperationsLeaderInput').value,
                    status: document.getElementById('enterpriseCooperationsStatusInput').value,
                    achievement: document.getElementById('enterpriseCooperationsAchievementInput').value,
                    enterprise_logo: document.getElementById('enterpriseCooperationsEnterpriseLogoInput').value,
                    image_url: enterpriseCooperationsUploadedImageUrl || document.getElementById('enterpriseCooperationsImageUrlInput').value
                };
                
                console.log('ğŸ“ æ ¡ä¼åˆä½œè¡¨å•æ•°æ®:', formData);
                
                const id = document.getElementById('enterpriseCooperationsId').value;
                const url = id ? `/api/innovation/enterprise-cooperations/${id}` : '/api/innovation/enterprise-cooperations';
                const method = id ? 'PUT' : 'POST';
                
                try {
                    const res = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    if (res.ok) {
                        showMessage(id ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ', 'success');
                        document.getElementById('enterpriseCooperationsModal').style.display = 'none';
                        
                        // ç«‹å³åˆ·æ–°æ•°æ®
                        await fetchEnterpriseCooperationsData();
                        console.log('âœ… æ ¡ä¼åˆä½œæ•°æ®å·²åˆ·æ–°');
                        
                        // é‡æ–°ç»‘å®šè¡¨æ ¼äº‹ä»¶ç›‘å¬å™¨
                        bindEnterpriseCooperationsTableEvents();
                        
                        // é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µ
                        localStorage.setItem('innovation_data_updated', Date.now().toString());
                        setTimeout(() => localStorage.removeItem('innovation_data_updated'), 1000);
                    } else {
                        const err = await res.json().catch(() => ({error: 'æ“ä½œå¤±è´¥'}));
                        showMessage(err.error || 'æ“ä½œå¤±è´¥', 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showMessage('ç½‘ç»œé”™è¯¯ï¼Œæ“ä½œå¤±è´¥', 'error');
                } finally {
                    // é‡ç½®æäº¤çŠ¶æ€
                    enterpriseCooperationsSubmitting = false;
                }
            });
        }
        
        // åˆå§‹åŒ–æ•°æ®
        console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æ•°æ®...');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showMessage('æ­£åœ¨åŠ è½½ç§‘åˆ›ç®¡ç†æ•°æ®...', 'info');
        
        // ä½¿ç”¨Promise.allç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½åŠ è½½å®Œæˆ
        Promise.all([
            fetchTrainingProjectsData(),
            fetchIntellectualPropertiesData(),
            fetchEnterpriseCooperationsData()
        ]).then(() => {
            console.log('âœ… æ‰€æœ‰æ¨¡å—æ•°æ®åˆå§‹åŒ–å®Œæˆ');
            showMessage('ç§‘åˆ›ç®¡ç†é¡µé¢åŠ è½½å®Œæˆ', 'success');
            
            // åˆå§‹åŒ–å®Œæˆåæ£€æŸ¥æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                checkButtonStates();
            }, 1000);
        }).catch(e => {
            console.error('âŒ æ¨¡å—æ•°æ®åˆå§‹åŒ–å¤±è´¥:', e);
            showMessage('éƒ¨åˆ†æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        });
        
        // æ£€æŸ¥æŒ‰é’®çŠ¶æ€çš„å‡½æ•°
        function checkButtonStates() {
            const buttons = [
                'saveTrainingProjectsOrderBtn',
                'saveIntellectualPropertiesOrderBtn', 
                'saveEnterpriseCooperationsOrderBtn'
            ];
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    console.log(`ğŸ” æ£€æŸ¥æŒ‰é’® ${btnId}:`, {
                        display: btn.style.display,
                        disabled: btn.disabled,
                        opacity: btn.style.opacity
                    });
                }
            });
        }
        
            // æ·»åŠ å…¨å±€åˆ·æ–°å‡½æ•°
    window.refreshAllInnovationData = async function() {
        console.log('ğŸ”„ åˆ·æ–°æ‰€æœ‰ç§‘åˆ›æ•°æ®...');
        try {
            await Promise.all([
                fetchTrainingProjectsData(),
                fetchIntellectualPropertiesData(),
                fetchEnterpriseCooperationsData()
            ]);
            console.log('âœ… æ‰€æœ‰ç§‘åˆ›æ•°æ®åˆ·æ–°å®Œæˆ');
            showMessage('æ•°æ®åˆ·æ–°å®Œæˆ', 'success');
        } catch (e) {
            console.error('âŒ åˆ·æ–°ç§‘åˆ›æ•°æ®å¤±è´¥:', e);
            showMessage('æ•°æ®åˆ·æ–°å¤±è´¥', 'error');
        }
    };
    
    // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', function(e) {
        console.error('âŒ å…¨å±€é”™è¯¯:', e.error);
        showMessage('é¡µé¢å‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
    });
    
    // æ·»åŠ æœªå¤„ç†çš„Promiseæ‹’ç»å¤„ç†
    window.addEventListener('unhandledrejection', function(e) {
        console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
        showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
    
    // æ·»åŠ é¡µé¢åŠ è½½å®Œæˆåçš„è°ƒè¯•ä¿¡æ¯
    console.log('ğŸ”§ ç§‘åˆ›ç®¡ç†é¡µé¢JavaScriptä¿®å¤å®Œæˆ');
    console.log('ğŸ“Š å·²ä¿®å¤çš„åŠŸèƒ½:');
    console.log('  - äº‹ä»¶ç›‘å¬å™¨é‡å¤ç»‘å®šé—®é¢˜');
    console.log('  - æœç´¢å’Œç­›é€‰åŠŸèƒ½');
    console.log('  - ä¿å­˜æ’åºæŒ‰é’®çŠ¶æ€ç®¡ç†');
    console.log('  - æ•°æ®åˆ·æ–°å’ŒåŒæ­¥');
    console.log('  - é”™è¯¯å¤„ç†æœºåˆ¶');
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“é¡µé¢é‡æ–°å¯è§æ—¶åˆ·æ–°æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('ğŸ“± é¡µé¢é‡æ–°å¯è§ï¼Œåˆ·æ–°æ•°æ®...');
                window.refreshAllInnovationData();
            }
        });
        
        // ç›‘å¬å­˜å‚¨å˜åŒ–äº‹ä»¶ï¼ˆå¤šæ ‡ç­¾é¡µåŒæ­¥ï¼‰
        window.addEventListener('storage', (e) => {
            if (e.key === 'innovation_data_updated') {
                console.log('ğŸ”„ æ£€æµ‹åˆ°å…¶ä»–æ ‡ç­¾é¡µæ•°æ®æ›´æ–°ï¼Œåˆ·æ–°å½“å‰é¡µé¢æ•°æ®');
                // é‡æ–°è·å–æ‰€æœ‰æ•°æ®
                Promise.all([
                    fetchTrainingProjectsData(),
                    fetchIntellectualPropertiesData(),
                    fetchEnterpriseCooperationsData()
                ]).then(() => {
                    console.log('âœ… æ•°æ®åŒæ­¥å®Œæˆ');
                }).catch(e => {
                    console.error('âŒ æ•°æ®åŒæ­¥å¤±è´¥:', e);
                });
            }
        });
        
        // æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
        window.retryFetchData = async function(fetchFunction, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    await fetchFunction();
                    return;
                } catch (e) {
                    console.error(`âŒ ç¬¬${i + 1}æ¬¡å°è¯•å¤±è´¥:`, e);
                    if (i === maxRetries - 1) {
                        showMessage('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                    }
                }
            }
        };
        
        // ä½¿ç”¨é‡è¯•æœºåˆ¶åˆå§‹åŒ–æ•°æ®
        Promise.all([
            window.retryFetchData(fetchTrainingProjectsData),
            window.retryFetchData(fetchIntellectualPropertiesData),
            window.retryFetchData(fetchEnterpriseCooperationsData)
        ]).then(() => {
            console.log('ğŸ‰ æ‰€æœ‰ç§‘åˆ›æ•°æ®åˆå§‹åŒ–å®Œæˆ');
            showMessage('ç§‘åˆ›ç®¡ç†é¡µé¢åŠ è½½å®Œæˆ', 'success');
        }).catch(e => {
            console.error('âŒ ç§‘åˆ›æ•°æ®åˆå§‹åŒ–å¤±è´¥:', e);
            showMessage('éƒ¨åˆ†æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        });
    });

// åˆå§‹åŒ–æµ‹è¯•ä¿¡æ¯
function updateTestInfo() {
    const lastUpdateEl = document.getElementById('lastUpdateTime');
    const dataStatusEl = document.getElementById('dataStatus');
    
    if (lastUpdateEl) {
        lastUpdateEl.textContent = new Date().toLocaleTimeString();
    }
    
    if (dataStatusEl) {
        dataStatusEl.textContent = 'æ­£å¸¸';
        dataStatusEl.style.color = '#22c55e';
    }
}
</script>
{% endblock %}
