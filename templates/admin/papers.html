{% extends 'admin/base.html' %}
{% block title %}ACMå®éªŒå®¤ - è®ºæ–‡ç®¡ç†{% endblock %}
{% block page_title %}è®ºæ–‡ç®¡ç†{% endblock %}

{% block extra_head %}
<script>
// API URLè¾…åŠ©å‡½æ•° - å…¼å®¹Verceléƒ¨ç½²
function getApiUrl(path) {
    // åœ¨Vercelç¯å¢ƒä¸‹ä½¿ç”¨å½“å‰åŸŸåï¼Œæœ¬åœ°å¼€å‘ä½¿ç”¨ç›¸å¯¹è·¯å¾„
    if (window.location.hostname.includes('vercel.app') || window.location.hostname.includes('vercel.com')) {
        return window.location.origin + path;
    }
    return path;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- å¼•å…¥é”™è¯¯å¤„ç†å·¥å…· -->
<script src="{{ url_for('static', filename='js/error-handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/extension-error-filter.js') }}"></script>
<style>
/* åŸºç¡€æ ·å¼ */
body {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #ffffff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.main-content {
    background: rgba(255, 255, 255, 0.05);
}

/* æ¶ˆæ¯æç¤ºç³»ç»Ÿ */
.message-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    max-width: 400px;
}

.message {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(450px);
    transition: transform 0.3s ease;
}

.message.show {
    transform: translateX(0);
}

.message.success { border-left-color: #22c55e; color: #166534; }
.message.error { border-left-color: #ef4444; color: #dc2626; }
.message.info { border-left-color: #3b82f6; color: #1d4ed8; }

.message-icon {
    font-size: 18px;
    font-weight: bold;
}

/* å¡ç‰‡ç¾åŒ– */
.card {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

/* è¡¨æ ¼ç¾åŒ– */
.data-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.data-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px;
    font-weight: 600;
    text-align: left;
    border: none;
}

.data-table td {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: background-color 0.3s ease;
}

.sortable-item {
    transition: all 0.3s ease;
    cursor: move;
}

.sortable-item:hover {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
    transform: scale(1.01);
}

.sortable-chosen {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important;
    transform: rotate(2deg) scale(1.05);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.sortable-ghost {
    opacity: 0.4;
    transform: scale(0.95);
}

/* æ‹–æ‹½æ‰‹æŸ„ç¾åŒ– */
.sort-handle {
    display: inline-block;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 6px;
    cursor: grab;
    position: relative;
    transition: all 0.3s ease;
    margin-right: 8px;
}

.sort-handle:before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 12px;
    height: 12px;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="19" cy="5" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/><circle cx="19" cy="19" r="2"/></svg>') no-repeat center;
    background-size: contain;
}

.sort-handle:hover {
    transform: scale(1.1) rotate(15deg);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.sort-handle:active {
    cursor: grabbing;
    transform: scale(0.95);
}

/* æŒ‰é’®ç¾åŒ– */
.btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    text-decoration: none;
    display: inline-block;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    color: white;
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.btn-success {
    background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    color: #1f2937;
}

.btn-success:hover {
    color: #1f2937;
    box-shadow: 0 8px 25px rgba(132, 250, 176, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
}

.btn-danger:hover {
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 8px;
}

/* è¡¨å•æ§ä»¶ç¾åŒ– */
input, select, textarea {
    background: rgba(26, 26, 46, 0.85);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 12px 16px;
    color: #ffffff;
    font-size: 14px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

/* ç¡®ä¿å¼¹çª—ä¸­çš„è¡¨å•æ§ä»¶æ–‡å­—é¢œè‰²æ­£ç¡® */
.modal-content input,
.modal-content select,
.modal-content textarea {
    color: #ffffff;
    background: rgba(26, 26, 46, 0.9);
}

.modal-content input::placeholder,
.modal-content textarea::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    background: rgba(102, 126, 234, 0.2);
}

input::placeholder, textarea::placeholder {
    color: rgba(255, 255, 255, 0.8);
}

/* ç¾åŒ–ä¸‹æ‹‰é€‰é¡¹ */
select option {
    background: #1a1a2e;
    color: #ffffff;
    padding: 8px;
}

/* æ¨¡æ€æ¡†æ ·å¼å·²ç»Ÿä¸€åˆ°base.htmlä¸­ */

/* ç¡®ä¿å¼¹çª—ä¸­æ‰€æœ‰æ–‡å­—éƒ½æ¸…æ™°å¯è§ */
.modal-content label span {
    color: #ffffff !important;
    font-weight: 600;
}

.modal-content label {
    color: rgba(255, 255, 255, 0.95) !important;
}

/* ç±»åˆ«å¾½ç« ç¾åŒ– */
.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    border: 1px solid transparent;
    transition: all 0.3s ease;
    display: inline-block;
    text-align: center;
    min-width: 80px;
}

.badge-quantum { 
    background: linear-gradient(135deg, rgba(142, 45, 226, 0.2), rgba(142, 45, 226, 0.1)); 
    color: #c792ea; 
    border-color: rgba(142, 45, 226, 0.4);
    box-shadow: 0 2px 8px rgba(142, 45, 226, 0.2);
}

.badge-all { 
    background: linear-gradient(135deg, rgba(0, 240, 255, 0.2), rgba(0, 240, 255, 0.1)); 
    color: #00F0FF; 
    border-color: rgba(0, 240, 255, 0.4);
    box-shadow: 0 2px 8px rgba(0, 240, 255, 0.2);
}

/* æ–°å¢ï¼šä¸åŒçº§åˆ«ç±»åˆ«çš„æ ·å¼ */
.badge-ccf {
    background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(255, 0, 0, 0.1));
    color: #ff6b6b;
    border-color: rgba(255, 0, 0, 0.4);
    box-shadow: 0 2px 8px rgba(255, 0, 0, 0.2);
}

.badge-ccf-a {
    background: linear-gradient(135deg, rgba(255, 0, 0, 0.3), rgba(255, 0, 0, 0.2));
    color: #ff4444;
    border-color: rgba(255, 0, 0, 0.5);
    box-shadow: 0 2px 8px rgba(255, 0, 0, 0.3);
}

.badge-ccf-b {
    background: linear-gradient(135deg, rgba(255, 69, 0, 0.3), rgba(255, 69, 0, 0.2));
    color: #ff8c00;
    border-color: rgba(255, 69, 0, 0.5);
    box-shadow: 0 2px 8px rgba(255, 69, 0, 0.3);
}

.badge-ccf-c {
    background: linear-gradient(135deg, rgba(255, 140, 0, 0.3), rgba(255, 140, 0, 0.2));
    color: #ffa500;
    border-color: rgba(255, 140, 0, 0.5);
    box-shadow: 0 2px 8px rgba(255, 140, 0, 0.3);
}

.badge-cas {
    background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 165, 0, 0.1));
    color: #ffa500;
    border-color: rgba(255, 165, 0, 0.4);
    box-shadow: 0 2px 8px rgba(255, 165, 0, 0.2);
}

.badge-cas-1 {
    background: linear-gradient(135deg, rgba(255, 69, 0, 0.3), rgba(255, 69, 0, 0.2));
    color: #ff8c00;
    border-color: rgba(255, 69, 0, 0.5);
    box-shadow: 0 2px 8px rgba(255, 69, 0, 0.3);
}

.badge-cas-2 {
    background: linear-gradient(135deg, rgba(255, 140, 0, 0.3), rgba(255, 140, 0, 0.2));
    color: #ffa500;
    border-color: rgba(255, 140, 0, 0.5);
    box-shadow: 0 2px 8px rgba(255, 140, 0, 0.3);
}

.badge-cas-3 {
    background: linear-gradient(135deg, rgba(255, 165, 0, 0.3), rgba(255, 165, 0, 0.2));
    color: #ffb84d;
    border-color: rgba(255, 165, 0, 0.5);
    box-shadow: 0 2px 8px rgba(255, 165, 0, 0.3);
}

.badge-cas-4 {
    background: linear-gradient(135deg, rgba(255, 180, 0, 0.3), rgba(255, 180, 0, 0.2));
    color: #ffcc66;
    border-color: rgba(255, 180, 0, 0.5);
    box-shadow: 0 2px 8px rgba(255, 180, 0, 0.3);
}

.badge-jcr {
    background: linear-gradient(135deg, rgba(255, 255, 0, 0.2), rgba(255, 255, 0, 0.1));
    color: #ffff00;
    border-color: rgba(255, 255, 0, 0.4);
    box-shadow: 0 2px 8px rgba(255, 255, 0, 0.2);
}

.badge-jcr-1 {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.2));
    color: #ffd700;
    border-color: rgba(255, 215, 0, 0.5);
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}

.badge-jcr-2 {
    background: linear-gradient(135deg, rgba(255, 255, 0, 0.3), rgba(255, 255, 0, 0.2));
    color: #ffff00;
    border-color: rgba(255, 255, 0, 0.5);
    box-shadow: 0 2px 8px rgba(255, 255, 0, 0.3);
}

.badge-jcr-3 {
    background: linear-gradient(135deg, rgba(255, 255, 69, 0.3), rgba(255, 255, 69, 0.2));
    color: #ffff45;
    border-color: rgba(255, 255, 69, 0.5);
    box-shadow: 0 2px 8px rgba(255, 255, 69, 0.3);
}

.badge-jcr-4 {
    background: linear-gradient(135deg, rgba(255, 255, 140, 0.3), rgba(255, 255, 140, 0.2));
    color: #ffff8c;
    border-color: rgba(255, 255, 140, 0.5);
    box-shadow: 0 2px 8px rgba(255, 255, 140, 0.3);
}

/* æœç´¢å’Œç­›é€‰åŒºåŸŸç¾åŒ– */
.table-actions {
    background: rgba(255, 255, 255, 0.05);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* è¡¨æ ¼å“åº”å¼ */
.table-responsive {
    border-radius: 15px;
    overflow: hidden;
}

/* ä½œè€…ç®¡ç† */
.authors-container {
    border: 2px solid rgba(255, 255, 255, 0.12);
    border-radius: 18px;
    padding: 25px;
    margin-bottom: 25px;
    background: rgba(255, 255, 255, 0.03);
}

.author-item {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    transition: all 0.3s ease;
}

.author-item:hover {
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(0, 198, 255, 0.4);
    transform: translateY(-1px);
}

.author-item input {
    flex: 1;
    border: none;
    background: rgba(255, 255, 255, 0.05);
    color: #ffffff;
    padding: 10px 0;
}

.btn-remove-author {
    background: linear-gradient(135deg, #ff4757, #ff3742);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 700;
    transition: all 0.3s ease;
    box-shadow: 0 3px 12px rgba(255, 71, 87, 0.3);
}

.btn-remove-author:hover {
    background: linear-gradient(135deg, #ff3742, #ff2d2d);
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4);
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2, #667eea);
}

/* æ¨¡æ€æ¡†å†…å®¹æ ·å¼ */
.modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .form-section {
        margin-bottom: 15px;
        padding-bottom: 15px;
    }
}

@media (max-width: 480px) {
    .modal-content {
        min-width: 95vw;
        padding: 12px;
    }
}





/* æ–°å¢ï¼šè¡¨å•éƒ¨åˆ†æ ·å¼ */
.form-section {
    grid-column: 1 / -1; /* ç¡®ä¿è¡¨å•éƒ¨åˆ†è·¨ä¸¤åˆ— */
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.form-section:last-child {
    border-bottom: none;
    padding-bottom: 0;
}
```
</style>
{% endblock %}

{% block content %}
<!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
<div class="message-container" id="messageContainer"></div>

<!-- è®ºæ–‡ç®¡ç† -->
<div class="card">
    <h2 style="color: #ffffff; margin-bottom: 24px; font-size: 24px; font-weight: 600; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ“š è®ºæ–‡ç®¡ç†ä¸­å¿ƒ</h2>
    <div class="table-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
            <input id="searchInput" type="text" placeholder="æœç´¢æ ‡é¢˜ã€ä½œè€…ã€æœŸåˆŠ..." style="padding:10px 14px;min-width:280px;">
        </div>
        <div class="btn-group">
            <button id="addPaperBtn" class="btn btn-primary">âœ¨ æ–°å¢è®ºæ–‡</button>
            <button id="saveOrderBtn" class="btn btn-success" style="display:none;">ğŸ’¾ ä¿å­˜æ’åº</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="papersTable">
            <thead>
                <tr>
                    <th style="width:40px;">æ’åº</th>
                    <th>æ ‡é¢˜</th>
                    <th>ä½œè€…</th>
                    <th>æœŸåˆŠ/ä¼šè®®</th>
                    <th>å¹´ä»½</th>
                    <th>ç±»åˆ«</th>
                    <th>PDF</th>
                    <th>ä»£ç </th>
                    <th style="width:160px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="papersTbody">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘è®ºæ–‡ -->
<div id="paperModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:9999;">
            <div class="modal-content" style="min-width:600px;max-width:800px;width:95vw;padding:16px 16px 8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <h3 id="modalTitle" style="margin:0;font-size:18px;color:#ffffff;">æ–°å¢è®ºæ–‡</h3>
                <button id="modalClose" class="btn" style="border:none;background:rgba(255,255,255,0.1);font-size:20px;cursor:pointer;color:#ffffff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">Ã—</button>
        </div>
        

        
        <form id="paperForm" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="hidden" id="paperId">
            
            <!-- æ ‡é¢˜éƒ¨åˆ† -->
            <div class="form-section" id="titleSection">
                <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                    <span>æ ‡é¢˜ *</span>
                    <input id="titleInput" required placeholder="è¯·è¾“å…¥è®ºæ–‡æ ‡é¢˜">
                </label>
            </div>
            
            <!-- åŸºæœ¬ä¿¡æ¯éƒ¨åˆ† -->
            <div class="form-section" id="basicSection">
                <label style="display:flex;flex-direction:column;gap:6px;">
                    <span>æœŸåˆŠ/ä¼šè®®</span>
                    <input id="journalInput" placeholder="å¦‚ï¼šIEEE Transactions on Computers">
                </label>
                <label style="display:flex;flex-direction:column;gap:6px;">
                    <span>å‘è¡¨å¹´ä»½</span>
                    <input id="yearInput" type="number" min="2000" max="2030" value="2024">
                </label>
            </div>
            
            <!-- ç±»åˆ«éƒ¨åˆ† -->
            <div class="form-section" id="categorySection">
                <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                    <span>ç±»åˆ« *</span>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:8px;">
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="16" class="category-checkbox"> CCF-A
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="17" class="category-checkbox"> CCF-B
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="18" class="category-checkbox"> CCF-C
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="19" class="category-checkbox"> ä¸­ç§‘é™¢ä¸€åŒº
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="20" class="category-checkbox"> ä¸­ç§‘é™¢äºŒåŒº
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="21" class="category-checkbox"> ä¸­ç§‘é™¢ä¸‰åŒº
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="22" class="category-checkbox"> ä¸­ç§‘é™¢å››åŒº
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="23" class="category-checkbox"> JCRä¸€åŒº
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="24" class="category-checkbox"> JCRäºŒåŒº
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="25" class="category-checkbox"> JCRä¸‰åŒº
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="26" class="category-checkbox"> JCRå››åŒº
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="27" class="category-checkbox"> EIæºåˆŠ
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="28" class="category-checkbox"> EIä¼šè®®
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="29" class="category-checkbox"> å—æ ¸
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="30" class="category-checkbox"> CSCD
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="31" class="category-checkbox"> åŒ—æ ¸
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" value="32" class="category-checkbox"> æ™®åˆŠ
                        </label>
                    </div>
                </label>
            </div>
            
            <!-- ä½œè€…éƒ¨åˆ† -->
            <div class="form-section" id="authorsSection">
                <label style="display:flex;flex-direction:column;gap:6px;grid-column:1 / -1;">
                    <span>ä½œè€…åˆ—è¡¨</span>
                    <div class="authors-container" id="authorsContainer">
                        <div class="author-item">
                            <input type="text" placeholder="ä½œè€…å§“å" class="author-input">
                            <button type="button" class="btn-remove-author">åˆ é™¤</button>
                        </div>
                    </div>
                    <button type="button" id="addAuthorBtn" class="btn btn-sm">â• æ·»åŠ ä½œè€…</button>
                </label>
            </div>
            
            <!-- é“¾æ¥éƒ¨åˆ† -->
            <div class="form-section" id="linksSection">
                <label style="display:flex;flex-direction:column;gap:6px;">
                    <span>PDFé“¾æ¥</span>
                    <input id="pdfUrlInput" type="url" placeholder="https://example.com/paper.pdf">
                </label>
                <label style="display:flex;flex-direction:column;gap:6px;">
                    <span>ä»£ç ä»“åº“</span>
                    <input id="codeUrlInput" type="url" placeholder="https://github.com/user/repo">
                </label>
            </div>
            
            <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button type="button" id="cancelBtn" class="btn">âŒ å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<script>
// æ¶ˆæ¯æç¤ºç³»ç»Ÿ
function showMessage(text, type = 'info') {
    const container = document.getElementById('messageContainer');
    const message = document.createElement('div');
    message.className = `message ${type}`;
    
    const iconMap = {
        success: 'âœ“',
        error: 'âœ•',
        info: 'â“˜'
    };
    
    message.innerHTML = `
        <span class="message-icon">${iconMap[type] || 'â“˜'}</span>
        <span>${text}</span>
    `;
    
    container.appendChild(message);
    
    // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => message.classList.add('show'), 100);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        message.classList.remove('show');
        setTimeout(() => {
            if (message.parentNode) {
                message.parentNode.removeChild(message);
            }
        }, 300);
    }, 3000);
}

// ============ è®ºæ–‡ç®¡ç† ============
(function(){
    const tbody = document.getElementById('papersTbody');
    const addBtn = document.getElementById('addPaperBtn');
    const modal = document.getElementById('paperModal');
    const modalClose = document.getElementById('modalClose');
    const cancelBtn = document.getElementById('cancelBtn');
    const form = document.getElementById('paperForm');
    const modalTitle = document.getElementById('modalTitle');
    const searchInput = document.getElementById('searchInput');


    const idInput = document.getElementById('paperId');
    const titleInput = document.getElementById('titleInput');
    const journalInput = document.getElementById('journalInput');
    const yearInput = document.getElementById('yearInput');
    const pdfUrlInput = document.getElementById('pdfUrlInput');
    const codeUrlInput = document.getElementById('codeUrlInput');
    const authorsContainer = document.getElementById('authorsContainer');
    const addAuthorBtn = document.getElementById('addAuthorBtn');

    let rawData = [];
    let sortableInstance = null;
    let hasUnsavedChanges = false;

    // åˆå§‹åŒ–æ‹–æ‹½æ’åº
    function initSortable() {
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        
        sortableInstance = new Sortable(tbody, {
            handle: '.sort-handle',
            animation: 150,
            onUpdate: function (evt) {
                hasUnsavedChanges = true;
                document.getElementById('saveOrderBtn').style.display = 'inline-block';
            }
        });
    }

    // ä¿å­˜æ’åº
    async function saveOrder() {
        const rows = tbody.querySelectorAll('tr[data-id]');
        const paperIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));
        
        try {
            const res = await fetch(getApiUrl('/api/papers/reorder'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paper_ids: paperIds })
            });
            
            if (res.ok) {
                hasUnsavedChanges = false;
                document.getElementById('saveOrderBtn').style.display = 'none';
                showMessage('è®ºæ–‡æ’åºå·²ä¿å­˜', 'success');
                
                // é€šçŸ¥å…¶ä»–é¡µé¢æ›´æ–°
                try {
                    // å‘é€postMessageé€šçŸ¥
                    window.parent.postMessage({
                        type: 'PAPERS_UPDATED',
                        operation: 'papers_reordered',
                        timestamp: Date.now()
                    }, '*');
                    
                    // æ›´æ–°localStorageç”¨äºå¤šæ ‡ç­¾é¡µåŒæ­¥
                    localStorage.setItem('papers_data_updated', JSON.stringify({
                        operation: 'papers_reordered',
                        isReorder: true,
                        timestamp: Date.now()
                    }));
                } catch (notifyError) {
                    console.warn('é€šçŸ¥å…¶ä»–é¡µé¢å¤±è´¥:', notifyError);
                }
                
                await fetchData();
            } else {
                const err = await res.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                showMessage(err.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error('ä¿å­˜æ’åºå¤±è´¥:', e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'error');
        }
    }

    // ç±»åˆ«å¾½ç« æ˜¾ç¤º
    function categoryBadge(categories) {
        if (!categories || categories.length === 0) {
            return '<span class="badge badge-all">æœªåˆ†ç±»</span>';
        }
        
        // æŒ‰çº§åˆ«æ’åºï¼ˆæ•°å­—è¶Šå°çº§åˆ«è¶Šé«˜ï¼‰
        const sortedCategories = [...categories].sort((a, b) => a - b);
        
        // è·å–æœ€é«˜çº§åˆ«ç±»åˆ«æ˜¾ç¤º
        const topCategory = sortedCategories[0];
        const categoryMap = {
            16: 'CCF-A',
            17: 'CCF-B',
            18: 'CCF-C',
            19: 'ä¸­ç§‘é™¢ä¸€åŒº',
            20: 'ä¸­ç§‘é™¢äºŒåŒº',
            21: 'ä¸­ç§‘é™¢ä¸‰åŒº',
            22: 'ä¸­ç§‘é™¢å››åŒº',
            23: 'JCRä¸€åŒº',
            24: 'JCRäºŒåŒº',
            25: 'JCRä¸‰åŒº',
            26: 'JCRå››åŒº',
            27: 'EIæºåˆŠ',
            28: 'EIä¼šè®®',
            29: 'å—æ ¸',
            30: 'CSCD',
            31: 'åŒ—æ ¸',
            32: 'æ™®åˆŠ'
        };
        
        const categoryText = categoryMap[topCategory] || 'æœªçŸ¥';
        
        // æ ¹æ®çº§åˆ«é€‰æ‹©æ ·å¼
        let badgeClass = 'badge-all';
        if (topCategory === 16) {
            badgeClass = 'badge-ccf-a';
        } else if (topCategory === 17) {
            badgeClass = 'badge-ccf-b';
        } else if (topCategory === 18) {
            badgeClass = 'badge-ccf-c';
        } else if (topCategory === 19) {
            badgeClass = 'badge-cas-1';
        } else if (topCategory === 20) {
            badgeClass = 'badge-cas-2';
        } else if (topCategory === 21) {
            badgeClass = 'badge-cas-3';
        } else if (topCategory === 22) {
            badgeClass = 'badge-cas-4';
        } else if (topCategory === 23) {
            badgeClass = 'badge-jcr-1';
        } else if (topCategory === 24) {
            badgeClass = 'badge-jcr-2';
        } else if (topCategory === 25) {
            badgeClass = 'badge-jcr-3';
        } else if (topCategory === 26) {
            badgeClass = 'badge-jcr-4';
        } else if (topCategory >= 27 && topCategory <= 28) {
            badgeClass = 'badge-quantum';
        }
        
        // æ„å»ºæ‚¬åœæç¤ºï¼Œæ˜¾ç¤ºæ‰€æœ‰ç±»åˆ«
        const allCategories = sortedCategories.map(c => categoryMap[c] || 'æœªçŸ¥').join(', ');
        
        return `<span class="badge ${badgeClass}" title="åŒ…å«ç±»åˆ«: ${allCategories}">${categoryText}</span>`;
    }

    // æˆªæ–­æ–‡æœ¬
    function truncate(text, n) {
        const s = (text || '').trim();
        return s.length > n ? (s.slice(0, n) + '...') : s;
    }

    // æ‰“å¼€æ¨¡æ€æ¡†
    function openModal(editData) {
        modal.style.display = 'flex';
        
        if (editData) {
            modalTitle.textContent = 'ç¼–è¾‘è®ºæ–‡';
            idInput.value = editData.id;
            titleInput.value = editData.title || '';
            journalInput.value = editData.journal || '';
            yearInput.value = editData.year || 2024;
            pdfUrlInput.value = editData.pdf_url || '';
            codeUrlInput.value = editData.code_url || '';
            
            // è®¾ç½®ä½œè€…åˆ—è¡¨
            setAuthors(editData.authors || []);
            // è®¾ç½®ç±»åˆ«
            setCategories(editData.categories || []);
        } else {
            modalTitle.textContent = 'æ–°å¢è®ºæ–‡';
            form.reset();
            idInput.value = '';
            yearInput.value = 2024;
            setAuthors(['']);
            setCategories([]); // æ–°å¢è®ºæ–‡æ—¶ç±»åˆ«ä¸ºç©º
        }
    }

    function closeModal() { 
        modal.style.display = 'none'; 
    }

    // è®¾ç½®ä½œè€…åˆ—è¡¨
    function setAuthors(authors) {
        authorsContainer.innerHTML = '';
        authors.forEach(author => addAuthorInput(author));
        if (authors.length === 0) {
            addAuthorInput('');
        }
    }

    // æ·»åŠ ä½œè€…è¾“å…¥æ¡†
    function addAuthorInput(value = '') {
        const authorItem = document.createElement('div');
        authorItem.className = 'author-item';
        authorItem.innerHTML = `
            <input type="text" placeholder="ä½œè€…å§“å" class="author-input" value="${value}">
            <button type="button" class="btn-remove-author">åˆ é™¤</button>
        `;
        
        authorItem.querySelector('.btn-remove-author').addEventListener('click', function() {
            if (authorsContainer.children.length > 1) {
                authorItem.remove();
            } else {
                showMessage('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä½ä½œè€…', 'info');
            }
        });
        
        authorsContainer.appendChild(authorItem);
    }

    // è·å–ä½œè€…åˆ—è¡¨
    function getAuthors() {
        const inputs = authorsContainer.querySelectorAll('.author-input');
        return Array.from(inputs).map(input => input.value.trim()).filter(author => author);
    }

    // è·å–é€‰ä¸­çš„ç±»åˆ«
    function getSelectedCategories() {
        const checkboxes = document.querySelectorAll('.category-checkbox:checked');
        return Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => a - b);
    }

    // è®¾ç½®ç±»åˆ«é€‰ä¸­çŠ¶æ€
    function setCategories(categories) {
        // å…ˆæ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = false);
        
        // è®¾ç½®é€‰ä¸­çš„ç±»åˆ«
        if (categories && categories.length > 0) {
            categories.forEach(categoryId => {
                const checkbox = document.querySelector(`.category-checkbox[value="${categoryId}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
    }

    // æ¸²æŸ“è¡¨æ ¼
    function render(data) {
        tbody.innerHTML = data.map(item => `
            <tr class="sortable-item" data-id="${item.id}">
                <td><span class="sort-handle" title="æ‹–æ‹½æ’åº"></span></td>
                <td title="${(item.title||'').replace(/\"/g,'&quot;')}">${truncate(item.title, 40)}</td>
                <td title="${(item.authors||[]).join(', ')}">${truncate((item.authors||[]).join(', '), 30)}</td>
                <td title="${item.journal || ''}">${truncate(item.journal || '-', 25)}</td>
                <td>${item.year || '-'}</td>
                <td>${categoryBadge(item.categories)}</td>
                <td title="${item.pdf_url || ''}">${item.pdf_url ? 'ğŸ“„' : '-'}</td>
                <td title="${item.code_url || ''}">${item.code_url ? 'ğŸ’»' : '-'}</td>
                <td>
                    <button class="btn btn-sm" data-action="edit" data-id="${item.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${item.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        initSortable();
    }

    // è·å–æ•°æ®
    async function fetchData() {
        try {
            const res = await fetch(getApiUrl('/api/papers'));
            rawData = await res.json();
            applyFilter();
        } catch (e) {
            console.error('æ•°æ®åŠ è½½å¤±è´¥:', e);
            if (window.ErrorHandler) {
                window.ErrorHandler.handleNetworkError(e, 'åŠ è½½è®ºæ–‡æ•°æ®', showMessage);
            } else {
                showMessage('æ•°æ®åŠ è½½å¤±è´¥', 'error');
            }
        }
    }

    // åº”ç”¨ç­›é€‰
    function applyFilter() {
        const search = (searchInput.value || '').trim().toLowerCase();
        
        const filtered = rawData.filter(item => {
            const matchSearch = !search || 
                (item.title || '').toLowerCase().includes(search) ||
                (item.authors || []).some(author => author.toLowerCase().includes(search)) ||
                (item.journal || '').toLowerCase().includes(search);
            
            return matchSearch;
        });
        
        render(filtered);
    }

    // è¡¨æ ¼ç‚¹å‡»äº‹ä»¶
    tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const id = Number(btn.getAttribute('data-id'));
        const action = btn.getAttribute('data-action');
        const current = rawData.find(x => x.id === id);
        
        if (action === 'edit') {
            openModal(current);
        }
        
        if (action === 'delete') {
            if (!confirm('ç¡®è®¤åˆ é™¤è¯¥è®ºæ–‡ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const res = await fetch(`/api/papers/${id}`, { method: 'DELETE' });
                if (res.ok) { 
                    await fetchData(); 
                    showMessage('è®ºæ–‡åˆ é™¤æˆåŠŸ', 'success');
                    
                    // é€šçŸ¥å…¶ä»–é¡µé¢æ›´æ–°
                    try {
                        // å‘é€postMessageé€šçŸ¥
                        window.parent.postMessage({
                            type: 'PAPERS_UPDATED',
                            operation: 'paper_deleted',
                            timestamp: Date.now()
                        }, '*');
                        
                        // æ›´æ–°localStorageç”¨äºå¤šæ ‡ç­¾é¡µåŒæ­¥
                        localStorage.setItem('papers_data_updated', JSON.stringify({
                            operation: 'paper_deleted',
                            isReorder: false,
                            timestamp: Date.now()
                        }));
                    } catch (notifyError) {
                        console.warn('é€šçŸ¥å…¶ä»–é¡µé¢å¤±è´¥:', notifyError);
                    }
                } else {
                    const err = await res.json().catch(() => ({error: 'åˆ é™¤å¤±è´¥'}));
                    showMessage(err.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                console.error('åˆ é™¤è®ºæ–‡å¤±è´¥:', e);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }
    });



    // äº‹ä»¶ç›‘å¬
    addBtn.addEventListener('click', () => openModal());
    modalClose.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
    
    addAuthorBtn.addEventListener('click', () => {
        addAuthorInput();
        showMessage('å·²æ·»åŠ æ–°ä½œè€…è¾“å…¥æ¡†', 'info');
    });



    // è¡¨å•æäº¤
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!titleInput.value.trim()) {
            showMessage('è¯·å¡«å†™è®ºæ–‡æ ‡é¢˜', 'error');
            titleInput.focus();
            return;
        }
        
        const authors = getAuthors();
        if (authors.length === 0) {
            showMessage('è¯·è‡³å°‘æ·»åŠ ä¸€ä½ä½œè€…', 'error');
            return;
        }

        const categories = getSelectedCategories();
        if (categories.length === 0) {
            showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç±»åˆ«', 'error');
            return;
        }
        
        const payload = {
            title: titleInput.value.trim(),
            authors: authors,
            journal: journalInput.value.trim(),
            year: parseInt(yearInput.value) || 2024,
            categories: categories, // ä½¿ç”¨é€‰ä¸­çš„ç±»åˆ«
            status: 'published', // Default status for new papers
            citation_count: 0, // Default citation count
            doi: '',
            abstract: '',
            pdf_url: pdfUrlInput.value.trim(),
            code_url: codeUrlInput.value.trim(),
            video_url: '', // This line was removed
            demo_url: '' // This line was removed
        };
        
        const id = idInput.value;
        const isEdit = !!id;
        
        try {
            const res = await fetch(isEdit ? `/api/papers/${id}` : '/api/papers', {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                closeModal();
                await fetchData();
                showMessage(isEdit ? 'è®ºæ–‡æ›´æ–°æˆåŠŸ' : 'è®ºæ–‡æ·»åŠ æˆåŠŸ', 'success');
                
                // é€šçŸ¥å…¶ä»–é¡µé¢æ›´æ–°
                try {
                    const operation = isEdit ? 'paper_updated' : 'paper_created';
                    
                    // å‘é€postMessageé€šçŸ¥
                    window.parent.postMessage({
                        type: 'PAPERS_UPDATED',
                        operation: operation,
                        timestamp: Date.now()
                    }, '*');
                    
                    // æ›´æ–°localStorageç”¨äºå¤šæ ‡ç­¾é¡µåŒæ­¥
                    localStorage.setItem('papers_data_updated', JSON.stringify({
                        operation: operation,
                        isReorder: false,
                        timestamp: Date.now()
                    }));
                } catch (notifyError) {
                    console.warn('é€šçŸ¥å…¶ä»–é¡µé¢å¤±è´¥:', notifyError);
                }
            } else {
                const err = await res.json().catch(() => ({error: 'æäº¤å¤±è´¥'}));
                showMessage(err.error || 'æäº¤å¤±è´¥', 'error');
            }
        } catch (e) {
            console.error('æäº¤è®ºæ–‡å¤±è´¥:', e);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œæäº¤å¤±è´¥', 'error');
        }
    });

    // æœç´¢å’Œç­›é€‰
    searchInput.addEventListener('input', applyFilter);
    
    // ä¿å­˜æ’åº
    document.getElementById('saveOrderBtn').addEventListener('click', saveOrder);

    // åˆå§‹åŒ–
    fetchData();
    setAuthors(['']);
})();

// é¡µé¢åŠ è½½å®Œæˆæç¤º
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        showMessage('è®ºæ–‡ç®¡ç†ç³»ç»Ÿå·²å°±ç»ªï¼', 'success');
    }, 500);
});
</script>
{% endblock %} 